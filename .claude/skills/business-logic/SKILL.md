---
name: business-logic
description: 港股量化交易系统业务逻辑知识库。包含信号生成、买卖策略、订单记录、风险检查、浮亏监控、牛熊证风险、延迟验证等。用于理解交易逻辑、验证代码实现、修改功能、解答业务规则。涉及信号配置、成本价计算、智能平仓、保护性清仓、订单过滤算法时使用。
---

# 业务逻辑知识库

LongBridge 港股自动化量化交易系统的完整业务逻辑参考文档。

**核心机制**:监控恒生指数技术指标 → 在牛熊证上执行双向交易 → 开仓延迟验证(默认 60 秒)→ 平仓立即执行 → 智能平仓 + 浮亏保护 + 末日保护

**技术栈**:TypeScript + Node.js + LongPort OpenAPI + technicalindicators

---

## Quick start

**常见问题快速索引** - 直接跳转到对应章节查找答案:

| 用户问题                 | 查看章节                                           |
| ------------------------ | -------------------------------------------------- |
| "信号是如何生成的？"     | [2. 交易信号](#2-交易信号)                         |
| "买入时如何验证？"       | [3. 买入验证策略](#3-买入验证策略)                 |
| "卖出时卖多少数量？"     | [5. 卖出策略](#5-卖出策略)                         |
| "如何计算浮亏？"         | [6.2 浮亏监控](#62-浮亏监控)                       |
| "什么时候会触发清仓？"   | [6.3 保护性清仓](#63-保护性清仓避难程序)           |
| "订单如何记录和过滤？"   | [4. 订单记录策略](#4-订单记录策略)                 |
| "有哪些风险检查？"       | [6.1 风险检查顺序](#61-风险检查顺序买入前)         |
| "牛熊证风险如何计算？"   | [6.4 牛熊证风险](#64-牛熊证风险)                   |
| "成本价有几种？"         | [11.1 成本价区分](#111-成本价区分)                 |
| "信号配置格式是什么？"   | [2.2 信号配置](#22-信号配置)                       |
| "延迟验证如何工作？"     | [3.2 验证流程](#32-验证流程)                       |
| "订单监控做什么？"       | [7. 订单管理](#7-订单管理)                         |
| "支持哪些指标？"         | [2.2 信号配置](#22-信号配置)                       |
| "API 频率限制是多少？"   | [7.4 Trade API 频率限制](#74-trade-api-频率限制)   |
| "订单数据如何缓存？"     | [7.5 订单记录缓存机制](#75-订单记录缓存机制)       |
| "交易记录在哪里？"       | [8.4 交易记录](#84-交易记录)                       |
| "买入价格限制如何工作？" | [6.1 风险检查顺序](#61-风险检查顺序买入前)         |
| "末日保护清仓如何处理？" | [11.8 末日保护的特殊处理](#118-末日保护的特殊处理) |
| "禁用标的机制是什么？"   | [11.10 禁用标的机制](#1110-禁用标的机制)           |
| "代码架构是怎样的？"     | [12. 代码架构](#12-代码架构)                       |
| "内存如何优化？"         | [13. 性能优化](#13-性能优化)                       |

---

## Instructions

### 何时使用此 Skill

当遇到以下任务时,立即使用本文档:

1. **用户询问业务逻辑** - 如"信号如何生成"、"卖出策略是什么"
2. **验证代码实现** - 检查代码是否符合业务规则
3. **修改交易功能** - 在修改信号、订单、风险、平仓等代码前
4. **调试业务问题** - 排查交易行为异常、订单处理错误等
5. **了解代码结构** - 查找特定功能的实现文件位置

### 如何使用

**步骤 1:快速定位**

- 使用上方"Quick start"表格,根据用户问题直接跳转到相关章节
- 或者查看下方目录,浏览完整结构
- 使用第 12 章的文件路径快速定位代码

**步骤 2:阅读相关章节**

- 仔细阅读对应章节的完整内容
- 特别注意表格、流程说明和示例
- 查看相关章节的交叉引用
- 查看文件路径引用,定位具体实现代码

**步骤 3:引用和回答**

- 回答用户时引用具体章节(如"根据 5.1 判断逻辑...")
- 使用文档中定义的术语(见第 10 章术语表)
- 严格遵循文档中的业务规则,不要自行发挥
- 引用具体文件路径和行号(如 `src/core/risk/index.ts:123`)

### 重要注意事项

⚠️ **关键概念区分**(容易混淆,必须注意):

| 概念对                 | 区别                                            | 详见章节 |
| ---------------------- | ----------------------------------------------- | -------- |
| 平摊成本价 vs 开仓成本 | 前者判断盈利,后者计算浮亏                      | 11.1     |
| 监控标的 vs 交易标的   | 前者生成信号(恒指),后者执行交易(牛熊证)    | 术语表   |
| 做多 vs 做空           | 牛证(标的上涨盈利)vs 熊证(标的下跌盈利)     | 术语表   |
| 智能平仓 vs 全仓清仓   | 仅卖盈利部分 vs 全部卖出                        | 5.1      |
| 正常卖出 vs 保护性清仓 | 前者判断成本价,后者无条件清仓                  | 11.8     |
| 延迟信号 vs 立即信号   | 买入需验证(60 秒),卖出立即执行               | 2.3      |
| ELO vs MO              | 增强限价单(正常交易)vs 市价单(仅保护性清仓) | 11.5     |
| 牛熊证风险计算价格     | 使用监控标的价格,非牛熊证价格                  | 6.4      |

⚠️ **核心执行顺序**(不可打乱):

- **风险检查顺序**(6.1):6 项检查必须全部通过,顺序固定
- **订单过滤算法**(4.2):必须"从旧到新累积过滤",不可随机或倒序
- **数据获取时机**(11.7):买入前必须实时获取账户/持仓,卖出可用缓存

⚠️ **特殊处理规则**:

- 保护性清仓后必须强制刷新订单记录(6.3)
- 末日保护清仓无条件执行,不受成本价判断影响(11.8)
- 订单获取失败时标的会被禁用交易(11.10)

### 修改代码时的检查清单

在修改交易相关代码时,必须验证:

- [ ] 是否遵循了相关章节的业务规则
- [ ] 是否保持了正确的执行顺序(如风险检查顺序)
- [ ] 是否正确区分了易混淆的概念(如成本价类型)
- [ ] 是否处理了特殊情况(如保护性清仓、末日保护)
- [ ] 是否符合数据获取时机要求(买入实时,卖出可缓存)
- [ ] 是否使用了 `normalizeHKSymbol()` 规范化标的代码
- [ ] 是否使用了 `decimalToNumber()` 转换 Decimal 对象
- [ ] 是否遵循了 API 频率限制要求

---

## 目录

- [1. 监控和显示](#1-监控和显示)
- [2. 交易信号](#2-交易信号)
- [3. 买入验证策略](#3-买入验证策略)
- [4. 订单记录策略](#4-订单记录策略)
- [5. 卖出策略](#5-卖出策略)
- [6. 风险管控](#6-风险管控)
- [7. 订单管理](#7-订单管理)
- [8. 关键数据流](#8-关键数据流)
- [9. 配置要求](#9-配置要求)
- [10. 术语表](#10-术语表)
- [11. 关键注意事项](#11-关键注意事项)
- [12. 代码架构](#12-代码架构)
- [13. 性能优化](#13-性能优化)

---

## 1. 监控和显示

**实现文件**: `src/core/marketMonitor/index.ts`

### 1.1 监控标的

系统实时监控目标资产(通常是恒生指数)的以下信息,仅在数据变化时更新:

| 数据类型 | 说明                                                          |
| -------- | ------------------------------------------------------------- |
| 价格信息 | 最新价、涨跌额、涨跌幅                                        |
| 技术指标 | EMA、RSI(支持动态周期)、MFI、KDJ(K/D/J)、MACD(DIF/DEA/MACD) |

**变化检测**:仅当变化超过阈值时才触发显示更新,价格阈值 0.0001,指标阈值 RSI/MFI/KDJ 为 0.1,MACD/EMA 为 0.0001。

**对象池优化**:MarketMonitor 使用对象池(`utils/objectPool.ts` 中的 `monitorValuesObjectPool`)复用监控值对象,减少 GC 压力。

### 1.2 交易标的

做多标的和做空标的的价格信息(最新价、涨跌额、涨跌幅),同样仅在变化时显示。

### 1.3 交易后显示

**实现文件**: `src/utils/accountDisplay.ts`

当发生买入或卖出操作后,自动显示账户信息(余额、净资产)和持仓信息(数量、成本价、可用数量)。

---

## 2. 交易信号

**实现文件**: `src/core/strategy/index.ts`

### 2.1 信号类型

系统产生四类信号:

| 信号类型     | 动作         | 执行方式       |
| ------------ | ------------ | -------------- |
| **BUYCALL**  | 买入做多标的 | 延迟验证后执行 |
| **SELLCALL** | 卖出做多标的 | 立即执行       |
| **BUYPUT**   | 买入做空标的 | 延迟验证后执行 |
| **SELLPUT**  | 卖出做空标的 | 立即执行       |

### 2.2 信号配置

**解析器实现**: `src/utils/signalConfigParser.ts`

所有信号条件**完全可配置**,通过环境变量设置:

**配置格式**: `(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`

- 括号内条件列表,逗号分隔
- `/N`:括号内条件需满足 N 项,不设则全部满足
- `|`:分隔不同条件组,满足任一组即可
- **支持指标**:
  - `RSI:n`(任意周期 1-100)
  - `MFI`(资金流量指标)
  - `K`、`D`、`J`(KDJ 指标)
  - `MACD`、`DIF`、`DEA`(MACD 指标)
  - `EMA:n`(指数移动平均,周期范围 1-250)
- **支持运算符**: `<`、`>`,支持负数阈值如 `J<-20`

**动态指标**:

- 系统自动从配置中提取 RSI 周期并计算相应值,如配置 `RSI:6` 和 `RSI:12` 会同时计算 RSI6 和 RSI12
- 同样支持多个 EMA 周期,如 `EMA:5`、`EMA:10`

**配置示例**:
```
SIGNAL_BUYCALL=(RSI:6<20,MFI<15,D<20,J<-1)/3|(J<-20)
```
含义:满足以下任一条件组即触发 BUYCALL 信号:
1. RSI:6<20、MFI<15、D<20、J<-1 这4个条件中至少满足3个
2. J<-20

### 2.3 信号执行规则

| 信号类型 | 是否延迟         | 验证条件                                           |
| -------- | ---------------- | -------------------------------------------------- |
| BUYCALL  | 是(默认 60 秒) | 验证指标的3个时间点值都必须大于初始值(上涨趋势)  |
| SELLCALL | 否               | -                                                  |
| BUYPUT   | 是(默认 60 秒) | 验证指标的3个时间点值都必须小于初始值(下跌趋势)  |
| SELLPUT  | 否               | -                                                  |

---

## 3. 买入验证策略

**实现文件**: `src/core/signalVerification/index.ts`

买入信号(BUYCALL、BUYPUT)需要经过延迟验证确认趋势后才执行。

### 3.1 验证机制

**延迟时间**:默认 60 秒,可通过 `VERIFICATION_DELAY_SECONDS` 配置(范围 0-120 秒)。

**验证指标**:默认使用 D 和 DIF,可通过 `VERIFICATION_INDICATORS` 配置(可选:K、D、J、MACD、DIF、DEA、EMA:n)。

**注意**: EMA 需要指定周期,如 `EMA:5`、`EMA:10`,周期范围 1-250。

### 3.2 验证流程

**核心方法**: `SignalVerification._verifySingleSignal()`

**时间点定义**:
- T0 = triggerTime(信号触发时间)
- T1 = triggerTime + 5 秒
- T2 = triggerTime + 10 秒

**验证窗口**:
- 触发时间前 5 秒到后 15 秒内记录指标值
- 每个时间点允许 ±5 秒误差(寻找最接近的记录值)
- 等待 triggerTime + 15 秒后才执行验证(确保所有数据已记录)

**做多标的验证(BUYCALL)**:

1. 触发时记录验证指标的初始值(indicators1)
2. 每秒记录指标值到 verificationHistory(使用对象池优化)
3. 在验证窗口内为 T0、T1、T2 各寻找最佳匹配值(indicators2a, indicators2b, indicators2c)
4. **验证通过条件**:所有验证指标在 3 个时间点的值都必须 > 初始值
   - 如配置 D,DIF:D2a>D1 且 D2b>D1 且 D2c>D1 且 DIF2a>DIF1 且 DIF2b>DIF1 且 DIF2c>DIF1

**做空标的验证(BUYPUT)**:

- **验证通过条件**:所有验证指标在 3 个时间点的值都必须 < 初始值
  - 如配置 D,DIF:D2a<D1 且 D2b<D1 且 D2c<D1 且 DIF2a<DIF1 且 DIF2b<DIF1 且 DIF2c<DIF1

**验证失败处理**:

- 如果任一指标在任一时间点未满足条件,验证失败
- 失败的信号被丢弃,不执行买入

**对象池优化**:验证历史条目使用 `verificationEntryPool` 对象池复用,减少内存分配。

---

## 4. 订单记录策略

**实现文件**: `src/core/orderRecorder/index.ts`

订单记录用于智能平仓和浮亏监控,核心是准确识别未平仓的买入订单。

### 4.1 记录时机

- **程序启动时**:同时调用 historyOrders 和 todayOrders API,合并去重后获取所有成交订单
- **交易后本地更新**:买入/卖出成交后本地追加记录,不调用 API
- **保护性清仓后**:强制从 API 刷新订单记录(forceRefresh=true)

### 4.2 过滤算法(从旧到新累积过滤)

**核心方法**: `OrderRecorder.refreshOrders()`

用于从所有历史订单中筛选出**当前仍需记录的买入订单**:

1. **M0**:最新卖出时间之后的买入订单(尚未经历卖出)
2. **从旧到新处理卖出订单**(D1 最旧 → DN 最新):
   - 对每个卖出订单 Di,获取成交时间 < Di 的买入订单
   - 如果卖出数量 ≥ 买入总数量:该部分买入订单已全部卖出,不记录
   - 如果卖出数量 < 买入总数量:仅保留成交价 ≥ 卖出价的买入订单(盈利部分)
3. **最终记录** = M0 + 过滤后的买入订单

### 4.3 业务含义

- **M0**:最新买入的订单,还未经历任何卖出
- **过滤后的订单**:历史高价买入且未被完全卖出的订单(价格高于对应卖出价)

### 4.4 本地订单记录

**核心方法**:
- `OrderRecorder.recordLocalBuy()` - 买入后本地新增订单
- `OrderRecorder.recordLocalSell()` - 卖出后本地更新订单(按价格过滤)
- `OrderRecorder.clearBuyOrders()` - 保护性清仓时清空所有订单

---

## 5. 卖出策略

**实现文件**: `src/core/signalProcessor/index.ts`

卖出策略分为**全仓清仓**和**智能平仓**两种模式。

### 5.1 判断逻辑

**核心方法**: `SignalProcessor.calculateSellQuantity()`

| 条件                          | 执行操作                                        |
| ----------------------------- | ----------------------------------------------- |
| 当前价格 > 成本价(盈利状态) | 全仓清仓                                        |
| 当前价格 ≤ 成本价(未盈利)   | 智能平仓:仅卖出 buyPrice < currentPrice 的订单 |
| 无符合条件的订单              | 持有(HOLD),不执行卖出                        |

**特殊情况**:

- **末日保护清仓**:收盘前 5 分钟的保护性清仓信号无条件执行,不受成本价判断影响,直接清空全部可用持仓
- **浮亏保护清仓**:浮亏超限触发的保护性清仓也无条件执行

### 5.2 做多与做空的差异

- **做多标的**:价格高于成本价 = 盈利,清仓全部持仓
- **做空标的**:价格高于成本价 = 亏损(做空标的随监控标的反方向波动),此时也应清仓

### 5.3 成本价类型

| 类型            | 计算方式                             | 用途         |
| --------------- | ------------------------------------ | ------------ |
| **平摊成本价**  | (买入成交额 - 卖出成交额) / 持仓数量 | 判断是否盈利 |
| **开仓成本 R1** | Σ(未平仓买入订单 price × quantity)   | 浮亏监控     |

---

## 6. 风险管控

**实现文件**: `src/core/risk/index.ts`

### 6.1 风险检查顺序(买入前)

**核心方法**: `RiskChecker.checkBuyRisks()`

1. **交易时段检查**:是否在港股交易时间(主循环中检查)
2. **交易频率检查**:同方向买入间隔是否过短(默认 60 秒)
3. **买入价格限制**:防止追高
   - 获取最新买入订单的成交价(latestBuyPrice)
   - 如果 currentPrice > latestBuyPrice,拒绝买入
   - 如果 currentPrice ≤ latestBuyPrice,允许买入
   - 确保不会在价格上涨时继续买入
4. **末日保护检查**:收盘前 15 分钟拒绝买入
5. **牛熊证风险检查**:距回收价是否安全
6. **基础风险检查**:浮亏是否超限、持仓市值是否超限

**卖出操作不受上述检查限制**。

### 6.2 浮亏监控

**计算方式**:浮亏 = 当前持仓市值(R2) - 开仓成本(R1)

**R1**:所有未平仓买入订单的市值总和(price × quantity)
**R2**:当前价格 × 持仓数量(N1)

**更新时机**:

- 程序启动时计算(从 orderRecorder 获取订单数据)
- 买入/卖出交易后重新计算
- 价格变化时实时计算浮亏

**核心方法**: `RiskChecker.checkUnrealizedLoss()`

### 6.3 保护性清仓(避难程序)

**实现文件**: `src/core/unrealizedLossMonitor/index.ts`

**触发条件**:浮亏 < `-MAX_UNREALIZED_LOSS_PER_SYMBOL`

**执行操作**:

**核心方法**: `UnrealizedLossMonitor.checkAndLiquidate()`

1. 使用市价单(MO)立即清仓全部持仓
2. 强制刷新订单记录(forceRefresh=true)
3. 重新计算浮亏数据

### 6.4 牛熊证风险

**核心方法**: `RiskChecker.checkWarrantRecallPrice()`

**回收价检查**:使用监控标的的价格计算距回收价百分比

**计算公式**:
```
距离回收价% = (监控标的价格 - 回收价) / 回收价 × 100%
```

| 类型         | 检查条件                          |
| ------------ | --------------------------------- |
| 牛证(做多) | 距回收价百分比 < 0.5% 时拒绝买入  |
| 熊证(做空) | 距回收价百分比 > -0.5% 时拒绝买入 |

**异常保护**:监控标的价格 < 1 时拒绝买入(防止获取到错误价格,如牛熊证本身价格)

### 6.5 末日保护

**实现文件**: `src/core/doomsdayProtection/index.ts`

**收盘前 15 分钟拒绝买入**:

- 正常交易日:15:45-16:00
- 半日交易日:11:45-12:00

**收盘前 5 分钟自动清仓**(可选):

- 正常交易日:15:55-15:59
- 半日交易日:11:55-11:59
- 为所有持仓生成清仓信号(使用市价单)

---

## 7. 订单管理

**实现文件**: `src/core/trader/index.ts`

### 7.1 订单监控

**核心方法**: `Trader.monitorPendingOrders()`

系统仅监控**未成交的买入订单**(不监控卖出订单)。

### 7.2 订单修改规则

当市场价格下跌时,自动降低委托价以提高成交概率:

- 条件:最新价 < 委托价
- 修改:委托价 = 最新价
- 阈值:价格差异 ≥ 0.001 才修改(避免频繁修改)

**未成交订单缓存**: 15秒 TTL,避免频繁查询订单状态

### 7.3 监控生命周期

- **启用**:买入信号执行后自动启用
- **停止**:所有买入订单成交后自动停止

### 7.4 Trade API 频率限制

**实现文件**: `src/services/tradeClient/index.ts`

系统实施严格的 API 调用频率控制以符合 LongBridge 限制:

- **时间窗口限制**:30 秒内不超过 30 次调用
- **调用间隔限制**:两次调用间隔不少于 0.02 秒(20 毫秒)
- **并发安全**:通过内部锁机制确保多并发请求不会超限
- **自动等待**:超过限制时自动等待至最早调用过期(额外等待 100ms 缓冲)

**影响范围**:所有 Trade API 调用(下单、查询订单、修改订单、查询账户、查询持仓等)

### 7.5 订单记录缓存机制

为避免频繁调用 `historyOrders` API,系统实施订单数据缓存:

- **缓存时效**:永久(程序运行期间)
- **缓存内容**:买入订单、卖出订单、原始订单(包含未成交订单)
- **缓存键**:标的代码(规范化后)
- **刷新时机**:
  - 程序启动时强制刷新(调用 fetchOrdersFromAPI)
  - 保护性清仓后强制刷新(forceRefresh=true)
  - 正常交易后使用本地更新(recordLocalBuy/recordLocalSell)

**禁用标的机制**:

- 如果某标的的订单获取失败,该标的会被标记为禁用交易
- 禁用期间,该标的的所有买入和卖出信号将被跳过
- 目的:防止因数据不准确导致的错误交易

---

## 8. 关键数据流

### 8.1 程序启动

**实现文件**: `src/index.ts`

1. 初始化 LongBridge API 连接
2. 订阅实时行情
3. 获取并记录未平仓买入订单(做多/做空分开)
   - 同时调用 historyOrders 和 todayOrders
   - 合并去重
   - 应用过滤算法
4. 计算初始浮亏数据(R1, N1)
5. 获取牛熊证信息(回收价等)
6. 启动主循环

### 8.2 主循环(每秒执行)

**核心函数**: `runOnce()`

1. 检查交易日和交易时段
2. 获取实时行情,计算技术指标
3. 为待验证信号记录指标值到 verificationHistory
4. 生成交易信号(立即/延迟)
5. 验证延迟信号(检查 3 个时间点的趋势)
6. 处理卖出信号(成本价判断 → 智能平仓或全仓清仓)
7. 处理验证通过的买入信号(风险检查 → 提交订单)
8. 监控和修改未成交订单
9. 实时检查浮亏(触发保护性清仓时立即执行)
10. 显示变化的数据

### 8.3 交易后

**买入成交后**:

1. 本地更新订单记录(recordLocalBuy)
2. 刷新浮亏数据
3. 启用订单监控

**卖出成交后**:

1. 本地更新订单记录(recordLocalSell)
2. 刷新浮亏数据
3. 显示账户和持仓信息
4. 记录交易到日志文件(logs/trades/YYYY-MM-DD.json)

**保护性清仓后**:

1. 市价单立即清仓
2. 强制刷新订单记录(forceRefresh=true)
3. 刷新浮亏数据
4. 记录清仓交易到日志文件

### 8.4 交易记录

**实现**: 主循环中交易后记录

系统自动记录所有交易到 JSON 文件:

- **文件路径**: `logs/trades/YYYY-MM-DD.json`
- **记录内容**:
  - 标的代码和名称(格式:`标的名称(代码)`)
  - 信号类型(BUYCALL/SELLCALL/BUYPUT/SELLPUT)
  - 信号原因
  - 信号触发时间(北京时间)
  - 成交价、成交数量
  - 记录时间(北京时间)
- **用途**:交易复盘、策略分析、审计追溯

---

## 9. 配置要求

**配置文件**:
- `src/config/config.index.ts` - API 配置
- `src/config/config.trading.ts` - 交易配置
- `src/config/config.validator.ts` - 配置验证

### 9.1 必需配置

| 配置项            | 说明                    |
| ----------------- | ----------------------- |
| `MONITOR_SYMBOL`  | 监控标的(如恒生指数)  |
| `LONG_SYMBOL`     | 做多标的(牛证)        |
| `SHORT_SYMBOL`    | 做空标的(熊证)        |
| `LONG_LOT_SIZE`   | 做多标的每手股数        |
| `SHORT_LOT_SIZE`  | 做空标的每手股数        |
| `TARGET_NOTIONAL` | 每次买入目标金额(HKD) |
| `SIGNAL_BUYCALL`  | 买入做多信号配置        |
| `SIGNAL_SELLCALL` | 卖出做多信号配置        |
| `SIGNAL_BUYPUT`   | 买入做空信号配置        |
| `SIGNAL_SELLPUT`  | 卖出做空信号配置        |

### 9.2 风险控制配置

| 配置项                           | 说明                   | 默认值    |
| -------------------------------- | ---------------------- | --------- |
| `MAX_POSITION_NOTIONAL`          | 单标的最大持仓市值     | -         |
| `MAX_DAILY_LOSS`                 | 单标的最大浮亏(正数) | -         |
| `MAX_UNREALIZED_LOSS_PER_SYMBOL` | 保护性清仓阈值         | 0(关闭) |
| `DOOMSDAY_PROTECTION`            | 启用末日保护           | true      |
| `BUY_INTERVAL_SECONDS`           | 同方向买入间隔(秒)   | 60        |

### 9.3 验证配置

| 配置项                       | 说明                               | 默认值 |
| ---------------------------- | ---------------------------------- | ------ |
| `VERIFICATION_DELAY_SECONDS` | 延迟验证时间(秒,0-120)          | 60     |
| `VERIFICATION_INDICATORS`    | 验证指标(K,D,J,MACD,DIF,DEA,EMA) | D,DIF  |

---

## 10. 术语表

| 术语            | 说明                                               |
| --------------- | -------------------------------------------------- |
| **监控标的**    | 用于生成交易信号的指标标的(如恒生指数 800000.HK) |
| **做多标的**    | 用于做多交易的标的(通常是牛证)                   |
| **做空标的**    | 用于做空交易的标的(通常是熊证)                   |
| **牛证**        | 标的上涨时获利的结构化产品                         |
| **熊证**        | 标的价格下跌时获利的结构化产品                     |
| **回收价**      | 牛熊证的强制回收价格,触及后价值归零               |
| **成本价**      | API 返回的平摊成本价,用于判断盈利状态             |
| **开仓成本 R1** | 基于未平仓订单计算的成本,用于浮亏监控             |
| **持仓数量 N1** | 所有未平仓买入订单的数量总和,用于浮亏监控         |
| **浮亏**        | 当前持仓的未实现亏损 = R2 - R1                     |
| **智能平仓**    | 仅卖出盈利部分(买入价 < 当前价)的订单            |
| **全仓清仓**    | 卖出所有持仓(当整体盈利时)                       |
| **保护性清仓**  | 浮亏超过阈值时的紧急清仓机制                       |
| **延迟验证**    | 买入信号需要等待确认趋势后再执行                   |
| **立即信号**    | 卖出信号立即执行,无需等待验证                     |
| **ELO**         | 增强限价单(正常买卖使用)                         |
| **MO**          | 市价单(仅保护性清仓使用)                         |

---

## 11. 关键注意事项

### 11.1 成本价区分

- **平摊成本价(costPrice)**:用于判断是否盈利 → 决定全仓清仓还是智能平仓
- **开仓成本(R1)**:用于浮亏监控 → 决定是否触发保护性清仓

两者用途不同,**不可混淆**。

### 11.2 做多与做空独立

- 订单记录完全独立(`_longBuyOrders` 和 `_shortBuyOrders`)
- 浮亏监控完全独立(分别计算 R1 和 N1)
- 一方浮亏超限不影响另一方交易

### 11.3 牛熊证风险

- 使用**监控标的的价格**计算距回收价百分比(而非牛熊证本身价格)
- 牛证和熊证的检查方向相反(牛证 > 0.5%,熊证 < -0.5%)
- 监控标的价格异常小(< 1)时拒绝买入

### 11.4 订单记录算法重要性

- 是智能平仓和浮亏监控的**基础算法**
- 必须严格按照"从旧到新累积过滤"执行
- 确保准确识别未平仓的高价买入订单

### 11.5 市价单使用场景

- 仅在保护性清仓时使用市价单(MO)
- 正常交易使用增强限价单(ELO)

### 11.6 刷新策略

- **正常卖出**:本地更新(recordLocalSell)
- **保护性清仓**:强制从 API 刷新(refreshOrders, forceRefresh=true)
- 卖出后**必须**刷新浮亏数据

### 11.7 买入前数据获取

- **买入操作**:必须实时获取账户和持仓信息(并行获取以减少等待)
- **卖出操作**:可使用缓存数据(因卖出操作风险较低)
- **无法获取账户信息时**:买入操作被拒绝,卖出操作允许继续

### 11.8 末日保护的特殊处理

- 末日保护清仓信号**无条件执行**,不受成本价判断影响
- 浮亏保护清仓信号也**无条件执行**
- 正常卖出信号才需要进行成本价判断和智能平仓逻辑

### 11.9 订单监控范围

- **仅监控**:未成交的买入订单
- **不监控**:卖出订单(卖出订单通常很快成交)
- **监控目的**:在价格下跌时自动降低买入委托价,提高成交概率

### 11.10 禁用标的机制

- 订单获取失败时,标的会被标记为禁用交易
- 禁用期间,所有针对该标的的信号都会被跳过
- 目的:避免因数据不准确导致的错误交易决策

### 11.11 交易时段和半日交易

**实现文件**: `src/utils/tradingTime.ts`

- **正常交易日**:09:30-12:00, 13:00-16:00(UTC+8)
- **半日交易日**:09:30-12:00(仅上午,UTC+8)
- 末日保护时间会根据是否半日交易自动调整

### 11.12 指标显示精度

- 所有指标统一使用 3 位小数

### 11.13 延迟验证的3点确认机制

- 买入信号需要验证 3 个时间点(T0, T0+5s, T0+10s)的指标趋势
- **所有验证指标**在**所有 3 个时间点**的值都必须满足条件才通过
- BUYCALL:所有指标的 3 个时间点值都 > 初始值
- BUYPUT:所有指标的 3 个时间点值都 < 初始值
- 任一指标在任一时间点不满足条件,整个验证失败

### 11.14 订单获取双API机制

- 程序启动时同时调用 `historyOrders` 和 `todayOrders` API
- 合并两个 API 的结果并去重(基于 orderId)
- 目的:防止 historyOrders API 遗漏今日订单

### 11.15 验证窗口和误差容忍

- 验证窗口:触发时间前 5 秒到后 15 秒
- 每个时间点(T0, T1, T2)允许 ±5 秒误差
- 系统自动寻找最接近目标时间的记录值
- 等待 triggerTime + 15 秒后才执行验证(确保所有数据已记录)

### 11.16 技术约束

**实现文件**: `src/utils/helpers.ts`

- **标的代码规范化**:始终用 `normalizeHKSymbol()` 处理,确保带 `.HK` 后缀
- **Decimal 转换**: LongPort API 返回 Decimal 对象,必须用 `decimalToNumber()` 转换
- **订单类型**:所有订单用 ELO(增强限价单),保护性清仓用 MO(市价单)
- **买入必须实时数据**:买入前必须获取最新账户/持仓数据
- **卖出可用缓存**:卖出操作可使用缓存数据
- **订单记录缓存**:订单数据永久缓存(程序运行期间),避免频繁调用 historyOrders API

### 11.17 时区处理

- 系统内部:UTC
- 港股交易:09:30-12:00, 13:00-16:00(UTC+8)
- 日志显示:北京时间(`toBeijingTimeLog()`)

---

## 12. 代码架构

### 12.1 目录结构

```
src/
├── index.ts                      # 主入口,每秒执行 runOnce()
├── core/                         # 核心业务模块
│   ├── strategy/                 # 信号生成(立即/延迟)
│   │   └── index.ts
│   ├── signalVerification/       # 延迟信号验证(60秒验证趋势)
│   │   └── index.ts
│   ├── signalProcessor/          # 信号处理(风险检查+卖出数量计算)
│   │   └── index.ts
│   ├── trader/                   # 订单执行和监控(含未成交订单管理)
│   │   └── index.ts
│   ├── risk/                     # 风险控制(牛熊证/浮亏/持仓限制)
│   │   └── index.ts
│   ├── orderRecorder/            # 历史订单跟踪(永久缓存)
│   │   └── index.ts
│   ├── marketMonitor/            # 价格和指标监控
│   │   └── index.ts
│   ├── doomsdayProtection/       # 收盘前保护程序
│   │   └── index.ts
│   └── unrealizedLossMonitor/    # 浮亏监控(市价单清仓)
│       └── index.ts
├── services/
│   ├── indicators/               # 技术指标计算(RSI/MFI/KDJ/MACD/EMA)
│   │   └── index.ts
│   └── quoteClient/              # 行情数据客户端
│       └── index.ts
├── utils/                        # 工具函数库
│   ├── helpers.ts                # 通用工具函数
│   ├── signalConfigParser.ts    # 信号配置解析
│   ├── tradingTime.ts            # 交易时段判断
│   ├── logger.ts                 # 日志系统
│   ├── objectPool.ts             # 对象池(内存优化)
│   ├── indicatorHelpers.ts       # 指标辅助函数
│   └── accountDisplay.ts         # 账户显示
└── config/
    ├── config.index.ts           # API配置
    ├── config.trading.ts         # 交易配置
    └── config.validator.ts       # 配置验证
```

### 12.2 核心模块职责

| 模块                    | 文件路径                                 | 主要职责                                   |
| ----------------------- | ---------------------------------------- | ------------------------------------------ |
| **主循环**              | `src/index.ts`                           | 每秒执行 runOnce(),协调所有模块           |
| **Strategy**            | `src/core/strategy/index.ts`             | 根据技术指标生成交易信号                   |
| **SignalVerification**  | `src/core/signalVerification/index.ts`   | 延迟验证买入信号,确认趋势持续性           |
| **SignalProcessor**     | `src/core/signalProcessor/index.ts`      | 处理信号,计算卖出数量,执行风险检查       |
| **Trader**              | `src/core/trader/index.ts`               | 执行订单,监控未成交买入订单               |
| **RiskChecker**         | `src/core/risk/index.ts`                 | 买入前风险检查,浮亏监控                   |
| **OrderRecorder**       | `src/core/orderRecorder/index.ts`        | 记录和过滤未平仓买入订单                   |
| **MarketMonitor**       | `src/core/marketMonitor/index.ts`        | 监控价格和指标变化                         |
| **DoomsdayProtection**  | `src/core/doomsdayProtection/index.ts`   | 收盘前风险控制                             |
| **UnrealizedLossMonitor** | `src/core/unrealizedLossMonitor/index.ts` | 浮亏超限时触发保护性清仓                   |
| **Indicators**          | `src/services/indicators/index.ts`       | 计算技术指标(RSI/MFI/KDJ/MACD/EMA)       |
| **QuoteClient**         | `src/services/quoteClient/index.ts`      | 获取行情数据和K线                         |

### 12.3 关键文件说明

**核心业务逻辑**:
- `src/index.ts:runOnce()` - 主循环函数,协调所有模块
- `src/core/strategy/index.ts:generateSignals()` - 信号生成
- `src/core/signalVerification/index.ts:_verifySingleSignal()` - 验证逻辑
- `src/core/signalProcessor/index.ts:calculateSellQuantity()` - 卖出策略
- `src/core/trader/index.ts:executeSignals()` - 订单执行
- `src/core/trader/index.ts:monitorPendingOrders()` - 订单监控
- `src/core/risk/index.ts:checkBuyRisks()` - 风险检查
- `src/core/orderRecorder/index.ts:refreshOrders()` - 订单过滤算法

**技术指标**:
- `src/services/indicators/index.ts:buildIndicatorSnapshot()` - 统一计算所有指标
- `src/services/indicators/index.ts:calculateRSI()` - RSI 计算
- `src/services/indicators/index.ts:calculateKDJ()` - KDJ 计算
- `src/services/indicators/index.ts:calculateMACD()` - MACD 计算

**工具函数**:
- `src/utils/helpers.ts:normalizeHKSymbol()` - 标的代码规范化
- `src/utils/helpers.ts:decimalToNumber()` - Decimal 转换
- `src/utils/helpers.ts:toBeijingTimeLog()` - 时区转换
- `src/utils/signalConfigParser.ts:parseSignalConfig()` - 解析信号配置
- `src/utils/signalConfigParser.ts:evaluateSignalConfig()` - 评估信号条件
- `src/utils/objectPool.ts` - 对象池定义

---

## 13. 性能优化

### 13.1 对象池优化

**实现文件**: `src/utils/objectPool.ts`

系统使用对象池复用高频创建的临时对象,减少 GC 压力:

| 对象池名称              | 用途                   | 最大容量 |
| ----------------------- | ---------------------- | -------- |
| `verificationEntryPool` | 验证历史条目           | 50       |
| `signalObjectPool`      | 信号对象               | 100      |
| `kdjObjectPool`         | KDJ 指标对象           | 50       |
| `macdObjectPool`        | MACD 指标对象          | 50       |
| `monitorValuesObjectPool` | 监控值对象           | 20       |
| `positionObjectPool`    | 持仓对象               | 10       |

**使用方式**:
```typescript
// 获取对象
const obj = objectPool.get();

// 使用对象
obj.property = value;

// 释放对象(归还池中)
objectPool.release(obj);
```

### 13.2 缓存机制

**行情数据缓存** (`src/services/quoteClient/index.ts`):
- 实时行情:1 秒 TTL
- 交易日信息:24 小时 TTL
- 牛熊证信息:持久缓存

**订单记录缓存** (`src/core/orderRecorder/index.ts`):
- 买入订单、卖出订单:永久缓存(程序运行期间)
- 仅在程序启动和保护性清仓后从 API 刷新
- 正常交易后使用本地更新

**未成交订单缓存** (`src/core/trader/index.ts`):
- TTL: 15 秒
- 避免频繁查询订单状态

### 13.3 技术指标性能

**使用 technicalindicators 库**:
- 相比自实现,性能提升约 2.9 倍
- 支持批量计算,减少循环开销

**指标计算优化**:
- 一次性计算所有需要的指标
- 使用对象池复用 KDJ 和 MACD 对象
- 缓存计算结果,避免重复计算

### 13.4 并发优化

**并行数据获取**:
- K线数据和实时行情并发获取
- 买入前账户和持仓信息并发获取
- 减少等待时间,提高响应速度

**API 频率控制**:
- Trade API 严格限流(30秒/30次,间隔≥0.02秒)
- 自动等待机制,避免超限
- 并发安全锁,确保多线程环境正确

---

## 常见修改任务指南

| 任务             | 修改位置                                                                 |
| ---------------- | ------------------------------------------------------------------------ |
| 修改信号条件     | `.env` 文件(无需改代码)                                                |
| 添加新指标       | `src/services/indicators/index.ts` + `src/utils/signalConfigParser.ts` |
| 调整风险检查     | `src/core/risk/index.ts`(仅门控买入)                                   |
| 修改订单逻辑     | `src/core/trader/index.ts`(订单执行和监控)                             |
| 修改卖出策略     | `src/core/signalProcessor/index.ts` 中的 `calculateSellQuantity` 函数 |
| 修改配置参数     | `.env` 或 `src/config/config.trading.ts`                               |
| 调整验证逻辑     | `src/core/signalVerification/index.ts` 中的 `_verifySingleSignal` 方法 |
| 订单记录逻辑     | `src/core/orderRecorder/index.ts`(`refreshOrders` 过滤算法、`clearBuyOrders` 清仓) |
| 修改账户显示     | `src/utils/accountDisplay.ts` 中的 `displayAccountAndPositions` 函数   |
| 修改指标计算     | `src/services/indicators/index.ts` 中的各指标计算函数                   |
| 调整浮亏监控     | `src/core/unrealizedLossMonitor/index.ts` 中的 `checkAndLiquidate` 方法 |
| 调整市场监控     | `src/core/marketMonitor/index.ts` 中的监控逻辑和变化阈值               |
| 添加新的对象池   | `src/utils/objectPool.ts` 中定义新的对象池                             |
| 修改日志格式     | `src/utils/logger.ts` 中的日志配置                                     |

---

## 相关文档

- [README.md](../../README.md) - 用户指南和快速入门
- [docs/TECHNICAL_INDICATORS.md](../../docs/TECHNICAL_INDICATORS.md) - 技术指标计算原理
- [CLAUDE.md](../../CLAUDE.md) - Claude Code 工作指南

---

**最后更新**: 2026-01-05
**版本**: 2.0
