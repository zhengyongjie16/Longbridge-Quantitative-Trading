---
name: business-logic
description: 当用户需要你阅读当前业务逻辑或者检查是否符合业务需求，是否符合业务逻辑时，适用这个skill
---

# 业务逻辑完整说明

本文档描述港股自动化量化交易系统的核心业务逻辑，包括监控显示、交易信号、验证策略、订单记录、卖出策略和风险管控。

> **重要提示**：本文档是理解系统业务逻辑的权威参考，所有代码实现必须严格遵循本文档的规则。

---

## 目录

- [1. 监控和显示](#1-监控和显示)
- [2. 交易信号](#2-交易信号)
- [3. 买入验证策略](#3-买入验证策略)
- [4. 订单记录策略](#4-订单记录策略)
- [5. 卖出策略](#5-卖出策略)
- [6. 风险管控](#6-风险管控)
- [7. 订单管理](#7-订单管理)
- [8. 关键数据流](#8-关键数据流)
- [9. 配置要求](#9-配置要求)
- [10. 术语表](#10-术语表)
- [11. 关键注意事项](#11-关键注意事项)

---

## 1. 监控和显示

### 1.1 监控标的

系统实时监控目标资产（通常是恒生指数）的以下信息，仅在数据变化时更新：

| 数据类型 | 说明 |
|---------|------|
| 价格信息 | 最新价、涨跌额、涨跌幅 |
| 技术指标 | EMA、RSI（支持动态周期）、MFI、KDJ(K/D/J)、MACD(DIF/DEA/MACD) |

**变化检测**：仅当变化超过阈值时才触发显示更新，价格阈值 0.0001，指标阈值 RSI/MFI/KDJ 为 0.1，MACD/EMA 为 0.0001。

### 1.2 交易标的

做多标的和做空标的的价格信息（最新价、涨跌额、涨跌幅），同样仅在变化时显示。

### 1.3 交易后显示

当发生买入或卖出操作后，自动显示账户信息（余额、净资产）和持仓信息（数量、成本价、可用数量）。

---

## 2. 交易信号

### 2.1 信号类型

系统产生四类信号：

| 信号类型 | 动作 | 执行方式 |
|---------|------|---------|
| **BUYCALL** | 买入做多标的 | 延迟验证后执行 |
| **SELLCALL** | 卖出做多标的 | 立即执行 |
| **BUYPUT** | 买入做空标的 | 延迟验证后执行 |
| **SELLPUT** | 卖出做空标的 | 立即执行 |

### 2.2 信号配置

所有信号条件**完全可配置**，通过环境变量设置：

**配置格式**：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`

- 括号内条件列表，逗号分隔
- `/N`：括号内条件需满足 N 项，不设则全部满足
- `|`：分隔不同条件组，满足任一组即可
- **支持指标**：`RSI:n`（任意周期 1-100）、`MFI`、`D`（KDJ.D）、`J`（KDJ.J）
- **支持运算符**：`<`、`>`，支持负数阈值如 `J<-20`

**动态 RSI**：系统自动从配置中提取 RSI 周期并计算相应值，如配置 `RSI:6` 和 `RSI:12` 会同时计算 RSI6 和 RSI12。

### 2.3 信号执行规则

| 信号类型 | 是否延迟 | 验证条件 |
|---------|---------|---------|
| BUYCALL | 是（默认 60 秒） | 验证指标必须上涨（J2>J1 且 MACD2>MACD1 等） |
| SELLCALL | 否 | - |
| BUYPUT | 是（默认 60 秒） | 验证指标必须下跌（J2<J1 且 MACD2<MACD1 等） |
| SELLPUT | 否 | - |

---

## 3. 买入验证策略

买入信号（BUYCALL、BUYPUT）需要经过延迟验证确认趋势后才执行。

### 3.1 验证机制

**延迟时间**：默认 60 秒，可通过 `VERIFICATION_DELAY_SECONDS` 配置（范围 0-120 秒）。

**验证指标**：默认使用 J 和 MACD，可通过 `VERIFICATION_INDICATORS` 配置（可选：K、D、J、MACD、DIF、DEA）。

### 3.2 验证流程

**做多标的验证（BUYCALL）**：
1. 触发时记录验证指标的初始值（indicators1）
2. 等待延迟时间（每秒记录指标值到验证历史）
3. 获取验证值（indicators2）：优先精确匹配时间，备选最近值（误差 ≤ 5 秒）
4. 验证通过条件：**所有验证指标的第二个值 > 第一个值**（如 J2>J1 且 MACD2>MACD1）

**做空标的验证（BUYPUT）**：
- 验证通过条件：**所有验证指标的第二个值 < 第一个值**（如 J2<J1 且 MACD2<MACD1）

---

## 4. 订单记录策略

订单记录用于智能平仓和浮亏监控，核心是准确识别未平仓的买入订单。

### 4.1 记录时机

- **程序启动时**：获取当日做多/做空标的的历史成交订单
- **交易后本地更新**：买入/卖出成交后本地追加记录，不调用 API
- **保护性清仓后**：强制从 API 刷新订单记录

### 4.2 过滤算法（从旧到新累积过滤）

用于从所有历史订单中筛选出**当前仍需记录的买入订单**：

1. **M0**：最新卖出时间之后的买入订单（尚未经历卖出）
2. **从旧到新处理卖出订单**（D1 最旧 → DN 最新）：
   - 对每个卖出订单 Di，获取成交时间 < Di 的买入订单
   - 如果卖出数量 ≥ 买入总数量：该部分买入订单已全部卖出，不记录
   - 如果卖出数量 < 买入总数量：仅保留成交价 ≥ 卖出价的买入订单（盈利部分）
3. **最终记录** = M0 + 过滤后的买入订单

### 4.3 业务含义

- **M0**：最新买入的订单，还未经历任何卖出
- **过滤后的订单**：历史高价买入且未被完全卖出的订单（价格高于对应卖出价）

---

## 5. 卖出策略

卖出策略分为**全仓清仓**和**智能平仓**两种模式。

### 5.1 判断逻辑

| 条件 | 执行操作 |
|-----|---------|
| 当前价格 > 成本价（盈利状态） | 全仓清仓 |
| 当前价格 ≤ 成本价（未盈利） | 智能平仓：仅卖出 buyPrice < currentPrice 的订单 |
| 无符合条件的订单 | 持有（HOLD），不执行卖出 |

### 5.2 做多与做空的差异

- **做多标的**：价格高于成本价 = 盈利，清仓全部持仓
- **做空标的**：价格高于成本价 = 亏损（做空标的随监控标的反方向波动），此时也应清仓

### 5.3 成本价类型

| 类型 | 计算方式 | 用途 |
|-----|---------|------|
| **平摊成本价** | (买入成交额 - 卖出成交额) / 持仓数量 | 判断是否盈利 |
| **开仓成本 R1** | Σ(未平仓买入订单 price × quantity) | 浮亏监控 |

---

## 6. 风险管控

### 6.1 风险检查顺序（买入前）

1. **交易时段检查**：是否在港股交易时间
2. **交易频率检查**：同方向买入间隔是否过短（默认 60 秒）
3. **买入前价格检查**：是否追高（当前价 > 最新买入价则拒绝）
4. **末日保护检查**：收盘前 15 分钟拒绝买入
5. **牛熊证风险检查**：距回收价是否安全
6. **基础风险检查**：浮亏是否超限、持仓市值是否超限

**卖出操作不受上述检查限制**。

### 6.2 浮亏监控

**计算方式**：浮亏 = 当前持仓市值(R2) - 开仓成本(R1)

**R1**：所有未平仓买入订单的市值总和（price × quantity）
**R2**：当前价格 × 持仓数量

**更新时机**：
- 价格变化时实时计算
- 交易后重新计算

### 6.3 保护性清仓（避难程序）

**触发条件**：浮亏 < `-MAX_UNREALIZED_LOSS_PER_SYMBOL`

**执行操作**：
1. 使用市价单（MO）立即清仓全部持仓
2. 强制刷新订单记录
3. 重新计算浮亏数据

### 6.4 牛熊证风险

**回收价检查**：使用监控标的的价格计算距回收价百分比

| 类型 | 检查条件 |
|-----|---------|
| 牛证（做多） | 距回收价百分比 < 0.5% 时拒绝买入 |
| 熊证（做空） | 距回收价百分比 > -0.5% 时拒绝买入 |

**异常保护**：监控标的价格 < 1 时拒绝买入（防止获取到错误价格）

### 6.5 末日保护

**收盘前 15 分钟拒绝买入**：
- 正常交易日：15:45-16:00
- 半日交易日：11:45-12:00

**收盘前 5 分钟自动清仓**（可选）：
- 正常交易日：15:55-15:59
- 半日交易日：11:55-11:59
- 为所有持仓生成清仓信号

---

## 7. 订单管理

### 7.1 订单监控

系统仅监控**未成交的买入订单**（不监控卖出订单）。

### 7.2 订单修改规则

当市场价格下跌时，自动降低委托价以提高成交概率：
- 条件：最新价 < 委托价
- 修改：委托价 = 最新价
- 阈值：价格差异 ≥ 0.001 才修改（避免频繁修改）

### 7.3 监控生命周期

- **启用**：买入信号执行后自动启用
- **停止**：所有买入订单成交后自动停止

---

## 8. 关键数据流

### 8.1 程序启动

1. 初始化 LongBridge API 连接
2. 订阅实时行情
3. 获取并记录未平仓买入订单（做多/做空分开）
4. 计算初始浮亏数据
5. 获取牛熊证信息（回收价等）
6. 启动主循环

### 8.2 主循环（每秒执行）

1. 检查交易日和交易时段
2. 获取实时行情，计算技术指标
3. 为待验证信号记录指标值
4. 生成交易信号（立即/延迟）
5. 验证延迟信号
6. 处理卖出信号（成本价判断 → 智能平仓或全仓清仓）
7. 处理验证通过的买入信号（风险检查 → 提交订单）
8. 监控和修改未成交订单
9. 实时检查浮亏（触发保护性清仓时立即执行）
10. 显示变化的数据

### 8.3 交易后

**买入成交后**：
1. 本地更新订单记录
2. 刷新浮亏数据
3. 停止订单监控（所有订单成交后）

**卖出成交后**：
1. 本地更新订单记录
2. 刷新浮亏数据
3. 显示账户和持仓信息

**保护性清仓后**：
1. 市价单立即清仓
2. 强制刷新订单记录
3. 刷新浮亏数据

---

## 9. 配置要求

### 9.1 必需配置

| 配置项 | 说明 |
|-------|------|
| `MONITOR_SYMBOL` | 监控标的（如恒生指数） |
| `LONG_SYMBOL` | 做多标的（牛证） |
| `SHORT_SYMBOL` | 做空标的（熊证） |
| `LONG_LOT_SIZE` | 做多标的每手股数 |
| `SHORT_LOT_SIZE` | 做空标的每手股数 |
| `TARGET_NOTIONAL` | 每次买入目标金额（HKD） |
| `SIGNAL_BUYCALL` | 买入做多信号配置 |
| `SIGNAL_SELLCALL` | 卖出做多信号配置 |
| `SIGNAL_BUYPUT` | 买入做空信号配置 |
| `SIGNAL_SELLPUT` | 卖出做空信号配置 |

### 9.2 风险控制配置

| 配置项 | 说明 | 默认值 |
|-------|------|-------|
| `MAX_POSITION_NOTIONAL` | 单标的最大持仓市值 | - |
| `MAX_DAILY_LOSS` | 单标的最大浮亏（正数） | - |
| `MAX_UNREALIZED_LOSS_PER_SYMBOL` | 保护性清仓阈值 | 0（关闭） |
| `DOOMSDAY_PROTECTION` | 启用末日保护 | true |
| `BUY_INTERVAL_SECONDS` | 同方向买入间隔（秒） | 60 |

### 9.3 验证配置

| 配置项 | 说明 | 默认值 |
|-------|------|-------|
| `VERIFICATION_DELAY_SECONDS` | 延迟验证时间（秒，0-120） | 60 |
| `VERIFICATION_INDICATORS` | 验证指标（K,D,J,MACD,DIF,DEA） | J,MACD |

---

## 10. 术语表

| 术语 | 说明 |
|-----|------|
| **监控标的** | 用于生成交易信号的指标标的（如恒生指数 800000.HK） |
| **做多标的** | 用于做多交易的标的（通常是牛证） |
| **做空标的** | 用于做空交易的标的（通常是熊证） |
| **牛证** | 标的上涨时获利的结构化产品 |
| **熊证** | 标的价格下跌时获利的结构化产品 |
| **回收价** | 牛熊证的强制回收价格，触及后价值归零 |
| **成本价** | API 返回的平摊成本价，用于判断盈利状态 |
| **开仓成本 R1** | 基于未平仓订单计算的成本，用于浮亏监控 |
| **浮亏** | 当前持仓的未实现亏损 = R2 - R1 |
| **智能平仓** | 仅卖出盈利部分（买入价 < 当前价）的订单 |
| **全仓清仓** | 卖出所有持仓（当整体盈利时） |
| **保护性清仓** | 浮亏超过阈值时的紧急清仓机制 |
| **延迟验证** | 买入信号需要等待确认趋势后再执行 |
| **立即信号** | 卖出信号立即执行，无需等待验证 |
| **ELO** | 增强限价单（正常买卖使用） |
| **MO** | 市价单（仅保护性清仓使用） |

---

## 11. 关键注意事项

### 11.1 成本价区分

- **平摊成本价（costPrice）**：用于判断是否盈利 → 决定全仓清仓还是智能平仓
- **开仓成本（R1）**：用于浮亏监控 → 决定是否触发保护性清仓

两者用途不同，**不可混淆**。

### 11.2 做多与做空独立

- 订单记录完全独立
- 浮亏监控完全独立
- 一方浮亏超限不影响另一方交易

### 11.3 牛熊证风险

- 使用**监控标的的价格**计算距回收价百分比（而非牛熊证本身价格）
- 牛证和熊证的检查方向相反
- 监控标的价格异常小（< 1）时拒绝买入

### 11.4 订单记录算法重要性

- 是智能平仓和浮亏监控的**基础算法**
- 必须严格按照"从旧到新累积过滤"执行
- 确保准确识别未平仓的高价买入订单

### 11.5 市价单使用场景

- 仅在保护性清仓时使用市价单（MO）
- 正常交易使用增强限价单（ELO）

### 11.6 刷新策略

- **正常卖出**：本地更新（recordLocalSell）
- **保护性清仓**：强制从 API 刷新（refreshOrders, forceRefresh=true）
- 卖出后**必须**刷新浮亏数据
