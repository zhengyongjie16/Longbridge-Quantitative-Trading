---
name: business-logic
description: 港股量化交易系统业务逻辑知识库。包含信号生成、买卖策略、订单记录、风险检查、浮亏监控、牛熊证风险、延迟验证等。用于理解交易逻辑、验证代码实现、修改功能、解答业务规则。涉及信号配置、成本价计算、智能平仓、保护性清仓、订单过滤算法时使用。
---

# 业务逻辑知识库

港股量化交易系统的核心业务逻辑参考。

**核心机制**：监控恒指技术指标 → 牛熊证双向交易 → 开仓延迟验证(60秒) → 平仓立即执行 → 智能平仓 + 浮亏保护 + 末日保护

---

## 使用说明

### 何时使用

1. 用户询问业务逻辑（信号生成、卖出策略等）
2. 验证代码是否符合业务规则
3. 修改交易功能前了解规则
4. 调试业务问题

### 关键概念区分

| 概念对 | 区别 |
|--------|------|
| 平摊成本价 vs 开仓成本 | 前者判断盈利，后者计算浮亏 |
| 监控标的 vs 交易标的 | 前者生成信号(恒指)，后者执行交易(牛熊证) |
| 智能平仓 vs 全仓清仓 | 仅卖盈利部分 vs 全部卖出 |
| 正常卖出 vs 保护性清仓 | 前者判断成本价，后者无条件清仓 |
| 延迟信号 vs 立即信号 | 买入需验证60秒，卖出立即执行 |
| ELO vs MO | 增强限价单(正常) vs 市价单(保护性清仓) |

### 核心执行顺序

- **风险检查**：6项检查全部通过，顺序固定
- **订单过滤**：从旧到新累积过滤，不可倒序
- **数据获取**：买入前实时获取账户/持仓，卖出可用缓存

---

## 1. 交易信号

**文件**：`src/core/strategy/index.ts`

### 1.1 信号类型

| 信号 | 动作 | 执行 |
|------|------|------|
| BUYCALL | 买入做多 | 延迟验证 |
| SELLCALL | 卖出做多 | 立即 |
| BUYPUT | 买入做空 | 延迟验证 |
| SELLPUT | 卖出做空 | 立即 |

### 1.2 信号配置

**格式**：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`

- `/N`：需满足N项，不设则全部满足
- `|`：满足任一组即可
- **支持指标**：RSI:n、MFI、K/D/J、MACD/DIF/DEA、EMA:n
- **运算符**：`<`、`>`，支持负数如`J<-20`

**示例**：`(RSI:6<20,MFI<15,D<20,J<-1)/3|(J<-20)`
- 含义：4个条件满足3个 或 J<-20

---

## 2. 买入验证策略

**文件**：`src/core/signalVerification/index.ts`

### 2.1 验证机制

- **延迟时间**：默认60秒，可配置0-120秒
- **验证指标**：默认D和DIF，可配置K/D/J/MACD/DIF/DEA/EMA

### 2.2 验证流程

**时间点**：
- T0 = 触发时间
- T1 = T0 + 5秒
- T2 = T0 + 10秒

**验证窗口**：触发前5秒到后15秒，每个时间点允许±5秒误差

**BUYCALL验证**：所有验证指标在3个时间点的值都必须 > 初始值（上涨趋势）
**BUYPUT验证**：所有验证指标在3个时间点的值都必须 < 初始值（下跌趋势）

**失败处理**：任一指标在任一时间点不满足条件，验证失败，丢弃信号

---

## 3. 订单记录策略

**文件**：`src/core/orderRecorder/index.ts`

### 3.1 记录时机

- **启动时**：合并historyOrders和todayOrders，去重
- **交易后**：本地更新，不调API
- **保护性清仓后**：强制从API刷新(forceRefresh)

### 3.2 过滤算法（从旧到新累积过滤）

**核心方法**：`refreshOrders()`

1. **M0**：最新卖出后的买入订单（未经历卖出）
2. **从旧到新处理卖出订单**（D1→DN）：
   - 对每个卖出Di，获取成交时间 < Di 的买入订单
   - 卖出量 ≥ 买入总量：该部分已卖出，不记录
   - 卖出量 < 买入总量：保留成交价 ≥ 卖出价的买入订单（盈利部分）
3. **最终记录** = M0 + 过滤后的买入订单

### 3.3 本地记录

- `recordLocalBuy()` - 买入后新增
- `recordLocalSell()` - 卖出后按价格过滤
- `clearBuyOrders()` - 保护性清仓清空所有

---

## 4. 卖出策略

**文件**：`src/core/signalProcessor/index.ts`

### 4.1 判断逻辑

**核心方法**：`calculateSellQuantity()`

| 条件 | 操作 |
|------|------|
| 当前价 > 成本价（盈利） | 全仓清仓 |
| 当前价 ≤ 成本价（未盈利） | 智能平仓：仅卖buyPrice < currentPrice的订单 |
| 无符合条件订单 | HOLD |

**特殊情况**：
- **末日保护清仓**：无条件执行，不受成本价限制
- **浮亏保护清仓**：无条件执行

### 4.2 成本价类型

| 类型 | 计算 | 用途 |
|------|------|------|
| 平摊成本价 | (买入额 - 卖出额) / 持仓量 | 判断盈利 |
| 开仓成本R1 | Σ(未平仓买入 price × qty) | 浮亏监控 |

---

## 5. 风险管控

**文件**：`src/core/risk/index.ts`

### 5.1 风险检查顺序（买入前）

**核心方法**：`checkBuyRisks()`

1. **交易时段**：港股交易时间
2. **交易频率**：同方向间隔≥60秒
3. **买入价格限制**：currentPrice ≤ latestBuyPrice（防追高）
4. **末日保护**：收盘前15分钟拒绝
5. **牛熊证风险**：距回收价安全
6. **基础风险**：浮亏、持仓市值限制

### 5.2 浮亏监控

**计算**：浮亏 = R2 - R1
- R1：未平仓买入订单市值总和
- R2：当前价 × 持仓量

**更新**：启动时、交易后、价格变化时

### 5.3 保护性清仓

**文件**：`src/core/unrealizedLossMonitor/index.ts`

**触发**：浮亏 < -MAX_UNREALIZED_LOSS_PER_SYMBOL

**执行**：
1. 市价单(MO)清仓
2. 强制刷新订单(forceRefresh)
3. 重算浮亏

### 5.4 牛熊证风险

**核心方法**：`checkWarrantRecallPrice()`

**公式**：距离% = (监控标的价 - 回收价) / 回收价 × 100%

| 类型 | 检查条件 |
|------|----------|
| 牛证 | 距离% < 0.5% 拒绝 |
| 熊证 | 距离% > -0.5% 拒绝 |

**保护**：监控标的价 < 1 时拒绝（防错误价格）

### 5.5 末日保护

**文件**：`src/core/doomsdayProtection/index.ts`

- **收盘前15分钟**：拒绝买入
- **收盘前5分钟**：自动清仓（市价单）

---

## 6. 订单管理

**文件**：`src/core/trader/index.ts`

### 6.1 订单监控

**核心方法**：`monitorPendingOrders()`

- 仅监控未成交买入订单
- 价格下跌时自动降低委托价
- 条件：最新价 < 委托价，差异≥0.001
- 未成交订单缓存15秒TTL

### 6.2 Trade API频率限制

**文件**：`src/services/tradeClient/index.ts`

- 30秒内≤30次
- 调用间隔≥0.02秒
- 超限自动等待

### 6.3 订单记录缓存

- **缓存时效**：永久（运行期间）
- **刷新时机**：启动时、保护性清仓后强制刷新，正常交易本地更新
- **禁用标的**：订单获取失败时禁用该标的交易

---

## 7. 关键数据流

### 7.1 程序启动

1. 连接API，订阅行情
2. 获取未平仓订单（historyOrders + todayOrders合并）
3. 计算浮亏(R1, N1)
4. 获取牛熊证回收价
5. 启动主循环

### 7.2 主循环（每秒）

**文件**：`src/index.ts` - `runOnce()`

1. 检查交易时段
2. 获取行情，计算指标
3. 记录待验证信号的指标值
4. 生成信号
5. 验证延迟信号（3点趋势）
6. 处理卖出（成本价判断→智能/全仓）
7. 处理买入（风险检查→提交）
8. 监控未成交订单
9. 检查浮亏（触发清仓）
10. 显示数据

### 7.3 交易后

**买入**：本地记录→刷新浮亏→启用监控
**卖出**：本地记录→刷新浮亏→显示账户→记录日志
**保护性清仓**：市价单→强制刷新订单→刷新浮亏→记录日志

---

## 8. 配置

**文件**：`src/config/*.ts`、`.env`

### 8.1 必需配置

| 配置 | 说明 |
|------|------|
| MONITOR_SYMBOL | 监控标的（恒指） |
| LONG_SYMBOL | 做多标的（牛证） |
| SHORT_SYMBOL | 做空标的（熊证） |
| LONG_LOT_SIZE | 做多每手股数 |
| SHORT_LOT_SIZE | 做空每手股数 |
| TARGET_NOTIONAL | 每次买入金额 |
| SIGNAL_BUYCALL/SELLCALL/BUYPUT/SELLPUT | 信号配置 |

### 8.2 风险配置

| 配置 | 说明 | 默认 |
|------|------|------|
| MAX_POSITION_NOTIONAL | 最大持仓市值 | - |
| MAX_DAILY_LOSS | 最大浮亏 | - |
| MAX_UNREALIZED_LOSS_PER_SYMBOL | 保护性清仓阈值 | 0 |
| DOOMSDAY_PROTECTION | 末日保护 | true |
| BUY_INTERVAL_SECONDS | 买入间隔 | 60 |

### 8.3 验证配置

| 配置 | 说明 | 默认 |
|------|------|------|
| VERIFICATION_DELAY_SECONDS | 延迟时间(0-120) | 60 |
| VERIFICATION_INDICATORS | 验证指标 | D,DIF |

---

## 9. 术语表

| 术语 | 说明 |
|------|------|
| 监控标的 | 生成信号的标的（恒指） |
| 做多/做空标的 | 交易标的（牛/熊证） |
| 牛/熊证 | 标的涨/跌盈利的产品 |
| 回收价 | 牛熊证强制回收价 |
| 成本价 | 平摊成本，判断盈利 |
| 开仓成本R1 | 未平仓订单成本，浮亏监控 |
| 持仓量N1 | 未平仓订单总量 |
| 浮亏 | R2 - R1 |
| 智能平仓 | 仅卖盈利部分 |
| 全仓清仓 | 卖出全部 |
| 保护性清仓 | 浮亏超限紧急清仓 |
| ELO | 增强限价单 |
| MO | 市价单 |

---

## 10. 关键注意事项

### 10.1 成本价区分

- **平摊成本价**：判断盈利→全仓/智能平仓
- **开仓成本R1**：浮亏监控→保护性清仓

### 10.2 做多做空独立

- 订单记录独立(_longBuyOrders, _shortBuyOrders)
- 浮亏监控独立（各自R1, N1）
- 一方浮亏不影响另一方

### 10.3 牛熊证风险

- 使用**监控标的价格**计算距回收价%（非牛熊证价格）
- 牛证和熊证检查方向相反
- 监控标的价 < 1 时拒绝买入

### 10.4 订单过滤算法

- 智能平仓和浮亏监控的基础
- 必须"从旧到新累积过滤"
- 准确识别未平仓高价买入订单

### 10.5 市价单使用

- 仅保护性清仓使用MO
- 正常交易使用ELO

### 10.6 刷新策略

- 正常卖出：本地更新
- 保护性清仓：强制API刷新
- 卖出后必须刷新浮亏

### 10.7 买入数据获取

- 买入：实时获取账户/持仓（并行）
- 卖出：可用缓存
- 无法获取账户时买入被拒

### 10.8 末日/浮亏保护

- 末日保护清仓无条件执行
- 浮亏保护清仓无条件执行
- 不受成本价判断影响

### 10.9 延迟验证3点确认

- 验证T0、T0+5s、T0+10s三个时间点
- 所有验证指标在所有3点都必须满足
- BUYCALL：3点都 > 初始值
- BUYPUT：3点都 < 初始值
- 任一不满足，验证失败

### 10.10 订单双API机制

- 启动时同时调用historyOrders和todayOrders
- 合并去重（基于orderId）
- 防止historyOrders遗漏今日订单

### 10.11 技术约束

- 标的代码：`normalizeHKSymbol()` 规范化，带`.HK`
- Decimal转换：`decimalToNumber()`
- 订单类型：ELO（正常）、MO（保护性清仓）
- 买入实时数据，卖出可缓存
- 订单缓存：永久（运行期间）

---

## 11. 核心文件

| 模块 | 文件 | 职责 |
|------|------|------|
| 主循环 | `src/index.ts` | runOnce()协调 |
| 信号生成 | `src/core/strategy/index.ts` | 生成信号 |
| 信号验证 | `src/core/signalVerification/index.ts` | 延迟验证 |
| 信号处理 | `src/core/signalProcessor/index.ts` | 卖出数量 |
| 订单执行 | `src/core/trader/index.ts` | 下单监控 |
| 风险检查 | `src/core/risk/index.ts` | 风险门控 |
| 订单记录 | `src/core/orderRecorder/index.ts` | 过滤算法 |
| 浮亏监控 | `src/core/unrealizedLossMonitor/index.ts` | 保护清仓 |
| 末日保护 | `src/core/doomsdayProtection/index.ts` | 收盘保护 |
| 市场监控 | `src/core/marketMonitor/index.ts` | 价格指标 |
| 技术指标 | `src/services/indicators/index.ts` | RSI/KDJ/MACD |
| 工具函数 | `src/utils/helpers.ts` | 规范化/转换 |
| 配置解析 | `src/utils/signalConfigParser.ts` | 解析信号 |
