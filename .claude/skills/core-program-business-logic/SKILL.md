---
name: core-program-business-logic
description: 港股量化交易系统业务逻辑知识库。包含信号生成、买卖策略、订单记录、风险检查、浮亏监控、牛熊证风险、延迟验证等。用于理解交易逻辑、验证代码实现、修改功能、解答业务规则。
---

# 业务逻辑知识库

港股量化交易系统的核心业务逻辑参考。

**核心机制**：多监控标的并行处理 → 技术指标生成信号 → 信号分流（立即/延迟） → 异步交易处理 → 风险检查 → 牛熊证双向交易 → 智能平仓 + 浮亏保护 + 末日保护

---

## 使用说明

### 何时使用

1. 用户询问业务逻辑（信号生成、卖出策略等）
2. 验证代码是否符合业务规则
3. 修改交易功能前了解规则
4. 调试业务问题

### 关键概念区分

| 概念对 | 区别 |
|--------|------|
| 平摊成本价 vs 开仓成本 | 前者衡量盈利（不用于智能平仓），后者计算浮亏（R1） |
| 监控标的 vs 交易标的 | 前者生成信号(恒指)，后者执行交易(牛熊证) |
| 智能平仓 vs 全仓清仓 | 仅卖盈利部分 vs 全部卖出 |
| 正常卖出 vs 保护性清仓 | 前者按智能平仓/全仓规则处理，后者无条件清仓 |
| 立即信号 vs 延迟信号 | 无需验证直接执行 vs 需等待验证后执行 |
| ELO vs MO | 增强限价单(正常交易) vs 市价单(保护性清仓) |

---

## 1. 交易信号

### 1.1 信号类型

| 信号 | 动作 | 说明 |
|------|------|------|
| BUYCALL | 买入做多 | 买入牛证 |
| SELLCALL | 卖出做多 | 卖出牛证 |
| BUYPUT | 买入做空 | 买入熊证 |
| SELLPUT | 卖出做空 | 卖出熊证 |

### 1.2 信号配置格式

**格式**：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`

- `/N`：需满足N项，不设则全部满足
- `|`：满足任一组即可
- **支持指标**：RSI:n、MFI、K/D/J、MACD/DIF/DEA、EMA:n
- **运算符**：`<`、`>`，支持负数如`J<-20`

**示例**：`(RSI:6<20,MFI<15,D<20,J<-1)/3|(J<-20)` 表示4个条件满足3个 或 J<-20

### 1.3 卖出信号生成条件

卖出信号生成前先检查订单记录中是否有买入订单。无买入订单记录则不生成卖出信号。

### 1.4 信号分流机制

信号生成后根据验证配置分为两类：

| 信号类型 | 条件 | 处理方式 |
|---------|------|---------|
| 立即信号 | 延迟时间=0 或 验证指标为空 | 直接推入交易任务队列 |
| 延迟信号 | 延迟时间>0 且 验证指标非空 | 推入延迟验证器，验证通过后再推入任务队列 |

---

## 2. 延迟验证机制

### 2.1 基本概念

延迟验证用于确认趋势持续性后再执行交易，防止假信号。验证器使用 setTimeout 自行计时。

- **延迟时间**：买入和卖出分别配置，范围 0-120 秒
- **验证指标**：可配置 K/D/J/MACD/DIF/DEA/EMA:n
- **判断条件**：若延迟时间为 0 或验证指标为空，则信号立即执行

### 2.2 验证流程

**时间点定义**：
- T0 = 信号触发时刻（延迟时间结束时）
- T1 = T0 + 5秒
- T2 = T0 + 10秒

**执行时机**：信号触发后 15 秒执行验证（确保 T2 数据已记录）

**验证规则**：

| 信号类型 | 趋势要求 | 验证条件 |
|---------|---------|---------|
| BUYCALL | 上涨趋势 | T0、T1、T2 的值都 > 初始值 |
| BUYPUT | 下跌趋势 | T0、T1、T2 的值都 < 初始值 |
| SELLCALL | 下跌趋势 | T0、T1、T2 的值都 < 初始值 |
| SELLPUT | 上涨趋势 | T0、T1、T2 的值都 > 初始值 |

**验证结果**：
- 所有验证指标在所有 3 个时间点都满足条件 → 验证通过，推入交易队列执行
- 任一指标在任一时间点不满足 → 验证失败，丢弃信号

### 2.3 指标缓存机制

指标缓存使用环形缓冲区存储每秒的指标快照。存储时对快照进行深拷贝，确保数据独立于对象池。

- **时间容忍度**：±5 秒
- **缓存容量**：max(buyDelay, sellDelay) + 15 + 10

---

## 3. 订单记录策略

### 3.1 记录时机

- **启动时**：合并 historyOrders 和 todayOrders，去重后应用过滤算法
- **交易后**：本地更新，不调 API
- **保护性清仓后**：清空订单记录，重新计算浮亏数据

### 3.2 过滤算法

**目标**：识别未被完全卖出的买入订单，为智能平仓和浮亏监控提供准确数据

**执行步骤**：

1. **排序**：将所有卖出订单按成交时间从旧到新排序

2. **分类**：
   - M0：成交时间 > 最新卖出订单时间的买入订单（无条件保留）
   - candidateOrders：成交时间 ≤ 最新卖出订单时间的买入订单（需要过滤）

3. **逐个处理卖出订单**（必须按时间顺序，不可乱序）：
   - 获取上一轮结果中成交时间 < 当前卖出时间的买入订单
   - 比较买入总量与卖出数量：
     - 卖出数量 ≥ 买入总量：全部卖出，这些订单不保留
     - 卖出数量 < 买入总量：保留成交价 ≥ 卖出成交价的订单
   - 从原始 candidateOrders 获取时间间隔内的订单（开区间）
   - 合并得到本轮结果

4. **最终结果**：M0 + 最后一轮过滤结果

### 3.3 本地记录更新

- 买入后：新增订单记录
- 卖出后：按价格过滤订单记录（保留成交价 ≥ 卖出成交价的订单）
- 保护性清仓：清空所有订单记录

---

## 4. 卖出策略

### 4.1 卖出信号处理流程

卖出信号不经过风险检查，直接处理卖出数量计算。

1. **识别末日保护清仓信号**：信号原因包含"末日保护程序"则无条件执行，使用全部可用持仓数量

2. **正常卖出信号处理**：根据智能平仓开关决定处理方式

### 4.2 智能平仓逻辑

| 开关状态 | 行为 |
|---------|------|
| 关闭 | 直接清仓 |
| 开启 | 仅卖出买入价低于当前价的盈利订单 |

**智能平仓规则**：
- 订单记录不可用 → HOLD
- 无盈利订单 → HOLD
- 有盈利订单 → 卖出数量 = min(盈利订单总量, 可用持仓量)

**示例**：
```
当前价=1.20，可用持仓=300
盈利订单：1.00×100、1.10×250（盈利订单总量=350）
卖出数量=min(350, 300)=300
```

**常见误区**：
- 认为智能平仓会因成本价盈利而全仓清空（当前逻辑不会）
- 忽略订单记录不可用或无盈利订单会导致 HOLD

### 4.3 成本价类型

| 类型 | 计算方式 | 用途 |
|------|---------|------|
| 平摊成本价 | (买入额 - 卖出额) / 持仓量 | 盈利展示/统计（智能平仓不使用） |
| 开仓成本 R1 | Σ(未平仓买入 price × qty) | 浮亏监控 |

---

## 5. 风险管控

### 5.1 买入信号检查顺序

买入信号需通过以下 5 项检查（任一失败则拒绝）：

1. **交易频率限制**：同方向买入间隔 ≥ 配置时间（默认 60 秒）

2. **买入价格限制**：当前价格 ≤ 最新买入订单价格（防止追高）

3. **末日保护检查**：收盘前 15 分钟内拒绝买入（正常日 15:45-16:00，半日 11:45-12:00）

4. **牛熊证风险检查**：
   - 牛证：监控标的价格距离回收价 > 0.5%
   - 熊证：监控标的价格距离回收价 < -0.5%
   - 监控标的价格 < 1 时拒绝买入

5. **基础风险检查**：
   - 浮亏检查：单标的浮亏 > -MAX_DAILY_LOSS
   - 持仓市值限制：单标的市值 ≤ MAX_POSITION_NOTIONAL
   - 港币可用现金 ≥ 买入金额

### 5.2 卖出信号处理

卖出信号不经过风险检查，直接处理卖出数量计算。原因：卖出操作优先级高于买入，应优先允许执行。

### 5.3 数据获取策略

| 操作 | 数据来源 |
|------|---------|
| 买入 | 必须从 API 获取最新数据，不使用缓存 |
| 卖出 | 可使用缓存数据 |

### 5.4 浮亏监控

**计算公式**：浮亏 = R2 - R1
- R1：未平仓买入订单市值总和（每个订单市值 = 成交价 × 成交数量）
- R2：当前价 × 持仓量(N1)
- N1：未平仓买入订单的成交数量总和

**更新时机**：启动时、交易后、价格变化时

### 5.5 保护性清仓

**触发条件**：浮亏 < -MAX_UNREALIZED_LOSS_PER_SYMBOL

**执行流程**：
1. 创建清仓信号（订单类型根据全局配置 LIQUIDATION_ORDER_TYPE 自动选择）
2. 执行清仓订单
3. 清空订单记录
4. 重新计算浮亏数据（R1=0, N1=0）

**与正常卖出区别**：保护性清仓无条件全部卖出，清空所有订单记录

### 5.6 末日保护

| 交易日类型 | 拒绝买入时段 | 撤销未成交买入订单 | 自动清仓时段 |
|-----------|-------------|-------------------|-------------|
| 正常交易日 | 15:45-16:00 | 首次进入时执行一次 | 15:55-15:59 |
| 半日交易日 | 11:45-12:00 | 首次进入时执行一次 | 11:55-11:59 |

清仓信号无条件执行，不受智能平仓影响。

---

## 6. 订单管理

### 6.1 订单监控机制

使用 WebSocket 订阅订单状态变化。订单完全成交时：
1. 使用实际成交价更新本地订单记录
2. 标记需要刷新的数据（账户、持仓、浮亏）
3. 主循环统一刷新缓存数据

### 6.2 订单价格跟踪和超时处理

- **价格跟踪**：委托价始终跟随最新市场价格，价格下跌时自动降低委托价
- **超时转市价**：委托超过配置时间（默认 3 分钟）未成交，自动撤销并使用市价单重新委托
- **调整条件**：当前价格低于委托价格、差异 ≥ 0.001 港币、订单状态为未成交或部分成交

### 6.3 API 频率限制

- 30 秒内 ≤ 30 次
- 调用间隔 ≥ 0.02 秒
- 超限自动等待

---

## 7. 程序执行流程

### 7.1 程序启动

1. 验证配置，获取标的信息
2. 初始化全局模块：交易器、市场监控、末日保护、指标缓存、交易任务队列、交易处理器
3. 为每个监控标的创建独立上下文：策略、订单记录器、延迟信号验证器、风险检查器、浮亏监控器
4. 初始化牛熊证信息（获取回收价）
5. 获取账户和持仓信息
6. 初始化订单记录（从 API 获取并过滤）
7. 初始化浮亏监控数据
8. 为每个延迟验证器注册回调（验证通过后推入任务队列）
9. 启动交易处理器和主循环

### 7.2 主循环（每秒执行）

**全局层面**：

1. **交易日检查**：首次或跨天时调用 API，之后使用缓存

2. **交易时段检查**：判断是否在连续交易时段，不在则跳过（收盘时清理所有待验证信号）

3. **末日保护检查**：
   - 收盘前 15 分钟：首次进入时撤销所有未成交买入订单
   - 收盘前 5 分钟：生成清仓信号，清空所有持仓

4. **批量获取行情**：一次性获取所有监控标的和交易标的的行情数据

5. **并发处理所有监控标的**

6. **全局订单监控**：监控未成交订单，自动调整价格

7. **刷新缓存数据**：订单成交后统一刷新账户、持仓、浮亏缓存

**单监控标的处理**：

1. 从行情 Map 中提取当前标的的行情数据
2. 监控价格变化
3. 浮亏检查（仅在价格变化时）
4. 获取 K 线数据
5. 计算技术指标
6. 存入指标缓存
7. 生成信号
8. 信号分流：
   - 立即信号 → 交易任务队列
   - 延迟信号 → 延迟验证器
9. 延迟验证器验证通过后将信号推入交易任务队列

### 7.3 交易处理器

交易处理器独立运行，使用 setImmediate 异步消费交易任务队列，不阻塞主循环。

**处理流程**：
1. 从队列获取任务
2. 获取监控上下文（行情、持仓数据从 MonitorContext 和 positionCache 获取）
3. 卖出信号：直接处理卖出数量计算
4. 买入信号：执行风险检查
5. 提交订单执行
6. 释放信号对象到对象池

**调度机制**：
- 队列有任务时：立即处理并继续调度
- 队列为空时：停止调度，等待新任务触发重新调度
- 避免忙等待（busy-waiting）

### 7.4 交易后处理

订单完全成交时：
1. 使用实际成交价更新本地订单记录
2. 标记待刷新数据
3. 主循环末尾统一刷新账户、持仓、浮亏缓存

---

## 8. 配置说明

### 8.1 多标的配置

每个监控标的使用后缀 `_N`（N 从 1 开始）区分，系统会自动检测存在的监控标的配置（从 `_1` 开始扫描直到找不到配置为止）。

**单监控标的配置项**：
- `MONITOR_SYMBOL_N`：监控标的（如恒指）
- `LONG_SYMBOL_N`：做多标的（牛证）
- `SHORT_SYMBOL_N`：做空标的（熊证）
- `TARGET_NOTIONAL_N`：每次买入金额
- `SIGNAL_BUYCALL_N` / `SELLCALL_N` / `BUYPUT_N` / `SELLPUT_N`：信号配置
- `SMART_CLOSE_ENABLED_N`：智能平仓开关（默认 true）

### 8.2 验证配置

| 配置 | 说明 | 默认 |
|------|------|------|
| VERIFICATION_DELAY_SECONDS_BUY_N | 买入延迟时间(0-120秒) | 60 |
| VERIFICATION_DELAY_SECONDS_SELL_N | 卖出延迟时间(0-120秒) | 60 |
| VERIFICATION_INDICATORS_BUY_N | 买入验证指标 | K,MACD |
| VERIFICATION_INDICATORS_SELL_N | 卖出验证指标 | K,MACD |

### 8.3 风险配置

| 配置 | 说明 |
|------|------|
| MAX_POSITION_NOTIONAL | 最大持仓市值 |
| MAX_DAILY_LOSS | 最大浮亏（买入检查用） |
| MAX_UNREALIZED_LOSS_PER_SYMBOL | 保护性清仓阈值 |
| DOOMSDAY_PROTECTION | 末日保护开关（默认 true） |
| BUY_INTERVAL_SECONDS | 买入间隔（默认 60 秒） |

### 8.4 订单配置

| 配置 | 说明 |
|------|------|
| TRADING_ORDER_TYPE | 交易订单类型（LO/ELO/MO，默认 ELO） |
| LIQUIDATION_ORDER_TYPE | 清仓订单类型（默认 MO） |
| BUY_ORDER_TIMEOUT_SECONDS | 买入订单超时时间（默认 180 秒） |
| SELL_ORDER_TIMEOUT_SECONDS | 卖出订单超时时间（默认 180 秒） |

---

## 9. 术语表

| 术语 | 说明 |
|------|------|
| 监控标的 | 生成信号的标的（如恒指） |
| 做多/做空标的 | 交易标的（牛/熊证） |
| 回收价 | 牛熊证强制回收价 |
| 成本价 | 平摊成本，衡量盈利（智能平仓不使用） |
| 开仓成本 R1 | 未平仓订单成本，用于浮亏监控 |
| 持仓量 N1 | 未平仓订单总量 |
| 浮亏 | R2 - R1 |
| 智能平仓 | 仅卖盈利部分 |
| 保护性清仓 | 浮亏超限紧急清仓 |
| 末日保护 | 收盘前自动保护机制 |
| ELO | 增强限价单 |
| MO | 市价单 |
| 交易任务队列 | FIFO 队列，存储待处理的交易信号 |
| 交易处理器 | 异步消费任务队列，执行风险检查和订单 |
| 指标缓存 | 环形缓冲区，存储每秒的指标快照 |
| triggerTime | 信号触发时间（立即信号=生成时间，延迟信号=T0，末日保护=生成时间） |

---

## 10. 关键注意事项

### 成本价区分
- **平摊成本价**：用于盈利展示/统计（智能平仓不使用）
- **开仓成本 R1**：用于浮亏监控触发保护性清仓

### 做多做空独立性
- 订单记录独立（做多和做空分别记录）
- 浮亏监控独立（各自 R1、N1）
- 一方浮亏不影响另一方

### 多监控标的独立性
- 配置独立：每个监控标的有独立的信号配置、风险配置、验证配置
- 状态独立：价格、指标、待验证信号列表各自独立
- 延迟验证器独立：每个监控标的有独立的 DelayedSignalVerifier
- 订单记录共享：所有监控标的共享同一个订单记录器实例，通过标的代码区分
- 并发处理：使用 Promise.all 并发处理，互不干扰

### 订单过滤算法
- 必须按时间顺序从旧到新处理卖出订单
- 每轮过滤基于上一轮结果
- 时间间隔订单必须从原始 candidateOrders 获取
- 时间间隔使用开区间

### 延迟验证要点
- 验证时间点：T0、T0+5s、T0+10s
- 验证就绪时间：信号触发后 15 秒
- 所有配置的验证指标在所有时间点都必须满足趋势条件
- 收盘时清理所有待验证信号（避免无效验证）
- 指标缓存对快照进行深拷贝，确保数据独立于对象池

### 数据获取策略
- 买入检查：必须从 API 获取最新数据
- 卖出检查：可使用缓存数据
- 缓存仅用于日志显示，不用于风险检查

### 交易日缓存
- 程序启动时获取交易日信息
- 使用日期字符串作为缓存键
- 跨天时自动刷新

### 异步交易处理
- 信号生成和风险检查/订单执行解耦
- 使用 setImmediate 异步处理，不阻塞主循环
- 信号对象在交易处理器中统一释放到对象池

