---
name: core-program-business-logic
description: 港股量化交易系统业务逻辑知识库。包含信号生成、买卖策略、订单记录、风险检查、浮亏监控、牛熊证风险、延迟验证等。用于理解交易逻辑、验证代码实现、修改功能、解答业务规则。
---

# Core Program Business Logic

港股量化交易系统业务逻辑知识库。

## 使用范围

适用于解释和校验以下业务域：

- 交易日启动、主循环、跨日生命周期与开盘重建。
- 信号生成、延迟验证、买卖分流与下单执行。
- 订单记录、待成交防重、成交后刷新与重启恢复。
- 买入风控、浮亏监控、牛熊证风险、保护性清仓与买入冷却。
- 自动寻标、距离换标、周期换标及换标后刷新。

## 系统全局机制

系统采用“主循环 + 异步处理器 + 生命周期状态机”：

- 主循环每秒执行一次，负责交易日和交易时段门禁、行情批量拉取、单标的处理调度。
- 买入、卖出、监控任务、盯单、成交后刷新均为独立异步处理器，避免互相阻塞。
- 生命周期管理器负责跨日清理与开盘重建；重建完成前全局交易门禁关闭。

关键门禁状态：

- 连续交易时段门禁状态：用于判断当前是否处于连续交易时段。
- 开盘保护状态：开盘保护窗口内仅禁止信号生成，不禁止自动寻标和风险任务。
- 生命周期交易开关：关闭时所有下单路径停止。

## 交易信号与分流

### 信号类型

- BUYCALL：买入做多标的（通常牛证）。
- SELLCALL：卖出做多标的。
- BUYPUT：买入做空标的（通常熊证）。
- SELLPUT：卖出做空标的。

### 信号条件表达

信号配置是“多条件组 OR”模型：

- 组内可配置“最少满足 N 项”；未配置时等价于“组内全满足”。
- 组间关系为 OR。
- 支持固定指标（MFI、K、D、J）和带周期指标（RSI、PSY）。
- 支持大于和小于阈值比较，阈值可为负数。

### 生成约束

- 卖出信号仅在该方向该标的存在买入订单记录时才生成。
- 延迟秒数配置大于零且验证指标列表非空时进入延迟验证，否则为立即信号。

### 分流前校验

信号在入队前统一做席位与行情校验：

- 席位状态为 READY。
- 信号标的与席位当前标的一致。
- 买入信号必须有可用行情；卖出信号可在无行情下继续后续处理。
- 信号写入当前席位版本号，后续所有异步链路基于版本做一致性校验。

不满足条件时信号直接丢弃并回收对象。

## 延迟验证机制

延迟验证目标：确认趋势延续，过滤瞬时噪音。

验证时序：

- 初始触发时刻已包含策略配置的延迟秒数。
- 实际验证在初始触发时刻后第十秒执行，用于确保三点数据可读取。

验证数据：

- 从指标缓存读取三个时间点：初始触发时刻、五秒后、十秒后，允许时间容差正负五秒。
- 每个验证指标均与信号生成时的初始指标值比较。

趋势判定：

- BUYCALL、SELLPUT：要求三点都高于初始值（上涨趋势）。
- BUYPUT、SELLCALL：要求三点都低于初始值（下跌趋势）。

失败条件：

- 任一时间点缺失。
- 任一指标任一时间点不满足趋势比较。

失败即丢弃并回收；通过后进入买卖任务队列，处理器阶段仍会再次校验席位版本与标的一致性。

## 买入执行链路（风险优先）

买入处理器仅处理买入动作，核心顺序固定。

### 1) 风险检查冷却（10 秒）

先按标的做风险检查限流（买入方向共用键）：

- 冷却键按“标的 + 买入方向”生成。
- 冷却期内信号不进入后续检查，直接跳过。

### 2) 批量拉取实时账户和持仓

当前批次只要存在买入信号，就先批量获取实时账户和持仓；获取失败则该批买入全部拒绝。

### 3) 单信号买入检查顺序

顺序固定，任一失败即拒绝：

1. 交易频率限制（同监控标的同方向最小买入间隔）。
2. 保护性清仓冷却检查（minutes / half-day / one-day）。
3. 频率通过后立即记录买入尝试，防同批次重复通过。
4. 买入价格限制（当前价不得高于该标的该方向最新买入价）。
5. 末日保护 15 分钟拒买检查。
6. 牛熊证风险检查（回收价距离、价格下限、监控价有效性）。
7. 基础风控（现金、浮亏阈值、持仓市值上限）。

### 4) 买入数量与下单

数量优先级：

- 显式下单数量（需满足整手约束）。
- 未显式提供则按目标金额换算并按手数向下取整。

买入委托价使用执行时最新行情，不用信号快照价。

## 卖出执行链路（不走买入风控）

卖出处理器不执行买入风险流水线，先做席位版本校验，再计算卖出数量。

### 末日保护卖出

若信号原因包含末日保护语义，按可用持仓全量清仓，不走智能平仓。

### 常规卖出与智能平仓

智能平仓关闭：

- 直接卖出全部可用持仓。

智能平仓开启（三阶段）：

1. 整体盈利阶段：若当前价高于成本均价，按可卖订单全卖。
2. 盈利订单阶段：若未整体盈利，只卖盈利订单。
3. 超时订单阶段：仅当智能平仓超时分钟配置存在时启用，在第二阶段剩余额度内卖超时订单。

统一约束：

- 排除已被待成交卖单占用的买入订单。
- 可配置额外排除集（第三阶段会排除第二阶段已选订单）。
- 超出可卖上限时按“低价优先、整单不拆分”截断。
- 无有效可卖订单时信号转 HOLD。

卖出委托价同样以执行时行情为准。

## 订单记录与持仓还原规则

订单记录器是智能平仓和浮亏计算的核心数据源。

### 重建来源

启动或重建阶段从全量订单恢复：

- 历史和当日订单合并去重，同一订单唯一标识取更新时间更晚的快照，当日优先。
- 按标的拆分后得到已成交买单、已成交卖单、待成交订单。

### 买卖过滤算法（核心口径）

目标：找出“仍未被卖出覆盖”的买入订单。

规则：

- 卖单按成交时间从旧到新顺序处理。
- 每轮基于上一轮结果继续扣减，不可乱序。
- 扣减策略为“低价优先、时间早优先、订单唯一标识字典序优先”，整单消除，不拆分。
- 最终结果由两部分组成：最新卖单之后的新买单，以及顺序过滤后的历史买单。

### 本地增量更新

- 买入成交：追加买单记录。
- 卖出成交：按同一低价优先整单扣减买单记录。
- 保护性清仓或显式清仓：清空该标的买单记录。

## 待成交卖出占用防重

系统在提交卖单时登记关联买单标识，防止重复卖出同一批买单：

- 提交卖单：写入待成交卖出占用。
- 部分成交：更新已成交数量。
- 完全成交或撤单：移除占用。
- 智能平仓选单时自动排除占用订单。

重启恢复时，会为快照中的待成交卖单重新分配关联买单标识，保证防重语义连续。

## 订单执行与盯单策略

### 订单监控来源

通过实时订单推送更新状态，并维护本地追踪与恢复状态机（BOOTSTRAPPING / ACTIVE）。

### 下单门禁补充

- 非保护性信号若跨交易日或触发时间无效，在执行阶段直接丢弃。
- 生命周期门禁关闭时，执行层不提交新订单（在途任务会被二次门禁拦截）。

### 成交处理

订单完全成交后：

- 用真实成交价更新本地订单记录。
- 卖单同步完成待成交卖出占用结算。
- 更新日内已实现亏损偏移。
- 若是保护性清仓成交，写入买入冷却记录。
- 标记缓存为待刷新，触发成交后刷新流程。

### 超时与改单

- 买单超时：只撤单，不转市价。
- 卖单超时：撤单后转市价单提交剩余数量。
- 非市价单且状态可改时，按最小价格差和最小时间间隔做跟价。

### 启动恢复（严格模式）

恢复未完成订单时：

- 卖单若无法归属到当前席位或与席位不匹配，直接失败并阻断恢复。
- 买单不匹配时尝试撤单，撤单失败同样阻断恢复。
- BOOTSTRAPPING 阶段缓存推送事件，恢复后按时间顺序回放并做一致性对账。

## 风险控制体系

### 基础风控（下单前检查）

针对买入重点检查：

- 账户数据可用性。
- HKD 可用现金不少于下单金额。
- 浮亏阈值（按方向标的）。
- 单标的持仓市值上限（现有持仓与本次下单金额合并计算）。

卖出不做买入型资金和浮亏限制。

### 牛熊证风险（买入）

买入前要求：

- 必须有有效回收价。
- 监控价有效且不低于最小阈值。
- 牛熊证价格高于最小阈值。
- 距回收价百分比满足方向阈值：
  - 牛证需大于 0.35%。
  - 熊证需小于 -0.35%。

### 浮亏监控与保护性清仓

口径：

- 开仓成本总和。
- 未平仓数量总和。
- 当前市值（当前价乘以未平仓数量）。
- 浮亏等于当前市值减去开仓成本总和。

触发：

- 当浮亏低于单标的最大浮亏阈值（负值方向）时触发保护性清仓。

清仓后：

- 提交清仓单（类型由全局清仓订单类型配置决定）。
- 清空该标的订单记录。
- 立即刷新浮亏缓存，避免旧成本继续参与判断。

### 日内已实现亏损偏移（Daily Loss Offset）

按“监控标的 + 方向”维护当日已实现盈亏偏移：

- 当日已实现盈亏按“当日卖出金额减去当日买入金额，再加上当前未平仓买单成本”计算。
- 正收益偏移记为零；仅保留负值偏移。
- 刷新浮亏时，在开仓成本口径上减去该偏移值。
- 偏移值恒为非正，因此会抬高成本口径，影响浮亏触发灵敏度。

### 清仓后买入冷却

支持三种模式：

- minutes：成交后 N 分钟内禁止买入。
- half-day：上午清仓冷却到 13:00；下午清仓冷却到次日 00:00（香港时间）。
- one-day：冷却到次日 00:00（香港时间）。

午夜生命周期清理只清跨日模式键；minutes 模式按剩余时间自然衰减。

### 静态标的距回收价清仓

仅在未启用自动寻标时启用该检查任务：

- 牛证距离回收价小于等于 0.3%，或熊证距离回收价大于等于 -0.3% 时触发清仓。
- 仅对可用持仓大于零的方向生效。
- 清仓订单类型固定为 ELO。

## 末日保护

末日保护启用时：

- 收盘前 15 分钟：拒绝新买入，并在当日首次进入窗口时执行一次“撤销未成交买单”。
- 收盘前 5 分钟：为可清仓持仓生成清仓信号并执行。

时间窗口：

- 正常交易日：15:45-16:00 拒买，15:55-16:00 清仓。
- 半日交易日：11:45-12:00 拒买，11:55-12:00 清仓。

末日清仓信号不走智能平仓分支。

## 自动寻标与自动换标

系统以“席位（Seat）”管理每个监控标的的 LONG / SHORT 交易标的。

席位状态：

- EMPTY：空席位，不可交易。
- SEARCHING：寻标中。
- SWITCHING：换标中。
- READY：可交易。

席位版本号在关键切换时递增，用于阻断旧信号和旧任务。

### 自动寻标（空席位补齐）

触发前提：

- 自动寻标启用。
- 当前在可交易时段。
- 席位为 EMPTY 且未冻结。
- 满足寻标冷却间隔。
- 若配置了早盘延迟，则延迟窗口内不寻标。

失败策略：

- 每次失败累计当日失败次数。
- 达到上限后冻结该方向席位至当日结束，状态保持 EMPTY。

成功策略：

- 席位切到 READY，写入新标的与回收价，失败计数清零。

### 距离换标（动态风控触发）

触发条件：

- 席位 READY。
- 距回收价百分比落在区间外（小于等于下限或大于等于上限）。

流程要点：

1. 先预寻标候选。
2. 若候选与当前标的一致，记录“当日抑制”并停止换标。
3. 清席位并提升版本，进入状态机。
4. 撤销旧标的待成交买单。
5. 距离换标模式下执行移仓卖出（有可用持仓才提交）。
6. 绑定新标的（先 SWITCHING，最终 READY）。
7. 若发生移仓卖出并有卖出实绩，则按卖出金额回补买入新标的。

补充规则：

- 若旧标的总持仓大于零但可用持仓为零，状态机等待，不立即换标完成。
- 移仓卖出和回补买入均使用 ELO。

### 周期换标（时间触发）

触发前提：

- 自动寻标启用。
- 周期间隔大于零。
- 当前可交易且不在开盘保护窗口。
- 席位 READY 且最近一次进入 READY 的时间有效。

计时口径：

- 使用“交易时段累计时长”，午休和非交易日不计。

到期行为：

- 若仍有买单记录，进入待处理状态并等待空仓。
- 空仓后启动换标流程。
- 周期换标仅做替换，不做移仓卖出与回补。

## 换标后刷新与失败处理

换标成功后通过 SEAT_REFRESH 任务刷新关键缓存：

- 以全量订单重算订单记录。
- 重算日内亏损偏移。
- 刷新账户与持仓缓存。
- 刷新浮亏缓存。
- 用回收价更新牛熊证风险缓存。
- 清理旧标的订单记录与缓存（若旧标的不再被任何席位占用）。

换标失败处理：

- 席位置 EMPTY，提升版本，清理该方向待执行队列与延迟信号。
- 失败原因可触发失败计数和当日冻结（无候选等场景）。

## 异步任务与一致性保证

一致性机制由三部分组成：

- 席位版本校验：信号、任务、下单前均校验版本。
- 席位快照校验：监控任务带创建时快照，执行前后校验，失配即跳过。
- 刷新门禁机制：成交后先标记为待刷新，刷新完成后再标记为已刷新；关键处理器会等待刷新完成后继续。

队列策略：

- 买卖队列 FIFO。
- 监控任务队列支持按去重键保留最新任务，避免旧任务堆积。
- 盯单工作器使用“最新覆盖”策略，同一时刻只跑一个盯单任务。

## 启动与开盘重建流程

启动阶段：

1. 配置验证。
2. 启动门禁检查（交易日、交易时段、开盘保护）。
3. 加载运行时快照：账户、持仓、全量订单、席位准备、订阅与行情。
4. 初始化监控上下文、策略、风控、异步处理器。
5. 重建订单记录、风险缓存、浮亏缓存、订单追踪。
6. 进入主循环。

启动席位恢复原则：

- 自动寻标关闭：使用静态长短标的。
- 自动寻标开启：仅恢复“有持仓支撑”的历史归属标的；空方向保留 EMPTY 并在后续寻标。
- 启动时会对空席位做一次非阻塞寻标尝试。

## 交易日生命周期（7x24 运行）

状态流转：

- ACTIVE 到 MIDNIGHT_CLEANING 到 MIDNIGHT_CLEANED 到 OPEN_REBUILDING，再回到 ACTIVE。
- 重建失败进入 OPEN_REBUILD_FAILED，并按指数退避重试。

午夜清理按缓存域顺序执行：

1. 信号运行时域：停处理器、清队列、取消延迟验证、清指标缓存。
2. 行情域：重置订阅与行情缓存。
3. 席位域：清席位、重置自动换标状态、席位版本递增。
4. 订单域：重置订单执行运行态。
5. 风控域：重置风险冷却、日内亏损追踪、跨日冷却键、浮亏和牛熊证缓存。
6. 全局域：清交易门禁相关状态、清监控状态快照与交易标的集合。

开盘重建按缓存域逆序触发，核心流水线为：

- 加载交易日运行时快照。
- 同步席位与行情到监控上下文。
- 重建订单记录。
- 预热交易日历快照。
- 重建牛熊证风险缓存。
- 重建浮亏缓存。
- 恢复订单追踪。
- 展示账户与持仓。

任何阶段失败都不会放行交易，直到重建成功。

## 交易日历预热口径

重建时按“当前仍持仓买单的最早成交时间”推导需求窗口：

- 向后看：若无持仓则用回退窗口。
- 向前看：固定前瞻天数。
- 超出交易日接口最大回看天数直接抛错，阻断重建。

补齐策略：

- 优先用批量交易日接口按自然月分块补齐缺失日期。
- 接口不可用时按天回退查询。

## 关键业务口径

- 成本均价用于智能平仓；开仓成本与未平仓数量口径用于浮亏监控，两者不可混用。
- 做多与做空在订单记录、浮亏、冷却、席位、换标上都独立维护。
- 多监控标的并发处理，互不阻塞；共享订单系统但按监控归属和方向分账。
- 保护性清仓、末日清仓、常规卖出是三条不同业务路径，触发条件与后续处理不同。
