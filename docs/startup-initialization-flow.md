# 启动初始化流程图

本文档描述程序启动时的初始化流程，依据 `src/index.ts` 的实际执行顺序整理。

```
启动初始化流程（树状）
├─ 阶段1：配置与基础服务
│  ├─ 加载 .env.local
│  ├─ 解析交易配置
│  ├─ 创建 symbolRegistry
│  └─ validateAllConfig（静态校验，不触发行情订阅）
│     ├─ 失败 → 输出错误并退出
│     └─ 成功 → 进入启动门禁
├─ 阶段2：启动门禁（交易时段）
│  ├─ 校验交易日/交易时段/开盘保护期（dev 跳过）
│  ├─ 不满足 → 等待并重试（不继续初始化）
│  └─ 满足 → createConfig + 冷却追踪器 + 创建 trader
├─ 阶段3：账户/订单与席位确定（优先）
│  ├─ 获取账户与持仓（仅缓存，不订阅行情）
│  ├─ 账户/持仓有效?
│  │  ├─ 否 → 退出
│  │  └─ 是 → 获取全量订单（history + today）
│  └─ 席位确定（交易标的唯一来源）
│     ├─ 自动寻标关闭 → 配置标的写入席位（固定不变）
│     └─ 自动寻标开启
│        ├─ 候选标的有持仓 → 使用候选标的占位（按监控标的+方向归属）
│        └─ 无持仓 → warrantList 寻标占位（阻塞等待）
│           ├─ 成功 → 席位就绪
│           └─ 失败 → 席位为空，等待重试
├─ 阶段4：冷却恢复与核心模块
│  ├─ 冷却恢复（基于席位标的最后订单）
│  ├─ 初始化核心模块（市场监控 / 末日保护 / 信号处理）
│  └─ 初始化异步架构（指标缓存 / 买卖队列）
├─ 阶段5：席位相关初始化（席位就绪后）
│  ├─ 统一订阅 allTradingSymbols（监控标的 + 席位标的 + 持仓标的）
│  ├─ 批量获取行情 initQuotesMap
│  ├─ 运行期标的验证（监控+席位必需，持仓警告）
│  ├─ 输出账户/持仓（使用 initQuotesMap）
│  ├─ 创建 monitorContext（仅用席位标的缓存名称/行情）
│  ├─ 初始化牛熊证信息（席位标的）
│  ├─ 初始化订单记录（席位标的，基于全量订单）
│  └─ 初始化浮亏监控数据（席位标的）
└─ 阶段6：进入运行
   ├─ 注册延迟验证回调
   ├─ 启动买/卖处理器
   └─ 进入 mainProgram 每秒循环
```

说明：
- 交易标的唯一来源为席位；配置仅在自动寻标关闭时写入席位，运行期不再直接使用配置标的。
- 启动门禁确保仅在交易日且处于连续交易时段、且已过开盘保护期时继续初始化；dev 模式跳过启动与运行期门禁。
- 标的有效性验证拆分为“静态配置校验”和“席位就绪后的运行期校验”，避免在席位之前订阅。
- 席位未就绪时，席位相关初始化延后，寻标成功后再补齐。
- “全量订阅标的集合”包含监控标的、席位标的与持仓标的，统一在席位就绪后订阅。
- 全量订单用于持仓归属与订单记录初始化，不作为配置兜底来源。
