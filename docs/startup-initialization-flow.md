# 启动初始化流程图

本文档描述程序启动时的初始化流程，依据 `src/index.ts` 的实际执行顺序整理。

```
启动初始化流程（树状）
├─ 阶段1：配置与基础服务
│  ├─ 加载 .env.local
│  ├─ 解析交易配置
│  ├─ 创建 symbolRegistry
│  └─ validateAllConfig
│     ├─ 失败 → 输出错误并退出
│     └─ 成功 → createConfig + 冷却追踪 + 交易日志恢复
│        └─ 创建 trader / marketDataClient
├─ 阶段2：缓存与模块初始化
│  ├─ 计算并缓存全量订阅标的集合
│  ├─ 初始化 lastState 与持仓缓存
│  ├─ 初始化核心模块（市场监控 / 末日保护 / 信号处理）
│  ├─ 初始化异步架构（指标缓存 / 买卖队列）
│  └─ 批量获取行情 initQuotesMap
├─ 阶段3：监控上下文
│  ├─ 为每个监控标的创建 monitorContext
│  └─ 自动寻标?
│     ├─ 否 → 初始化牛熊证信息（配置标的）
│     └─ 是 → 延后刷新牛熊证信息
├─ 阶段4：账户与订单初始化
│  ├─ 获取账户与持仓
│  ├─ 账户/持仓有效?
│  │  ├─ 否 → 退出
│  │  └─ 是 → 获取全量订单
│  │     └─ 解析席位标的并 ensureSeatOnStartup
│  └─ 自动寻标?
│     ├─ 是 → 仅当有持仓才刷新订单记录
│     └─ 否 → 按配置标的刷新订单记录
│        └─ 初始化浮亏数据
└─ 阶段5：进入运行
   ├─ 注册延迟验证回调
   ├─ 启动买/卖处理器
   └─ 进入 mainProgram 每秒循环
```

说明：
- “全量订阅标的集合”包含监控标的与席位标的，用于后续订阅管理与批量行情获取。
- 自动寻标开启时，牛熊证信息与订单记录初始化逻辑会延后或条件化执行。
