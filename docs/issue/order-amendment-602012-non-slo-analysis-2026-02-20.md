# 订单改单报错 602012（非 SLO 场景）问题分析（2026-02-20）

## 1. 问题背景

在 `2026-02-20` 实盘日志中，出现两次相同错误：

- `openapi error: code=602012: Order amendment is not supported for this order type`

用户关注点是：当前系统配置和代码并不会下 `SLO`，为何仍会触发“订单类型不支持改单”。

---

## 2. 结论摘要

结论：**报错并非因为系统下了 `SLO` 订单**。  
真实原因是：`ELO` 订单在接近成交或状态快速变化阶段，网关侧已进入不可改单窗口；本地订单监控仍发起了 `replaceOrder`，被网关拒绝并返回 `602012`。

换言之，这是**改单时序与网关状态不一致导致的竞态问题**，不是“配置错成 SLO”。

---

## 3. 关键证据

## 3.1 系统确实使用的是 ELO，而非 SLO

### 代码约束

1. 订单配置类型仅允许 `LO | ELO | MO`：`src/types/signal.ts:20`
2. 配置映射只会输出 `LO/ELO/MO`：`src/core/trader/orderExecutor.ts:56-64`
3. 项目配置解析默认也是 `ELO/MO`：`src/config/config.trading.ts:327-333`

### 运行日志证据

1. `2026-02-20 10:14:11` 下单日志明确记录 `ELO`：`logs/system/2026-02-20.log:6355`
2. `2026-02-20 11:37:27` 下单日志明确记录 `ELO`：`logs/system/2026-02-20.log:20226`

---

## 3.2 两次 602012 的完整时序

## 案例 A（你指出的 6514-6515）

1. 触发改单：`logs/system/2026-02-20.log:6504`
2. 订单完全成交：`logs/system/2026-02-20.log:6513`
3. 改单失败 `602012`：`logs/system/2026-02-20.log:6514`
4. 外层捕获日志：`logs/system/2026-02-20.log:6515`

该案例说明：改单请求与成交推送几乎同时发生，出现了典型竞态。

## 案例 B（同日再次出现）

1. 触发改单：`logs/system/2026-02-20.log:21538`
2. 改单失败 `602012`：`logs/system/2026-02-20.log:21539`
3. 约 0.5 秒后完全成交：`logs/system/2026-02-20.log:21555`

该案例说明：即使在成交前，订单也可能已进入网关侧不可改单阶段，本地仍可能误判为可改单。

---

## 4. 代码链路分析

## 4.1 改单触发逻辑

订单监控每轮会遍历 `trackedOrders`，满足条件则调用 `replaceOrderPrice`：

- 主循环入口：`src/core/trader/orderMonitor.ts:641-709`
- 实际 API 调用：`src/core/trader/orderMonitor.ts:490-491`

## 4.2 本地“不可改单”判定范围

当前仅拦截：

1. 订单类型为 `MO`
2. 状态为 `WaitToReplace/PendingReplace`

对应代码：

- `src/core/trader/orderMonitor.ts:668-671`
- `src/constants/index.ts:145-153`

这意味着：只要本地状态仍是 `New/PartialFilled` 且类型是 `ELO`，就会继续尝试改单。

## 4.3 与成交回调并发

成交回调会在 `Filled` 后删除追踪：

- `src/core/trader/orderMonitor.ts:164-279`

但改价循环与回调是异步并发，存在窗口：

1. 循环先决定“要改”
2. 发起 `replaceOrder`
3. 同时收到/尚未处理 `Filled` 或网关内部状态切换
4. 网关拒绝改单（602012）

---

## 5. 为什么“非 SLO”也会返回“order type not supported”

从行为上看，网关返回的错误文案属于统一错误分类，并不等价于“客户端下单类型一定是 SLO”。  
在订单接近最终状态或处于网关不可改单阶段时，也可能返回同一错误码/文案。

因此，这里需要把 `602012` 理解为“**当前订单在网关侧不可执行改单**”，而不是“本地一定用了 SLO”。

---

## 6. 是否存在 Bug

结论：**存在实现层面的可改进缺陷**（但交易结果未被破坏）。

## 6.1 功能结果是否错误

两笔订单最终都正常成交并写入成交日志：

- `1209322078604365824`：`logs/trades/2026-02-20.json:79`
- `1209343034026631168`：`logs/trades/2026-02-20.json:459`

说明：资金与持仓主结果正确。

## 6.2 实现缺陷点

1. 本地改单可行性判定不够强，只依赖有限状态集合，无法覆盖网关瞬时不可改单窗口。
2. 改单循环与成交回调存在天然竞态，缺少更强的“发单前再确认”策略。
3. 错误日志可观测性不足：外层日志出现 `{}`，不利于回放定位（见 `logs/system/2026-02-20.log:6515`、`21540`）。

---

## 7. 影响评估

1. 对交易正确性影响：低（当前样本未出现错仓或重复成交）。
2. 对稳定性与噪声影响：中（会周期性产生 ERROR 日志，干扰故障告警）。
3. 对问题定位影响：中（外层错误对象信息丢失）。

---

## 8. 建议的修复方向（文档结论）

1. 在改单前增加更严格的订单状态再确认（可结合 `todayOrders/orderDetail` 快速确认）。
2. 对 `602012` 做明确的“不可改单”分类处理，避免将竞态误判为系统异常。
3. 强化日志：保留原始错误码、错误消息、订单当前本地状态、类型和关键时间戳。
4. 增加测试场景：`ELO` 在“接近成交 + 并发改单”下返回 `602012` 的回归用例。

---

## 9. 参考

- LongPort OpenAPI 文档（交易/改单）  
  https://open.longbridge.com/docs/trade/order/replace
- LongPort OpenAPI 文档（订单定义）  
  https://open.longbridge.com/docs/trade/trade-definition
