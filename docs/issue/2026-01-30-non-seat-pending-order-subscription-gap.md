# Issue: 非席位挂单标的未订阅

## 摘要
`collectAllQuoteSymbols()` 仅返回监控标的与席位标的。订阅更新逻辑基于该集合，
因此未在席位中的挂单标的不会被新增订阅。现有“避免退订”逻辑只会阻止移除，
无法补订缺失的挂单标的。

## 影响
当存在“非席位挂单”时（例如程序重启、席位清空或换标后遗留挂单），标的可能未订阅，
`getQuotes()` 无法从缓存获取行情，订单跟价逻辑拿不到实时价格，导致无法调整委托价、
超时策略失效或成交效率下降。

## 复现场景
- 程序重启时存在旧标的未成交订单。
- 席位为空或已切换至新标的，旧标的不在任何席位。
- `collectAllQuoteSymbols()` 不包含旧标的。
- `subscribeSymbols(added)` 不会新增该旧标的订阅。

## 期望行为
所有存在未成交订单的标的应纳入订阅集合（或显式订阅），仅在订单完全成交后退订；
若订单被撤销则不退订。

## 当前行为
订阅集合仅包含监控标的 + 席位标的（运行期再加持仓标的）；非席位挂单标的不会被新增订阅。

## 可行性与合理性分析
### 可行性
- 系统已有 `trader.getPendingOrders()` 获取未成交订单的能力，并带 30 秒 TTL 缓存，
  可用于构建“挂单标的集合”，不会每秒触发 API 请求。
- 行情客户端支持动态订阅/退订，且 `getQuotes()` 强依赖订阅状态，补订挂单标的符合现有模型。
- 启动阶段已通过 `fetchAllOrdersFromAPI()` 获取 history + today 全量订单，
  可直接按 `PENDING_ORDER_STATUSES` 过滤得到未成交订单标的，无需额外调用 API。
- 订单状态推送（WebSocket）可作为“订单订阅保留集”的更新依据，便于实现
  “仅完全成交才退订、撤销不退订”的规则。

### 合理性
- 订单监控对行情依赖强，未订阅会直接触发“无法获取行情”问题，属于功能性缺失。
- 订阅范围增加只覆盖未成交订单标的，规模有限，成本与收益比合理。
- 启动阶段复用全量订单数据可减少 API 调用与限流压力，符合既有缓存设计。

### 注意事项
- 订单成交后退订可能受 30 秒缓存 TTL 影响而延迟，但属于可接受范围。
- 若需要更及时退订，可在订单状态变更时清理挂单缓存（可选优化）。
- 按“仅完全成交才退订”的规则，撤销订单会保留订阅，可能造成订阅数增加；
  如需限制订阅规模，可增加上限或定期清理策略（不在本次要求内）。

## 修复方案（建议，系统性版本）
1. **引入“订阅原因模型”**  
   统一管理订阅来源，避免补丁式拼接集合：
   - `MONITOR`（监控标的）
   - `SEAT`（席位标的）
   - `POSITION`（持仓标的）
   - `ORDER_HOLD`（订单订阅保留集）
   订阅集合由上述原因的并集构建，退订仅当所有原因均不存在。

2. **启动阶段：用全量订单种子化 ORDER_HOLD**  
   启动完成并恢复订单追踪后，复用已获取的全量订单 `allOrders`，
   直接筛选未成交订单标的，写入 `ORDER_HOLD`（无需再调用 API）：
   `监控标的 + 席位标的 + 持仓标的 + ORDER_HOLD`。

3. **运行阶段：ORDER_HOLD 的系统性维护**  
   由订单生命周期驱动 `ORDER_HOLD`（建议使用 symbol -> orderIdSet）：
   - 下单/恢复追踪：加入对应 symbol 的 `ORDER_HOLD`
   - **完全成交**：移除该 orderId；若该 symbol 无剩余 orderId，才允许移出
   - **撤销/拒绝**：不移除（满足“撤销不退订”规则）

4. **订阅计算与退订规则**  
   主循环每次计算订阅集合时统一基于“订阅原因模型”做 diff：
   - 新增：`subscribeSymbols(added)`  
   - 移除：仅当 `MONITOR/SEAT/POSITION/ORDER_HOLD` 均不存在时退订
   - 仅完全成交才可能导致 `ORDER_HOLD` 为空，从而触发退订

## 涉及代码
- `src/utils/helpers/quoteHelpers.ts`
- `src/index.ts`（启动阶段订阅集合）
- `src/main/mainProgram/index.ts`（运行阶段订阅集合）
- `src/core/trader/orderMonitor.ts`（订单状态驱动 ORDER_HOLD 更新）
- `src/types/index.ts` / `src/main/*`（新增订阅原因模型状态）
- `src/core/trader/orderCacheManager.ts`（可选：成交后清缓存以加速退订）

## 备注
文档记录；如需落地可按上述方案改动。
