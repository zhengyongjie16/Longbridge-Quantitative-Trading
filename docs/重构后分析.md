# 主循环重构对比分析（ebc1fc7 vs 08e2835）

## 范围与基线
- 基线提交：`ebc1fc7`（新架构） vs `08e2835`（旧架构）
- 重点覆盖：主循环与信号链路、延迟验证与指标缓存、交易处理器、风险与执行链路

## 总体结论
`ebc1fc7` 将“信号→验证→风控→执行”的同步链路拆分为“主循环同步产出 + 异步任务处理”，提升主循环稳定性与吞吐，但引入**异步时序差异**与**数据来源差异**。`08e2835` 仍在主循环内同步处理，时序更一致但耦合更高。

---

## 1. 入口与主循环 `src/index.ts`

### 关键差异
1) **架构切换**
- `08e2835`：主循环内完成信号生成、延迟验证、风险检查、订单执行。
- `ebc1fc7`：主循环只生成信号并分流；延迟验证与交易执行通过 `DelayedSignalVerifier` + `TradeTaskQueue` + `TradeProcessor` 异步处理。

2) **信号链路调整**
- `08e2835`：`SignalVerificationManager` 记录验证历史 + 验证，并直接合并进本轮交易信号。
- `ebc1fc7`：延迟信号加入验证器（`setTimeout`），验证通过后推入队列；立即信号也推入队列。

3) **交易时段切换处理**
- `ebc1fc7`：退出交易时段时**清理所有待验证信号**，避免收盘后缺少缓存数据导致验证失败日志。
- `08e2835`：无显式清理逻辑（待验证信号可在后续继续验证）。

4) **指标快照空值处理**
- `ebc1fc7`：若 `buildIndicatorSnapshot()` 返回 `null`，会提前退出本轮处理。
- `08e2835`：移除空值保护，若出现 `null` 快照可能导致后续逻辑异常。

5) **风险检查与执行时机**
- `ebc1fc7`：风险检查与订单执行在 `TradeProcessor` 中异步处理。
- `08e2835`：风险检查与执行在主循环同步完成。

### 行为影响
- 异步处理可能导致**风险检查时点晚于信号生成时点**（尤其在队列积压时）。
- 交易时段边界信号可能被**直接清理**（`ebc1fc7`），而旧版可能继续验证。

---

## 2. 延迟验证与指标缓存

### `ebc1fc7`（新）
- 使用 `DelayedSignalVerifier`（`setTimeout`）+ `IndicatorCache`（环形缓冲区）。
- 验证时从缓存中按 `T0/T1/T2` 时间点匹配快照（±5 秒容忍）。
- 对缓存快照进行深拷贝，避免对象池释放影响历史数据。

### `08e2835`（旧）
- 使用 `SignalVerificationManager`：
  - 信号自身维护 `verificationHistory`。
  - 在 `triggerTime-5s ~ +15s` 窗口内记录指标历史。
  - 满足 `triggerTime+15s` 时由主循环验证。

### 行为影响
- **数据来源差异**：新架构使用全局缓存的“最近点快照”，旧架构使用“信号私有历史窗口内的连续采样”。边界时点的通过/失败结果可能不同。

---

## 3. 交易处理器与任务队列

### `ebc1fc7`（新增）
- `TradeTaskQueue`：FIFO 队列，任务入队即触发调度。
- `TradeProcessor`：`setImmediate` 异步循环消费任务，统一释放信号对象池。

### `08e2835`（旧）
- 无独立交易处理器与队列，逻辑同步执行在主循环。

### 行为影响
- **时序差异**：信号执行不再与生成同一时刻。
- **数据一致性风险**：风险检查依赖缓存行情与当前时间，可能与信号触发时点偏移。

---

## 4. 信号处理 / 风控 / 执行链路

### `src/core/signalProcessor/index.ts`
1) **卖出数量计算的订单过滤**
- `ebc1fc7`：`getBuyOrdersBelowPrice(currentPrice, direction, symbol)`，按标的过滤。
- `08e2835`：删除 `symbol` 参数，仅按方向过滤。

**影响**：多标的场景下可能混入其他标的订单，导致卖出数量计算偏大或不准确（`08e2835` 风险更高）。

### `src/core/orderRecorder/*`
1) **按标的过滤退化**
- `08e2835` 的 `getBuyOrdersBelowPrice` 改为遍历方向内的全部订单再按价格过滤，**不再按标的过滤**。
- `ebc1fc7` 保持按标的 O(1) 查询。

**影响**：多标的情况下可能将无关标的订单纳入智能平仓计算，改变卖出数量。

2) **`getBuyOrdersForSymbol` 由 O(1) 变为过滤列表**
- `08e2835` 改为从方向列表中过滤 symbol，性能与准确性受影响（但次要）。

### `src/core/risk/index.ts`
仅移除了 `initializeWarrantInfo` 的 `symbolName` 参数（日志显示），无核心逻辑变化。

### `src/core/trader/orderExecutor.ts`
仅改为使用 `symbol` 直接输出日志，不再格式化中文名称显示，无行为变化。

---

## 5. 问题清单与确认点

### P1（高风险）
1) **异步执行导致时序偏移（ebc1fc7）**
- 影响：风险检查与订单执行时点晚于信号触发时点，可能影响“买入间隔/末日保护窗口/交易时段”等时间敏感逻辑。
- 触发条件：队列积压、主循环负载高、交易密集。
- 确认点：是否接受“处理时刻”而非“触发时刻”作为风险检查依据？

2) **延迟验证数据来源差异（ebc1fc7 vs 08e2835）**
- 影响：T0/T1/T2 验证结果可能不同（缓存最近点 vs 信号私有历史）。
- 触发条件：指标波动快、数据采样抖动、边界时间点。
- 确认点：是否接受该差异？若必须保持旧行为，需要统一采样策略。

3) **多标的智能平仓计算可能混入其他标的订单（08e2835）**
- 影响：卖出数量过大或错误，导致过度平仓或误判。
- 触发条件：多监控标的同时交易、同方向有订单记录。
- 确认点：是否允许仅按方向过滤？若不允许，应恢复按 `symbol` 过滤。

### P2（中风险）
4) **交易时段结束清理待验证信号（ebc1fc7）**
- 影响：跨时段触发的延迟信号被直接丢弃，旧版可能保留。
- 触发条件：收盘前延迟信号尚未验证完成。
- 确认点：是否要求“跨时段信号清零”？若需要保留，需调整清理策略。

### P3（低风险）
5) **`buildIndicatorSnapshot` 返回 `null` 时缺少保护（08e2835）**
- 影响：异常路径下可能继续执行导致错误或异常日志。
- 触发条件：K 线数据异常/空数组/指标计算失败。
- 确认点：是否保证指标计算始终成功？若不保证，建议补回空值保护。

6) **日志展示差异（risk/orderExecutor）**
- 影响：仅日志可读性变化，无业务行为变化。
- 确认点：是否需要保留中文名称日志显示。

---

## 建议验证（可选）
- 压测场景下的队列积压与风险检查时点偏移。
- 多标的并行交易时，智能平仓是否严格按标的过滤。
- 交易时段切换前后的延迟信号处理策略。

