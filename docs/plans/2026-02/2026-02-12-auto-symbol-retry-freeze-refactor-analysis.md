# 自动寻标失败放行与当日冻结重构二次分析（2026-02-12）

## 1. 背景与目标

本次文档是对既有重构方案的二次详尽审视，目标是确认方案是否满足以下硬约束：

1. 逻辑正确，逐条满足业务需求。
2. 改造是系统性的，不是兼容性补丁或局部 if 分支堆叠。
3. 启动寻标与换标寻标行为一致，具备统一策略源。
4. 席位为空/冻结时，信号链路行为可预测、可观测、可验证。

---

## 2. 业务需求拆解（R1-R5）

### R1 启动放行

- 启动阶段自动寻标失败（无候选）时，不再阻断进程。
- 系统允许进入主循环，但失败方向席位保持空。

### R2 配置验证放行

- 配置校验仍包含席位标的相关验证。
- 若该监控标的启用自动寻标，允许席位为空，不因空席位阻断启动。

### R3 启动失败重试与冻结

- 启动后持续重试寻标，重试间隔改为 10 分钟。
- 增加最大失败次数。
- 超过 3 次失败后当日冻结该席位，不再查询，直到下一交易日开盘重建再恢复寻标。

### R4 换标失败重试与冻结

- 换标场景使用与初始化同一重试间隔（10 分钟）。
- 寻标连续失败 3 次同样冻结到次日。

### R5 空席位信号治理与日志

- 席位为空时不生成/不下发有效交易信号。
- 日志需明确区分：席位为空、席位已冻结。

---

## 3. 现状代码复核结论（基于当前实现）

### 3.1 启动阻断问题（R1 冲突点）

`src/main/startup/seat.ts` 中 `waitForSeatsReady` 采用 `while(true)`，仅当所有自动寻标席位 READY 才返回。  
结果：任一席位持续无候选时，启动流程无限等待，主程序无法进入交易循环。

结论：R1 当前不满足，且是主阻断点。

### 3.2 配置验证与运行时验证（R2 现状）

- `src/config/config.validator.ts`：自动寻标关闭时强校验 `longSymbol/shortSymbol`；开启时不强制。该点与 R2 一致。
- `src/index.ts` 运行时 symbol 校验输入构建中，席位 symbol 为空会被 `pushSymbol` 跳过，因此不会因空席位报错。

结论：R2 基本已具备，但应显式化"静态模式与自动寻标模式"的运行时校验口径，避免隐式放行导致歧义。

### 3.3 寻标重试机制（R3/R4 冲突点）

- 当前重试常量 `AUTO_SYMBOL_SEARCH_COOLDOWN_MS = 30_000`，初始化寻标和运行时寻标共用。
- 无失败计数、无当日冻结状态、无上限机制。
- 换标失败后席位变 EMPTY，后续靠运行时 tick 再寻标，但同样无失败上限。

结论：R3/R4 当前均不满足。

### 3.4 信号链路（R5 半满足）

- 策略层通过 `if (longSymbol)` / `if (shortSymbol)`，空席位方向不生成信号（行为正确）。
- 但日志层多为"席位不可用"泛化文案，未区分"空"与"冻结"。

结论：R5 的行为部分满足，日志可观测性不满足。

---

## 4. 可行性分析

## 4.1 技术可行性（高）

可行性高的原因：

1. 现有席位体系已集中在 `SymbolRegistry + AutoSymbolManager`，具备单点改造基础。
2. 启动、运行时、换标都已通过席位状态机协作，重试策略可统一接入。
3. 生命周期模块已存在跨日清理与开盘重建，天然适配"当日冻结、次日解冻"。
4. 信号分流和处理器均已有席位校验入口，日志治理无需重构交易核心策略。

## 4.2 业务可行性（高）

1. "失败放行 + 空席位阻断该方向交易"符合系统风险最小化原则：不因单方向失败拖垮全局。
2. "3 次失败后当日冻结"可避免无效高频查询，降低 API 压力与噪音日志。
3. "次日重置"符合交易日语义，避免永久冻结导致策略失活。

## 4.3 实施风险（可控）

1. 若冻结语义散落多处，会再次退化为补丁式改造。  
   处置：统一封装"寻标重试策略引擎"。
2. 若仅改启动不改换标，会出现双标准。  
   处置：初始化寻标与换标失败都走同一失败计数。
3. 若仅改策略层不改延迟验证/处理器日志，观测口径不一致。  
   处置：统一不可用原因解析函数，复用到三层日志。

---

## 5. 合理性分析（为什么该方案符合业务）

### 5.1 与交易业务目标一致

- 目标是"持续运行+方向自治"，不是"所有方向同时就绪才可运行"。
- 空席位不产生交易，天然形成方向级熔断，不放大风险。

### 5.2 与自动寻标业务语义一致

- 自动寻标的本质是"可得即用，不可得则等待下一可用窗口"，而非"不可得即全局停机"。
- 当日冻结可视为"策略保护阈值"，防止反复无意义尝试。

### 5.3 与生命周期设计一致

- 既有 7x24 生命周期提供跨日重建契机。
- 冻结到次日的规则可以自然挂接到 `midnightClear + openRebuild`，不引入额外时钟轮询复杂度。

---

## 6. 完整性评估（是否详细且完整）

本次分析覆盖了全链路并形成闭环，完整性如下：

1. 启动链路：覆盖（阻断点、放行点、启动后重试接管）。
2. 配置与运行时验证：覆盖（静态/动态模式口径）。
3. 自动寻标与换标：覆盖（统一重试、统一冻结、同常量来源）。
4. 席位状态模型：覆盖（失败计数、冻结元数据、跨日重置）。
5. 信号链路：覆盖（生成、分流、延迟回调、买卖处理器日志）。
6. 生命周期：覆盖（当日冻结、次日恢复）。
7. 可观测性：覆盖（原因分类日志、去重日志建议）。
8. 验证与验收：覆盖（场景矩阵 + 必跑检查）。

结论：分析维度完整，可直接进入实施阶段。

---

## 7. 系统性重构设计（目标架构）

## 7.1 统一策略源：Seat Search Retry Policy

新增统一策略模块（建议放入 `autoSymbolManager`）管理以下逻辑：

- `retryIntervalMs = 600_000`（10 分钟）
- `maxFailuresPerDay = 3`
- 失败计数递增规则
- 冻结判定规则
- 成功后状态复位规则

禁止在 `startup/seat.ts`、`autoSearch.ts`、`switchStateMachine.ts` 各自实现一套独立重试逻辑。

## 7.2 状态模型增强（保持席位为空语义）

建议不新增 `SeatStatus` 枚举值（避免全链路扩散修改），保持 `EMPTY` 表示空位，新增冻结元数据：

- `searchFailCountToday`
- `frozenTradingDayKey`（当日冻结标记）

语义：

- 空且未冻结：可重试。
- 空且冻结：当日不可再寻标。
- 次日重建清空冻结信息并恢复可重试。

## 7.3 启动流程重构

将当前"阻塞等待所有席位 READY"改为：

1. 启动恢复历史席位（已有逻辑）。
2. 对空席位执行一次尝试寻标（可选，受开盘延迟约束）。
3. 不再 `while(true)` 阻塞。
4. 失败方向保持 EMPTY 并进入运行时重试节奏。

这样满足 R1，同时不会影响已成功方向的交易启动。

## 7.4 换标流程重构

换标流程中的"寻标失败"进入同一失败计数体系：

- 第 1/2 次失败：保持 EMPTY，等待 10 分钟后重试。
- 第 3 次失败后：标记当日冻结，不再查询。

换标失败后与初始化失败后的恢复行为保持一致，满足 R4。

## 7.5 验证口径重构（静态/动态）

运行时 symbol 校验口径建议显式化：

- 自动寻标关闭：席位 symbol 为必需（异常为空应报错）。
- 自动寻标开启：席位 symbol 可为空，空时放行。

该改造不是变更业务规则，而是把隐式行为改成显式规则，满足 R2。

## 7.6 信号与日志重构

统一新增不可用原因解析函数（可放 `autoSymbolManager/utils.ts`）：

- `SEAT_EMPTY`
- `SEAT_FROZEN_TODAY`
- `SEAT_SEARCHING`
- `SEAT_SWITCHING`

复用位置：

1. `signalPipeline`（分流前）
2. `index.ts` 延迟验证回调
3. `buyProcessor` / `sellProcessor`

要求：

- 同一原因文案一致。
- 增加"状态变化触发日志"或时间窗去重，防止每秒刷屏。

---

## 8. 文件级改造清单（实施蓝图）

### 8.1 常量与类型

- `src/constants/index.ts`
  - 更新重试间隔到 10 分钟。
  - 增加失败上限常量（3）。
- `src/types/index.ts`
  - 扩展 `SeatState` 冻结与失败计数字段。

### 8.2 寻标策略与状态管理

- `src/services/autoSymbolManager/utils.ts`
  - 新增冻结判定与失败计数 helper。
  - 新增席位不可用原因 helper。
- `src/services/autoSymbolManager/autoSearch.ts`
  - 接入统一重试与冻结策略。
- `src/services/autoSymbolManager/switchStateMachine.ts`
  - 换标寻标失败接入同策略。

### 8.3 启动链路

- `src/main/startup/seat.ts`
  - 去除全席位阻塞等待。
  - 启动仅做非阻塞尝试并返回。
- `src/main/lifecycle/loadTradingDayRuntimeSnapshot.ts`
  - 接入新重试间隔常量（与运行时一致）。

### 8.4 验证与信号链路

- `src/index.ts`
  - 运行时 symbol 校验按 auto-search 开关区分必需性。
  - 延迟验证回调日志使用统一原因。
- `src/main/processMonitor/signalPipeline.ts`
  - 席位不可用日志改为原因分类。
- `src/main/asyncProgram/buyProcessor/index.ts`
- `src/main/asyncProgram/sellProcessor/index.ts`
  - 席位不可用日志改为原因分类。

### 8.5 跨日重置

- `src/main/lifecycle/cacheDomains/seatDomain.ts`
  - 午夜清理时重置失败计数与冻结字段，保证次日恢复。

---

## 9. 状态机定义（重构后）

方向级状态机（每个 monitor + direction 独立）：

1. READY -> SWITCHING（换标触发）
2. SWITCHING -> READY（换标成功）
3. SWITCHING -> EMPTY（换标失败）
4. EMPTY -> SEARCHING（发起寻标）
5. SEARCHING -> READY（寻标成功，清零失败计数）
6. SEARCHING -> EMPTY（失败计数 +1）
7. EMPTY(失败>=3) -> EMPTY+FROZEN（当日冻结）
8. 次日重建：EMPTY+FROZEN -> EMPTY（解冻，可重新 SEARCHING）

---

## 10. 验证矩阵（必须执行）

## 10.1 自动化检查

- `npm run lint`
- `npm run type-check`

## 10.2 关键场景回归

1. 启动无候选：程序放行，失败方向席位为空。
2. 启动后重试：每 10 分钟重试一次。
3. 连续失败 3 次：当日冻结，不再调用寻标 API。
4. 次日开盘重建：冻结解除，重新寻标。
5. 换标寻标失败：同样按 10 分钟与 3 次冻结规则。
6. 席位为空日志：明确"席位为空"。
7. 冻结席位日志：明确"席位已冻结（当日）"。
8. 非冻结空席位恢复：成功寻标后恢复 READY 并可生成信号。

---

## 11. 方案结论

1. 方案可行性：高（代码结构支持，改造边界明确）。
2. 方案合理性：高（符合业务语义与风险控制目标）。
3. 详细性与完整性：达标（需求、状态、流程、文件、验证全覆盖）。
4. 实施建议：按"策略先行、链路接入、日志统一、回归验证"四步落地，避免一次性大改引入不可控风险。

---

## 12. 实施顺序建议（最小风险）

1. 先改类型与统一策略模块（不改业务行为）。
2. 再改启动非阻塞与运行时重试接管。
3. 再改换标失败计数并接入冻结。
4. 最后统一日志与验证口径，执行完整回归。

该顺序可以在每一步都保持系统可运行、可验证、可回滚。
