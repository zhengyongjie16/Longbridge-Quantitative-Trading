# Core Program Business Logic

港股量化交易系统的核心业务逻辑参考。

**核心机制**：多监控标的并行处理 → 技术指标生成信号 → 信号分流（立即/延迟） → 异步交易处理 → 风险检查 → 牛熊证双向交易 → 智能平仓 + 浮亏保护 + 末日保护

---

## 使用说明

### 何时使用

1. 用户询问业务逻辑（信号生成、卖出策略等）
2. 验证代码是否符合业务规则
3. 修改交易功能前了解规则
4. 调试业务问题

### 关键概念区分

| 概念对 | 区别 |
|--------|------|
| 成本均价 vs 开仓成本 R1 | 前者是加权平均价格（用于智能平仓判断），后者是成本总和（用于浮亏监控） |
| 监控标的 vs 交易标的 | 前者生成信号(恒指)，后者执行交易(牛熊证) |
| 静态交易标的 vs 席位标的 | 关闭自动寻标时按配置固定交易标的；开启自动寻标后按席位动态占位决定交易标的 |
| 智能平仓 vs 全仓清仓 | 仅卖盈利部分 vs 全部卖出 |
| 正常卖出 vs 保护性清仓 | 前者按智能平仓/全仓规则处理，后者无条件清仓 |
| 立即信号 vs 延迟信号 | 无需验证直接执行 vs 需等待验证后执行 |
| ELO vs MO | 增强限价单(正常交易) vs 市价单(保护性清仓) |
| 席位为空 vs 行情未就绪 | 前者无标的占位（阻断该方向交易）；后者已占位但无首个行情（买入信号丢弃，卖出可尝试） |

---

## 1. 交易信号

### 1.1 信号类型

| 信号动作 | 说明 |
|---------|------|
| BUYCALL | 买入做多方向的交易标的（通常为牛证） |
| SELLCALL | 卖出做多方向的交易标的（通常为牛证） |
| BUYPUT | 买入做空方向的交易标的（通常为熊证） |
| SELLPUT | 卖出做空方向的交易标的（通常为熊证） |

### 1.2 信号配置格式

信号条件支持"多条件组合 + 多组任选"的表达方式：

- **组内规则**：一组内包含多个指标条件，可配置"至少满足其中若干项"，否则默认全部满足
- **组间规则**：多组之间为"满足任意一组即可触发信号"
- **指标与比较**：支持 RSI/PSY（可指定周期）、MFI、K/D/J；支持阈值的大于/小于判断（阈值可为负数）。MACD/DIF/DEA/EMA 仅用于延迟验证
- **对象池管理**：信号对象使用对象池管理，减少内存分配开销

### 1.3 卖出信号生成条件

卖出信号生成前先检查该方向订单记录中是否有买入订单；无买入订单则不生成该方向卖出信号。

### 1.4 信号分流机制

信号生成后根据验证配置分为两类：

| 信号类型 | 条件 | 处理方式 |
|---------|------|---------|
| 立即信号 | 延迟时间为 0 或验证指标为空 | 直接推入买入/卖出任务队列 |
| 延迟信号 | 延迟时间大于 0 且验证指标非空 | 推入延迟验证器，验证通过后再推入对应队列 |

**席位校验**：信号分流前需通过席位校验：
- 席位状态必须为 READY
- 信号席位版本必须与当前席位版本匹配
- 信号标的必须与席位当前标的匹配
- 不满足条件的信号会被丢弃并释放回对象池

---

## 2. 延迟验证机制

### 2.1 基本概念

延迟验证用于确认趋势持续性后再执行交易，防止假信号。验证器使用定时器自行计时。

- **延迟时间**：买入和卖出分别配置，范围 0-120 秒
- **验证指标**：可配置 K/D/J/MACD/DIF/DEA，以及 EMA（可指定周期）、PSY（可指定周期）
- **判断条件**：若延迟时间为 0 或验证指标为空，则信号立即执行

### 2.2 验证流程

**时间点定义**：T0 为延迟时间结束时刻（信号加入验证器时已确定的未来时刻，即信号触发时间加延迟时间），T1 为 T0 后 5 秒，T2 为 T0 后 10 秒。**初始值**：信号**生成**时刻写入的指标快照（存储在信号对象的指标快照中），验证时用 T0、T1、T2 三点的缓存数据与该初始值比较（都高于为上涨趋势，都低于为下跌趋势）。

**执行时机**：信号加入验证器后，创建定时器，在 T2（即 T0 + 10 秒）时执行验证（确保 T2 数据已记录）。

**验证规则**：

| 信号类型 | 趋势要求 | 验证条件 |
|---------|---------|---------|
| BUYCALL | 上涨趋势 | T0、T1、T2 的值都高于初始值 |
| BUYPUT | 下跌趋势 | T0、T1、T2 的值都低于初始值 |
| SELLCALL | 下跌趋势 | T0、T1、T2 的值都低于初始值 |
| SELLPUT | 上涨趋势 | T0、T1、T2 的值都高于初始值 |

**验证结果**：
- 所有验证指标在所有 3 个时间点都满足条件 → 验证通过，推入对应队列执行
- 任一指标在任一时间点不满足或缺少时间点数据 → 验证失败，丢弃信号并释放对象

### 2.3 指标缓存机制

指标缓存使用环形缓冲区存储每秒的指标快照。存储时对快照进行深拷贝，确保数据独立于对象池。

- **时间容忍度**：±5 秒（验证时查找时间点数据允许的误差范围）
- **缓存容量**：取买入和卖出延迟时间的较大值，再加 25 秒
- **清理时机**：退出连续交易时段时清理所有待验证信号；标的切换/方向取消时清理对应待验证信号

---

## 3. 订单记录策略

### 3.1 记录时机

- **启动时**：拉取全量订单（历史与当日、按订单编号去重）后，按**当前席位标的**逐标的筛选该标的的买卖订单并应用过滤算法；静态模式席位为配置标的，自动寻标模式席位由订单归属与持仓推断或寻标得到
- **交易后**：本地更新，不调 API
- **保护性清仓后**：清空订单记录，重新计算浮亏数据
- **待成交卖出追踪**：提交卖出订单时登记待成交卖出及关联买入订单 ID；完全成交或撤单时移除（撤单时返回的记录状态标记为已取消），部分成交时更新；用于智能平仓防重（避免同一笔买入被重复计入可卖数量）

### 3.2 过滤算法

**目标**：识别未被完全卖出的买入订单，为智能平仓和浮亏监控提供准确数据

**执行步骤**：

1. **排序**：将所有卖出订单按成交时间从旧到新排序

2. **分类**：
   - 新增买入订单（M0）：成交时间 > 最新卖出订单时间的买入订单（无条件保留）
   - 候选订单：成交时间 ≤ 最新卖出订单时间的买入订单（需要过滤）

3. **逐个处理卖出订单**（必须按时间顺序，不可乱序）：
   - 每轮从上一轮结果中取成交时间小于当前卖出时间的买入订单（第一轮时，上一轮结果指候选订单中成交时间小于第一笔卖出时间的买入订单）
   - 比较买入总量与卖出数量：
     - 卖出数量 ≥ 买入总量或买入订单列表为空：全部卖出，这些订单不保留，仅保留时间间隔内的买入订单
     - 卖出数量 < 买入总量：使用低价优先整笔消除策略扣减卖出数量
   - 扣减策略：按成交价从低到高、成交时间从早到晚、订单编号字典序排序，整笔消除订单，不拆分订单
   - 从原始候选订单中获取时间间隔内的订单（开区间）
   - 合并得到本轮结果

4. **最终结果**：新增买入订单（M0）+ 最后一轮过滤结果

**关键约束**：
- 必须按时间顺序从旧到新处理卖出订单
- 每轮过滤基于上一轮的结果（累积过滤）
- 时间间隔订单必须从原始候选订单获取，而非上一轮结果
- 使用低价优先整笔消除策略，不拆分订单

### 3.3 本地记录更新

- 买入后：新增订单记录
- 卖出后：使用低价优先整笔消除策略扣减卖出数量；待成交卖出的登记与移除见 6.1
- 保护性清仓：清空所有订单记录

---

## 4. 卖出策略

### 4.1 卖出信号处理流程

卖出信号不经过风险检查，直接处理卖出数量计算。**卖出委托价**以执行时行情为准，由卖出处理环节写入，不使用信号生成时的快照价。

1. **识别末日保护清仓信号**：信号原因包含"末日保护程序"则无条件执行，使用全部可用持仓数量

2. **正常卖出信号处理**：根据智能平仓开关决定处理方式

### 4.2 智能平仓逻辑

| 开关状态 | 行为 |
|---------|------|
| 关闭 | 直接清仓（使用全部可用持仓数量） |
| 开启 | 先判断整体盈亏，再决定卖出策略 |

**智能平仓规则**（开启时）：

1. **获取成本均价**：计算当前持有订单的加权平均成本
2. **判断整体盈亏**：
   - 整体盈利（当前价 > 成本均价）→ 卖出全部订单
   - 整体未盈利（当前价 ≤ 成本均价）→ 仅卖出买入价低于当前价的盈利订单
3. **防重与截断**：
   - 排除已被待成交卖出订单占用的买入订单
   - 卖出数量取可卖数量与可用持仓量的较小值
   - 超出时按买入价从低到高整笔选单（不拆分订单）

**特殊情况**：
- 订单记录不可用 → 不执行卖出（保持持仓）
- 无可卖订单或全部被待成交占用 → 不执行卖出（保持持仓）

**示例**：
- 场景1：当前价 1.20，成本均价 1.15（整体盈利）→ 卖出全部可用持仓
- 场景2：当前价 1.20，成本均价 1.25（整体未盈利）→ 仅卖出买入价 < 1.20 的盈利订单

### 4.3 成本价类型

| 类型 | 计算方式 | 用途 |
|------|---------|------|
| 成本均价 | Σ(买入价 × 买入量) / Σ(买入量) | 智能平仓整体盈亏判断 |
| 开仓成本 R1 | Σ(买入价 × 买入量) | 浮亏监控 |

---

## 5. 风险管控

### 5.1 买入信号检查顺序

买入信号先经**风险检查冷却**（同标的同动作类型 10 秒内仅允许一信号进入下述检查，冷却期内跳过；BUYCALL 和 BUYPUT 共享同一冷却键，SELLCALL 和 SELLPUT 共享同一冷却键），再依次通过以下 6 项检查（任一失败则拒绝）：

1. **交易频率限制**：同方向买入间隔 ≥ 配置时间（默认 60 秒）

2. **清仓冷却**：保护性清仓后冷却期内拒绝买入（冷却时长可配置：按分钟数/半日/一日等；跨日后清理半日/一日模式的冷却键）

3. **买入价格限制**：当前价格 ≤ 最新买入订单价格（防止追高）

4. **末日保护检查**：收盘前 15 分钟内拒绝买入（正常日 15:45-16:00，半日 11:45-12:00）

5. **牛熊证风险检查（阈值可配置）**：
   - 监控标的价格必须 ≥ 1（过小视为异常，拒绝买入）
   - 牛熊证当前价必须 > 0.015（过低拒绝买入）
   - 牛证：距离回收价百分比必须 > 0.5%（低于则拒绝买入）
   - 熊证：距离回收价百分比必须 < -0.5%（高于则拒绝买入）

6. **基础风险检查**：
   - **数据来源**：必须实时调用 API 获取账户快照与持仓信息（不使用缓存参与此步骤判定）
   - 浮亏检查：当浮亏 ≤ -"单日最大亏损"阈值时，拒绝该方向买入
   - 持仓市值限制：单标的持仓市值不能超过"最大持仓市值"阈值
   - 港币可用现金 ≥ 买入金额

（上述"风险检查冷却"与"清仓冷却"为不同机制：前者限流进入检查的节奏，后者为保护性清仓后的买入禁止期。）

### 5.2 数据获取策略

| 操作 | 数据来源 |
|------|---------|
| 买入 | 必须从 API 获取最新数据，不使用缓存 |
| 卖出 | 可使用缓存数据 |

### 5.3 浮亏监控

**计算口径**：浮亏为当前市值减开仓成本（即 R2 减 R1）
- **R1（开仓成本）**：Σ(买入价 × 买入量)，即所有未平仓买入订单的成本总和
- **N1（持仓数量）**：Σ(买入量)，即所有未平仓买入订单的数量总和
- **R2（当前市值）**：当前价 × N1
- **浮亏**：R2 - R1（负值表示亏损）
- **当日已实现盈亏偏移**：系统根据当日已实现盈亏对 R1 做调整。计算公式：当日已实现盈亏 = 总卖出额 - (总买入额 - 未平仓买入成本)。当日已实现亏损时（负值），调整后 R1 = max(0, 基础 R1 - 偏移值)，使 R1 增大，浮亏口径相对宽松，避免已亏损后因短期波动过早触发清仓

**更新时机**：启动时、交易后、价格变化时。启动时基于全量订单计算当日已实现盈亏偏移；交易后更新偏移并刷新浮亏数据

### 5.5 保护性清仓

**触发条件**：当浮亏 < -"单标的最大浮亏保护阈值"（即亏损金额超过阈值）时触发

**执行流程**：
1. 创建清仓信号（订单类型按全局"清仓订单类型"配置自动选择）
2. 执行清仓订单
3. 清空订单记录
4. 重新计算浮亏数据（开仓成本与持仓量归零）

**与正常卖出区别**：保护性清仓无条件全部卖出，清空所有订单记录

**清仓冷却追踪**：保护性清仓发生后记录清仓事件并进入冷却期，冷却期内买入在"清仓冷却"项被拒绝。

### 5.6 末日保护

| 交易日类型 | 拒绝买入时段 | 撤销未成交买入订单 | 自动清仓时段 |
|-----------|-------------|-------------------|-------------|
| 正常交易日 | 15:45-16:00 | 首次进入时执行一次 | 15:55-15:59 |
| 半日交易日 | 11:45-12:00 | 首次进入时执行一次 | 11:55-11:59 |

清仓信号无条件执行，不受智能平仓影响。

### 5.7 距回收价触发清仓（仅静态交易标的模式）

当未启用自动寻标（即交易标的为静态配置）时，系统会在监控标的价格发生显著变化时，额外检查"距回收价百分比"是否触发清仓：

- **触发门槛**：
  - 牛证：距回收价百分比 ≤ 0.3% 触发
  - 熊证：距回收价百分比 ≥ -0.3% 触发
- **数量口径**：仅在"可用持仓数量大于 0"时触发并清仓
- **委托方式**：固定使用 ELO（增强限价单），以提升成交概率并避免过度滑点
- **清仓后处理**：清空该标的订单记录，并刷新浮亏监控数据（避免旧成本与数量残留）

---

## 6. 订单管理

### 6.1 订单监控机制

使用 WebSocket 订阅订单状态变化。**提交卖出订单时**登记待成交卖出及关联买入订单标识（存储在待成交卖出追踪表中），用于智能平仓防重；部分成交时更新已成交数量；完全成交或撤单时移除该登记（撤单时返回的记录状态标记为已取消）。订单完全成交时：
1. 使用实际成交价更新本地订单记录
2. 若为卖出订单则标记待成交卖出为已成交并移除登记
3. 标记需要刷新的数据（账户、持仓、浮亏）
4. 主循环统一刷新缓存数据（通过刷新门禁机制确保异步处理器等待刷新完成）

**待成交卖出防重机制**：智能平仓计算可卖数量时，会排除已被待成交卖出订单占用的买入订单（通过关联买入订单 ID 集合判断），避免同一笔买入订单被重复计入可卖数量。卖出订单提交时携带关联买入订单 ID 列表，成交或撤单后移除登记。

**恢复期处理**：启动时若发现未完成的卖出订单，会根据订单数量和方向，从当前买入订单记录中按低价优先整笔分配关联买入订单 ID，确保防重机制在重启后仍然有效。

### 6.2 订单价格跟踪和超时处理

- **价格跟踪**：委托价始终跟随最新市场价格（上涨/下跌均可调整）
- **买入超时**：超过配置时间未成交，自动撤销（避免追高）
- **卖出超时**：超过配置时间未成交，撤销后转市价单重新委托
- **调整条件**：价格差异 ≥ 0.001 港币、订单状态为未成交或部分成交
- **调整频率**：存在最小更新间隔，避免频繁改价导致 API 压力与撮合抖动

### 6.3 API 频率限制

- 30 秒内 ≤ 30 次
- 调用间隔 ≥ 0.03 秒
- 超限自动等待

### 6.4 自动寻标与自动换标

自动寻标用于在**不依赖静态交易标的**的前提下，为每个监控标的的做多/做空方向动态分配"当前可交易标的（牛/熊证）"，并在风险距离越界时自动换标与可选移仓回补。

**核心机制：席位（Seat）+ 版本号**
- 每个监控标的、每个方向各有一个席位，任何时刻**单方向只允许一个标的占位**（禁止新旧并存）。
- 席位状态：READY / SEARCHING / SWITCHING / EMPTY。
- 当发生"清席位并进入换标流程"时，都会递增席位版本号，用于**阻断旧信号**：延迟验证、队列任务、订单跟踪在处理前必须校验版本，不匹配直接丢弃并记录原因。

**自动寻标（Auto Search）**
- **允许时机**：仅在允许运行的交易时段内执行，且不处于开盘保护窗口。
- **开盘延迟**：仅早盘生效；若该方向已有持仓则可跳过延迟。
- **触发冷却**：同一方向 10 分钟内最多触发一次寻标（席位为空时的重试也受此冷却约束）。
- **失败计数与冻结机制**：
  - 每次寻标失败（数据源失败/无候选/订阅失败）将失败计数加 1
  - 失败次数达到上限（默认 3 次）时，设置冻结交易日标记为当前港股日期，席位状态保持 EMPTY
  - 冻结后当日不再尝试寻标，该方向交易被阻断
  - 跨日午夜清理时重置失败计数和冻结交易日标记，次日可重新寻标
- **筛选原则（文字口径）**：基于牛/熊证候选列表，计算"分均成交额（成交额按已开盘分钟数折算）"，并按以下规则筛选与选优：
  - 过滤：交易状态正常、牛/熊方向匹配、到期月份满足下限、成交额大于 0
  - 阈值：距回收价百分比达到最低门槛（牛证 > 阈值，熊证 < 阈值），且分均成交额达到最低门槛
  - 选优：距回收价百分比的绝对值更小优先；相同则分均成交额更高优先；仅取最优 1 个
- **结果处理**：寻标失败 → 更新失败计数，达到上限则冻结席位；成功则占位并订阅新标的行情，失败计数清零。
- **启动时推断**：启动时优先使用已有持仓的标的，避免自动寻标覆盖现有仓位；若无持仓则根据订单归属推断席位标的。
- **行情未就绪**：席位已占用但尚未收到首个行情时，买入信号会以"行情未就绪"被丢弃（不按席位空处理）；卖出可尝试执行，失败按失败处理。

**自动换标（Auto Switch）**
- **触发条件**：仅当监控标的价格变化达到"显著变化阈值"时才检查；触发来源仅为"距回收价百分比越界"。
- **流程推进**：一旦进入换标流程，后续循环会持续推进直至完成或失败，不依赖再次触发价格变化。
- **越界判定**：牛/熊方向分别配置一个触发区间（区间下限与上限）；距回收价百分比小于等于区间下限或大于等于区间上限时触发换标（即落在区间外或恰在边界上即触发）。
- **预寻标 + 日内抑制（同标的循环保护）**
  - 越界后先预寻标候选：若候选与旧标的一致 → 记录"当日抑制"并停止换标（不清席位、不递增版本）。
  - 当日抑制按"方向 + 旧标的 + 港股日期"记录；跨日后清理，次日可再次触发。
- **换标状态机（撤单 → 持仓处理 → 占位 → 可选回补）**
  - 撤单范围：仅撤销该方向旧标的的**未完成买入挂单**（含部分成交/待成交/待改单等状态）；任一撤单失败视为换标失败，席位变 EMPTY。
  - 持仓判定口径：
    - 仍有持仓：以"可用持仓数量大于 0"为准（有可用持仓才提交移仓卖出）
    - 若"总持仓大于 0 且可用为 0"：视为已有卖出挂单未成交，等待下一轮继续（不寻标、不占位）
  - 移仓卖出：若可用持仓数量大于 0，使用 **ELO** 卖出旧标的全部可用持仓，等待完全成交后继续流程。
  - 占位与回补（可选）：候选存在则席位恢复 READY 并切换到新标的，失败计数清零；若需要移仓回补，则待新标的行情就绪后按"卖出实际资金（上限）/目标金额"计算买入量，按最小买卖单位向下取整，使用 **ELO** 提交回补买入。
- **换标完成定义**：新标的占位为 READY 且回收价刷新成功；若回收价刷新失败视为换标失败，席位回到 EMPTY。换标成功后失败计数清零。

**换标后的统一刷新顺序（避免缓存污染）**
- 清空牛熊证风险信息缓存 → 刷新订单记录 → 刷新账户/持仓缓存 → 刷新浮亏监控数据 → 刷新回收价缓存 → 清理旧标的订单记录与缓存（若未被其他席位占用）
- 刷新过程中使用刷新门禁机制，确保异步处理器等待刷新完成后再读取数据。

---

## 7. 程序执行流程

### 7.1 程序启动

1. 验证配置，获取标的信息
2. 初始化全局模块：交易器、市场监控、末日保护、指标缓存、买卖任务队列、买入/卖出处理器
3. 获取账户和持仓信息，并初始化持仓快速查询缓存
4. 拉取全量订单（历史与当日），初始化日内亏损追踪；记录挂单标的供订阅行情使用
5. 初始化"席位体系"：结合持仓与订单推断席位标的，自动寻标模式下对空席位执行寻标
6. 回放交易日志，恢复清仓冷却状态
7. 为每个监控标的创建独立上下文：策略、订单记录器、延迟信号验证器、风险检查器、浮亏监控器、自动寻标管理器（如启用）
8. 对当前席位标的刷新牛熊证回收价缓存
9. **按当前席位标的逐标的**刷新订单记录（合并全量订单中该标的买卖、去重后应用过滤算法）；无席位标的的方向不刷新
10. 初始化浮亏监控数据（基于订单记录/持仓）
11. 为每个延迟验证器注册回调（验证通过后推入对应队列，并校验席位版本号）
12. 启动买入/卖出处理器、监控任务处理器与主循环

### 7.2 主循环（每秒执行）

**全局层面**：

1. **交易日生命周期管理**：检测跨日（交易日标识变化）触发午夜清理，检测开盘触发开盘重建（见 7.5 节）

2. **交易日检查**：首次或跨天时调用 API，之后使用缓存

3. **交易时段检查**：判断是否在连续交易时段，不在则跳过（退出连续交易时段时清理所有待验证信号）

4. **开盘保护检查**：早盘或午盘开盘保护窗口内跳过信号生成与交易触发（用于降低开盘波动带来的假信号风险，午盘保护在半日市不生效）

5. **末日保护检查**：
   - 收盘前 15 分钟：首次进入时撤销所有未成交买入订单
   - 收盘前 5 分钟：生成清仓信号，清空所有持仓

6. **批量获取行情**：一次性获取所有监控标的和交易标的的行情数据

7. **并发处理所有监控标的**

8. **全局订单监控**：监控未成交订单，自动调整价格

9. **刷新缓存数据**：订单成交后统一刷新账户、持仓、浮亏缓存

**单监控标的处理**：

1. 从行情数据中提取当前标的的行情
2. 席位同步与自动寻标/换标调度：在行情刷新与价格变化时触发（寻标/换标均受交易时段、开盘保护与冷却约束）
3. 监控价格变化
4. 浮亏检查（仅在价格变化时）
5. 获取 K 线数据
6. 计算技术指标
7. 存入指标缓存
8. 生成信号（席位不就绪/标的切换/行情未就绪时会丢弃对应方向信号）
9. 信号分流：
   - 立即信号 → 买入/卖出任务队列
   - 延迟信号 → 延迟验证器
10. 延迟验证器验证通过后将信号推入对应队列（并校验席位版本号）

### 7.3 买入/卖出处理器

买入/卖出处理器独立运行，异步消费各自队列，不阻塞主循环。

**处理流程**：
1. 从队列获取任务
2. 校验席位版本号：版本不匹配或标的不一致则丢弃信号
3. 获取监控上下文（卖出使用缓存，买入风险检查时实时获取账户和持仓）
4. 卖出处理器：直接计算卖出数量（不经过风险检查）
5. 买入处理器：执行风险检查（实时调用 API）
6. 提交订单执行
7. 释放信号对象

**调度机制**：队列有任务时立即处理并继续调度；队列为空时停止调度，等待新任务触发重新调度

---

系统支持 7x24 连续运行，通过统一的交易日生命周期管理实现跨日缓存清理和开盘重建。

**生命周期状态机**：
- ACTIVE → MIDNIGHT_CLEANING → MIDNIGHT_CLEANED → OPEN_REBUILDING → ACTIVE
- 失败时自动重试（指数退避策略），状态回到 MIDNIGHT_CLEANING 或 OPEN_REBUILD_FAILED

**阶段 A：午夜清理（00:00 跨日触发）**

触发条件：检测到交易日标识变化时立即执行，期间禁止交易。

清理顺序（按缓存域注册顺序）：
1. **信号运行时域**：停止并排空所有异步处理器（买入/卖出/监控任务/订单监控/交易后刷新），清空任务队列并释放信号对象，取消所有延迟验证信号，清空指标缓存
2. **订单域**：重置交易执行器的运行时状态（订单追踪、持有标的集合等）
3. **席位域**：重置所有监控标的的自动换标状态，清空轮证列表缓存，清空所有席位绑定（保留时间戳，重置失败计数和冻结标记），递增席位版本号
4. **风控域**：重置风险检查冷却，重置日内亏损追踪器，清除跨日模式的清仓冷却键（保留分钟模式），清空浮亏数据和牛熊证风险信息缓存
5. **行情域**：重置所有运行时行情订阅与内部缓存
6. **全局状态域**：禁止交易，重置半日标记/开盘保护/交易日信息缓存，清空交易标的集合，重置各监控标的的运行状态，释放对象池中的快照对象

清理完成后：设置待开盘重建标记为真，记录目标交易日标识，状态转为 MIDNIGHT_CLEANED。

**阶段 B：开盘重建（开盘时触发）**

触发条件：待开盘重建标记为真且当前为交易日且允许交易。

重建顺序（按缓存域注册逆序）：
1. **全局状态域**：执行完整开盘重建流水线（加载运行时快照 → 重建交易日状态）
2. **行情域**：在统一重建流水线中重建行情订阅
3. **风控域**：在统一重建流水线中按当日数据重建
4. **席位域**：在统一重建流水线中按启动席位逻辑重建
5. **订单域**：在统一重建流水线中从全量订单 API 重新加载和重建
6. **信号运行时域**：重启所有异步处理器，刷新刷新门禁版本标记数据为最新

统一重建流水线执行顺序：
1. 同步所有监控标的的席位快照和行情数据到监控上下文
2. 重建订单记录（从全量订单 API 数据中恢复，按当前席位标的逐标的应用过滤算法）
3. 重建牛熊证风险缓存（回收价等关键风控数据）
4. 重建浮亏缓存（结合当日已实现亏损偏移量）
5. 恢复订单追踪状态（包括待成交卖出订单的关联买入订单 ID 分配）
6. 展示账户和持仓信息

重建完成后：清除待开盘重建标记，状态转为 ACTIVE，恢复交易。

**失败重试机制**：
- 午夜清理失败：指数退避重试（首次 30 秒，最大倍数 16），状态保持 MIDNIGHT_CLEANING
- 开盘重建失败：指数退避重试（首次 30 秒，最大倍数 16），状态转为 OPEN_REBUILD_FAILED，交易保持禁止
- 重试期间交易门禁保持关闭，确保不会使用过期缓存执行交易

---

## 8. 配置说明

### 8.1 多标的配置

系统支持配置多个监控标的，按序号从 1 开始连续配置；中间不能跳号（例如配置了 1 和 3 但没有 2，会导致 3 不被读取）。

**单监控标的配置项**：
- 监控标的：用于生成信号的标的（如恒指）
- 做多交易标的：自动寻标关闭时必需；自动寻标开启时会被忽略
- 做空交易标的：自动寻标关闭时必需；自动寻标开启时会被忽略
- 每次买入金额：用于计算下单数量
- 信号配置：买入做多/卖出做多/买入做空/卖出做空各一套
- 智能平仓开关：决定卖出信号是"仅卖盈利部分"还是"直接全仓"

**自动寻标/换标配置项（单监控标的级别开关，做多/做空一起启用）**
- 自动寻标开关：开启后动态占位，忽略静态交易标的配置（仅影响牛/熊证类交易标的）
- 订单归属映射：用于从订单名称中解析"该订单属于哪个监控标的与方向"，以便启动时归集订单记录与初始化席位
- 最低距回收价百分比阈值（牛/熊分别配置）：未达门槛的候选不会被选中
- 分均成交额阈值（牛/熊分别配置）：低于门槛的候选不会被选中
- 到期日最小月份：到期时间不足的候选不会被选中（默认 3 个月）
- 早盘开盘延迟分钟数：仅早盘生效，未到延迟窗口不执行自动寻标（默认 5 分钟）
- 距回收价换标区间（牛/熊分别配置）：用区间下限与上限描述；距回收价百分比小于等于下限或大于等于上限时进入换标流程

### 8.2 验证配置

| 配置项 | 说明 | 默认 |
|------|------|------|
| 买入延迟时间 | 买入信号触发后等待的延迟时间（0-120 秒） | 60 |
| 卖出延迟时间 | 卖出信号触发后等待的延迟时间（0-120 秒） | 60 |
| 买入验证指标 | 用于验证趋势持续性的指标集合（例如 K、MACD 等） | K、MACD |
| 卖出验证指标 | 用于验证趋势持续性的指标集合（例如 K、MACD 等） | K、MACD |

### 8.3 风险配置

| 配置项 | 说明 |
|------|------|
| 最大持仓市值 | 单标的持仓市值上限 |
| 单日最大亏损 | 买入风控使用的浮亏/亏损上限 |
| 单标的最大浮亏保护阈值 | 触发保护性清仓的阈值 |
| 清仓冷却 | 保护性清仓后拒绝买入的时长（按分钟数/半日/一日等，可配置） |
| 末日保护开关 | 是否启用收盘前拒买与自动清仓（默认开启） |
| 买入间隔 | 同方向买入的最小时间间隔（默认 60 秒） |

### 8.4 订单配置

| 配置项 | 说明 |
|------|------|
| 交易订单类型 | 正常买卖的订单类型（LO/ELO/MO，默认 ELO） |
| 清仓订单类型 | 保护性清仓/末日清仓使用的订单类型（默认 MO） |
| 买入订单超时 | 买入订单超时未成交的处理时长（默认 180 秒） |
| 卖出订单超时 | 卖出订单超时未成交的处理时长（默认 180 秒） |

---

## 9. 术语表

| 术语 | 说明 |
|------|------|
| 监控标的 | 生成信号的标的（如恒指） |
| 做多/做空标的 | 交易标的（牛/熊证） |
| 回收价 | 牛熊证强制回收价 |
| 成本均价 | 加权平均买入价格，用于智能平仓整体盈亏判断 |
| 开仓成本 R1 | 所有未平仓订单的成本总和，用于浮亏监控 |
| 持仓量 N1 | 未平仓订单总量 |
| 浮亏 | 当前市值减开仓成本（R2 减 R1） |
| 智能平仓 | 仅卖盈利部分 |
| 保护性清仓 | 浮亏超限紧急清仓 |
| 末日保护 | 收盘前自动保护机制 |
| ELO | 增强限价单 |
| MO | 市价单 |
| 买入/卖出任务队列 | FIFO 队列，存储待处理的交易信号 |
| 买入/卖出处理器 | 异步消费任务队列，执行风险检查和订单 |
| 指标缓存 | 环形缓冲区，存储每秒的指标快照 |
| 信号触发时间 | 立即信号为生成时间，延迟信号为 T0，末日保护为生成时间 |
| 席位（Seat） | 每个监控标的每个方向一个"当前交易标的槽位" |
| 席位状态 | READY/SEARCHING/SWITCHING/EMPTY，表示该方向是否可交易/是否正在寻标换标 |
| 席位版本号 | 换标时递增的版本号，用于阻断旧信号（延迟验证/队列/订单跟踪均需校验） |
| 自动寻标 | 基于候选列表的距回收价百分比与分均成交额筛选，动态选择牛/熊证并占位 |
| 自动换标 | 距回收价百分比越界触发的换标流程（含预寻标、撤单、移仓、占位、回补与刷新） |
| 日内抑制 | 同标的候选导致的当日停止换标机制（跨日清理） |
| 行情未就绪 | 席位已占用但尚未收到首个行情；买入信号会被丢弃并记录原因 |
| 待成交卖出防重 | 提交卖出时登记关联买入订单，智能平仓时排除已占用部分，避免同一笔买入被重复卖出 |
| 信号对象池 | 复用信号对象，减少内存分配和 GC 压力 |
| 刷新门禁 | 确保异步处理器等待数据刷新完成后再读取的同步机制 |
| 生命周期状态 | ACTIVE/MIDNIGHT_CLEANING/MIDNIGHT_CLEANED/OPEN_REBUILDING/OPEN_REBUILD_FAILED |
| 缓存域 | 按职责划分的缓存清理和重建单元（信号运行时/订单/席位/风控/行情/全局状态） |

---

## 10. 关键注意事项
### 成本价区分
- **成本均价**:加权平均买入价格，用于智能平仓整体盈亏判断
- **开仓成本 R1**：用于浮亏监控触发保护性清仓

### 做多做空独立性
- 订单记录独立（做多和做空分别记录）
- 浮亏监控独立（各自 R1、N1）
- 一方浮亏不影响另一方

### 多监控标的独立性
- 配置独立：每个监控标的有独立的信号配置、风险配置、验证配置
- 状态独立：价格、指标、待验证信号列表各自独立
- 延迟验证器独立：每个监控标的有独立的延迟验证器
- 订单记录共享：所有监控标的共享同一个订单记录器，通过标的代码区分
- 并发处理：所有监控标的并发处理，互不干扰

### 信号对象生命周期
- **立即信号**：由主循环分流入队；入队后由买入/卖出处理器消费并释放；若被风险检查冷却跳过，在主循环中释放
- **延迟信号**：验证失败/超时/缺失数据/退出连续交易时段/席位版本不匹配等情形由验证器丢弃并释放；验证通过后进入队列，由处理器释放
- **对象池管理**：所有信号对象通过对象池管理，使用完毕后必须释放回对象池

### 关键设计模式
- **门面模式**：交易器、风险控制器、订单记录器等模块使用门面模式封装复杂子系统
- **工厂模式**：所有创建函数使用工厂模式创建实例
- **策略模式**：策略模块使用策略模式实现不同的信号生成策略
- **观察者模式**：延迟信号验证器使用回调机制实现观察者模式
- **对象池模式**：信号对象池、指标记录池使用对象池模式复用对象
- **状态机模式**：换标状态机使用状态机模式管理换标流程

