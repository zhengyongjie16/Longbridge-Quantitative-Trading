# LongBridge 证券港股自动化量化交易系统

## 项目简介及重要提示

### 项目介绍

基于 LongPort OpenAPI / Node.js / TypeScript 的港股自动化量化交易系统，通过监控目标资产（如恒生指数）的技术指标，在轮证上自动执行做多/做空交易。支持多指标组合策略、延迟验证、风险控制和订单管理。

### 重要提示（必读）

1. 该程序一般不会交易正股（正股仅用作实时分析，即配置中的监控标的），而是在轮证上进行多空交易，主要为交易做多或做空方向的权证或牛熊证，这存在较高风险。
3. 请先务必掌握港股、轮证以及技术指标的相关知识，轮证自带杠杆属性且存在到期时间和回收等机制，这些因素都存在较大风险。
2. 目前的交易策略仅针对日内交易，当前也仅支持日内交易。
4. 请务必掌握代码知识（主要为typescript），该程序不建议非开发者使用。
5. 该程序代码由vibe coding（主要使用claude模型）编写，也推荐使用claude进行优化和再开发，这是当前最强大的模型。
6. 请务必先使用模拟账户进行调试.

## 开发者提示

1. 使用 Claude Code 开发时，请参阅 **[CLAUDE.md](./CLAUDE.md)** 获取专门指导。
2. 项目内置 skills，Claude Code 可自动使用以下 skill：
  - `/core-program-business-logic`：阅读程序以及业务逻辑（当重构代码时应一并修改该skill文档）
  - `/longbridge-openapi-documentation`：查询 LongPort API 文档，根据 API 编写代码
  - `/typescript-project-specifications`：严格的代码规范，编写和检查任何ts代码时应该使用这个skill

### 核心功能


| 功能    | 说明                        |
| ----- | ------------------------- |
| 多标的支持 | 支持并发监控多个标的，每个标的独立配置       |
| 多指标组合 | RSI、MFI、KDJ、MACD、EMA 组合判断 |
| 双向交易  | 支持做多（牛证）和做空（熊证）           |
| 延迟验证  | 买入和卖出信号可独立配置延迟验证          |
| 智能风控  | 浮亏保护、持仓限制、牛熊证回收价检查        |
| 末日保护  | 收盘前15分钟拒绝买入，收盘前5分钟自动清仓    |
| 订单调整  | 自动监控和调整未成交买入订单价格          |
| 内存优化  | 对象池复用减少 GC 压力             |
| 卖出策略  | 盈利清仓，未盈利仅卖出盈利部分订单         |


---

## 快速开始

### 安装

```bash
npm install
cp .env.example .env.local
# 编辑 .env.local 填写配置
```

### 配置必需参数 (.env.local)

系统支持多个监控标的，通过 `MONITOR_COUNT` 指定数量，每个监控标的使用后缀 `_N`（N从1开始）区分配置。

```env
# API 配置
LONGPORT_APP_KEY=your_key
LONGPORT_APP_SECRET=your_secret
LONGPORT_ACCESS_TOKEN=your_token

# 监控标的数量（必须 >= 1）
MONITOR_COUNT=1

# 交易标的配置（使用后缀 _N，N从1开始）
# 示例：第一个监控标的（_1）
MONITOR_SYMBOL_1=HSI.HK    # 监控标的（恒生指数）
LONG_SYMBOL_1=54806        # 做多标的（牛证）
SHORT_SYMBOL_1=63372       # 做空标的（熊证）

# 交易参数(示例)
TARGET_NOTIONAL_1=10000    # 每次买入金额（HKD）
LONG_LOT_SIZE_1=100        # 做多每手股数
SHORT_LOT_SIZE_1=100       # 做空每手股数

# 风控参数(示例)
MAX_POSITION_NOTIONAL_1=200000  # 单标持仓上限
MAX_DAILY_LOSS_1=20000          # 单日亏损上限

# 信号配置（示例，格式见下方）
SIGNAL_BUYCALL_1=(RSI:6<20,MFI<15,D<20,J<-1)/3|(J<-20)
SIGNAL_SELLCALL_1=(RSI:6>80,MFI>85,D>79,J>100)/3|(J>110)
SIGNAL_BUYPUT_1=(RSI:6>80,MFI>85,D>80,J>100)/3|(J>120)
SIGNAL_SELLPUT_1=(RSI:6<20,MFI<15,D<22,J<0)/3|(J<-15)

# 如需配置第二个监控标的，使用后缀 _2，以此类推
# MONITOR_SYMBOL_2=...
# LONG_SYMBOL_2=...
```

### 启动

```bash
npm run dev
```

---

## 信号配置格式

**格式**：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`

- **括号内**：条件列表，逗号分隔
- **/N**：括号内条件需满足 N 项
- **|**：分隔条件组，满足任一组即可
- **指标**：
  - `RSI:n`：任意周期 RSI（n 范围 1-100），如 `RSI:6<20`
  - `MFI`：资金流量指标
  - `K`、`D`、`J`：KDJ 指标
  - `MACD`、`DIF`、`DEA`：MACD 指标
  - `EMA:n`：任意周期 EMA（n 范围 1-250）
- **运算符**：`<`、`>`

> **技术指标详解**：详见 [docs/TECHNICAL_INDICATORS.md](./docs/TECHNICAL_INDICATORS.md)

### 交易策略

#### 信号生成与验证流程

系统采用延迟验证机制，所有交易信号（买入和卖出）都需要经过延迟验证后才能执行。

**四种信号类型**：


| 信号       | 类型   | 环境变量                | 延迟验证规则                               |
| -------- | ---- | ------------------- | ------------------------------------ |
| BUYCALL  | 买入做多 | `SIGNAL_BUYCALL_N`  | T0、T0+5s、T0+10s 三个时间点的指标值均需**大于**初始值 |
| SELLCALL | 卖出做多 | `SIGNAL_SELLCALL_N` | T0、T0+5s、T0+10s 三个时间点的指标值均需**小于**初始值 |
| BUYPUT   | 买入做空 | `SIGNAL_BUYPUT_N`   | T0、T0+5s、T0+10s 三个时间点的指标值均需**小于**初始值 |
| SELLPUT  | 卖出做空 | `SIGNAL_SELLPUT_N`  | T0、T0+5s、T0+10s 三个时间点的指标值均需**大于**初始值 |


> **注意**：环境变量中的 `N` 表示监控标的索引（如 `_1`、`_2`）。买入和卖出的延迟验证时间、验证指标可独立配置。

**延迟验证机制**：

1. 信号触发时记录指标初始值（indicators1）
2. 在触发时间前后窗口内记录指标值（T0-5s 至 T0+15s）
3. 触发时间后 15 秒进行验证，检查 T0、T0+5s、T0+10s 三个时间点的指标值
4. 验证通过后信号进入执行流程，验证失败则丢弃该信号

#### 买入策略

1. **信号生成**：监控标的技术指标满足配置条件时，生成延迟验证买入信号
2. **延迟验证**：等待配置的延迟时间（默认60秒），验证指标趋势是否延续
3. **风险检查**：通过验证后，执行多层风险检查（频率限制、价格限制、末日保护、牛熊证风险、浮亏限制、持仓限制）
4. **订单执行**：风险检查通过后，按目标金额计算买入数量并提交限价单

#### 卖出策略

1. **信号生成**：监控标的技术指标满足配置条件，且存在买入订单记录时，生成延迟验证卖出信号
2. **延迟验证**：等待配置的延迟时间（默认60秒），验证指标趋势是否延续
3. **成本价判断**：验证通过后，根据当前价格与持仓成本价的关系决定卖出数量：
  - **当前价 > 持仓成本价**：清空全部持仓（盈利状态）
  - **当前价 ≤ 持仓成本价**：仅卖出历史买入订单中买入价低于当前价的部分（部分盈利订单）
  - **无符合条件订单**：信号设为 HOLD，跳过本次卖出
4. **特殊规则**：末日保护程序的清仓信号无条件清仓，不受成本价判断影响
5. **订单执行**：确定卖出数量后提交市价单执行

---

## 风险控制

### 买入检查顺序

1. **交易频率限制**：同方向买入间隔（默认 60 秒）
2. **买入价格限制**：当前价 > 最新成交价时拒绝（防止追高）
3. **末日保护**：收盘前 15 分钟拒绝买入
4. **牛熊证风险**：牛证距回收价 > 0.5%，熊证 < -0.5%
5. **基础风险检查**：浮亏限制、持仓市值限制


| 检查    | 说明                           | 买入          | 卖出  |
| ----- | ---------------------------- | ----------- | --- |
| 交易频率  | 同方向买入间隔（默认60秒）               | ✅ 限制        | ❌   |
| 买入价格  | 当前价 > 最新成交价时拒绝（防追高）          | ✅ 检查        | ❌   |
| 末日保护  | 收盘前 15 分钟拒绝买入                | ✅ 限制        | ❌   |
| 牛熊证风险 | 使用监控标的价格计算距回收价               | ✅ 检查        | ❌   |
| 单日亏损  | 浮亏 > MAX_DAILY_LOSS          | ✅ 限制        | ❌   |
| 持仓市值  | 单标持仓 > MAX_POSITION_NOTIONAL | ✅ 限制        | ❌   |
| 浮亏保护  | 单标浮亏 > MAX_UNREALIZED_LOSS   | 实时监控（市价单清仓） | ❌   |


### 末日保护（可配置）

- 收盘前 15 分钟：拒绝所有买入并撤销未成交的订单委托
- 收盘前 5 分钟：自动清空所有持仓

### 可选配置

**全局配置**：


| 参数                    | 默认值     | 说明     |
| --------------------- | ------- | ------ |
| `DOOMSDAY_PROTECTION` | `true`  | 启用末日保护 |
| `DEBUG`               | `false` | 启用调试日志 |


**每个监控标的配置**（使用后缀 `_N`，如 `_1`、`_2`）：


| 参数                                  | 默认值      | 说明                                     |
| ----------------------------------- | -------- | -------------------------------------- |
| `MAX_UNREALIZED_LOSS_PER_SYMBOL_N`  | `0`      | 单标浮亏保护阈值（0表示禁用）                       |
| `VERIFICATION_DELAY_SECONDS_BUY_N`  | `60`     | 买入延迟验证时间（秒，范围0-120）                   |
| `VERIFICATION_INDICATORS_BUY_N`     | `K,MACD` | 买入验证指标（逗号分隔，可选：K/D/J/MACD/DIF/DEA/EMA:n） |
| `VERIFICATION_DELAY_SECONDS_SELL_N` | `60`     | 卖出延迟验证时间（秒，范围0-120）                   |
| `VERIFICATION_INDICATORS_SELL_N`    | `K,MACD` | 卖出验证指标（逗号分隔，可选：K/D/J/MACD/DIF/DEA/EMA:n） |
| `BUY_INTERVAL_SECONDS_N`            | `60`     | 同向买入间隔（秒，范围10-600）                    |


---

## 系统架构

```
src/
├── index.ts              # 主入口（每秒循环）
├── core/
│   ├── strategy/         # 信号生成
│   ├── trader/           # 订单执行（含未成交订单管理）
│   ├── risk/             # 风险检查
│   ├── orderRecorder/    # 订单记录（永久缓存）
│   ├── signalProcessor/  # 信号处理
│   ├── signalVerification/ # 延迟验证
│   ├── marketMonitor/    # 行情监控
│   ├── doomsdayProtection/ # 末日保护
│   └── unrealizedLossMonitor/ # 浮亏监控
├── services/
│   ├── indicators/       # 技术指标计算
│   └── quoteClient/      # 行情数据
├── utils/
│   ├── objectPool.ts     # 内存优化（对象池）
│   ├── indicatorHelpers.ts # 指标辅助函数
│   ├── logger.ts         # 日志系统
│   ├── signalConfigParser.ts # 配置解析
│   ├── helpers.ts        # 工具函数
│   ├── tradingTime.ts    # 交易时段
│   └── accountDisplay.ts # 账户显示
└── config/
    ├── config.index.ts   # API配置
    ├── config.trading.ts # 交易配置
    └── config.validator.ts # 配置验证
```

---

## 运行流程

```
每秒循环（runOnce）：
1. 检查交易时段和交易日
2. 并发处理所有监控标的：
   a. 获取K线和实时行情（并发）
   b. 计算技术指标（RSI/MFI/KDJ/MACD/EMA）
   c. 生成延迟验证信号（买入和卖出）
   d. 记录待验证信号的指标历史值
   e. 验证到期信号（T0+15秒后验证，检查T0/T0+5s/T0+10s趋势）
   f. 风险检查（买入：频率/价格/末日/牛熊证/浮亏/持仓）
   g. 处理卖出信号（成本价判断和数量计算）
   h. 执行订单（ELO限价单/MO市价单）
   i. 更新订单记录（永久缓存）
   j. 浮亏监控（价格变化时检查，超阈值立即清仓）
3. 订单监控（未成交买入订单价格下跌时自动降价）
4. 更新账户显示
```

---

## 日志

- **控制台**：实时运行状态
- **文件**：`logs/system/` 、 `logs/debug/`（DEBUG 模式）和`logs/trades/`（交易信息）
- **交易记录**：`logs/trades/YYYY-MM-DD.json`

---

## 帮助

- [LongPort 官方文档](https://open.longbridge.com/zh-CN/docs)
- [LongPort/Node.js SDK 文档](https://longportapp.github.io/openapi/nodejs/)
- [Claude Code 官方文档](https://code.claude.com/docs)

---

## 许可证

MIT License (c) 2025 Ulysses Zheng