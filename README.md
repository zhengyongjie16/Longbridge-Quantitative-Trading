# LongBridge 港股自动化量化交易系统

## 项目简介

这是一个基于 LongPort OpenAPI 的港股自动化量化交易系统，专门用于监控港股市场（如恒生指数）并根据技术指标自动执行做多/做空交易策略。该系统采用多指标组合策略，实时监控市场变化，自动生成交易信号并执行订单。

### 主要特点

- ✅ **多指标组合策略**：结合 RSI、MFI、KDJ、MACD 四种技术指标
- ✅ **双向交易支持**：支持做多和做空两个方向的标的交易
- ✅ **延迟验证机制**：开仓信号采用 60 秒延迟验证，确保趋势确认后再执行
- ✅ **智能风险控制**：单日最大亏损限制、单标的持仓市值限制、牛熊证距离回收价检查
- ✅ **单标的浮亏保护**：基于实时价格与成本市值的浮亏监控，超过阈值自动触发保护性清仓（市价单）
- ✅ **智能订单管理**：自动监控未成交买入订单，当价格下跌时自动降低委托价格
- ✅ **精细化清仓策略**：基于持仓成本价和历史订单的智能清仓逻辑
- ✅ **末日保护程序**：可配置在收盘前 15 分钟拒绝买入，收盘前 5 分钟自动清空所有持仓
- ✅ **实时监控和日志**：每秒监控一次，详细记录所有交易操作和决策依据
- ✅ **完整的配置验证**：启动时自动验证所有配置项，避免运行时错误

---

## 系统架构

### 核心模块

```
src/
├── index.js                    # 主程序入口，包含交易主循环
├── strategy.js                 # 交易策略模块（多指标组合策略）
├── trader.js                   # 交易执行模块（订单提交、管理）
├── indicators.js               # 技术指标计算模块（RSI、KDJ、MACD）
├── objectPool.js               # 对象池模块（内存优化）
├── risk.js                     # 风险控制模块（浮亏检查、持仓限制）
├── orderRecorder.js            # 订单记录模块（历史订单管理）
├── quoteClient.js              # 行情客户端（获取行情、K线数据）
├── logger.js                   # 日志管理模块
├── utils.js                    # 工具函数模块
├── signalTypes.js              # 信号类型定义
└── config/
    ├── config.js               # LongPort API 配置
    ├── config.trading.js       # 交易配置（标的、金额、风控参数）
    └── config.validator.js     # 配置验证模块
```

### 数据流程

```
监控标的行情数据 → 计算技术指标 → 策略生成信号 → 风险检查 → 订单执行 → 订单监控
     ↓                ↓              ↓            ↓           ↓           ↓
  K线数据      RSI/MFI/KDJ/MACD   立即/延迟    浮亏/持仓    做多/做空   价格优化
```

---

## 交易策略详解

### 策略概述

本系统采用**多指标组合策略**，基于恒生指数（或其他监控标的）的技术指标判断市场趋势，并对做多标的（牛证）和做空标的（熊证）执行双向交易。

### 技术指标

1. **RSI（相对强弱指标）**

   - RSI6：6 周期 RSI
   - 超买：> 80
   - 超卖：< 20

2. **MFI（资金流量指标）**

   - MFI：14 周期资金流量指标
   - 结合价格和成交量的超买超卖指标，类似于 RSI，但考虑了成交量
   - 超买：> 85
   - 超卖：< 15

3. **KDJ（随机指标）**

   - K：快速随机指标
   - D：慢速随机指标
   - J：超买超卖指标（可超出 0-100 范围）
   - 超买：D > 80, J > 100
   - 超卖：D < 20, J < 0

4. **MACD（指数平滑异同移动平均线）**
   - DIF：快线（EMA12 - EMA26）
   - DEA：慢线（DIF 的 EMA9）
   - MACD 柱：(DIF - DEA) × 2
   - 用于延迟验证趋势

### 交易信号

所有交易信号的条件现在**完全可配置**，通过环境变量设置。信号配置采用灵活的表达式格式，支持多个条件组和条件组合。

#### 信号配置格式

**配置格式**：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`

**格式说明**：

- **括号内**：条件列表，逗号分隔
- **/N**：括号内条件需满足 N 项，不设则全部满足
- **|**：分隔不同条件组（最多 3 个），满足任一组即可触发信号
- **支持指标**：`RSI6`, `RSI12`, `MFI`, `D` (KDJ.D), `J` (KDJ.J)
- **支持运算符**：`<` 和 `>`
- **支持负数阈值**：如 `J<-20`

**配置示例**：

```
(RSI6<20,MFI<15,D<20,J<-1)/3|(J<-20)
```

表示：满足条件组 1（4 个条件中至少 3 个满足）**或** 满足条件组 2（J<-20）即可触发。

#### 1. 买入做多标的（BUYCALL）- 延迟验证

**环境变量**：`SIGNAL_BUYCALL`

**默认配置示例**（仅供参考，实际需在 `.env` 中配置）：

```
(RSI6<20,MFI<15,D<20,J<-1)/3|(J<-20)
```

**配置说明**：

- **条件组 1**：`(RSI6<20,MFI<15,D<20,J<-1)/3` - 四个指标中至少 3 个满足
- **条件组 2**：`(J<-20)` - J 值小于-20
- 满足任一条件组即可触发

**验证阶段策略（延迟验证）：**

当触发买入做多标信号并进入验证阶段时：

1. **立即记录**：记录所有配置的验证指标的初始值（indicators1）
   - 推荐使用 D 和 DIF 两个指标
   - 可通过 `VERIFICATION_INDICATORS` 环境变量配置（可选：K, D, J, MACD, DIF, DEA）
2. **等待延迟时间**：默认 60 秒，可通过 `VERIFICATION_DELAY_SECONDS` 环境变量配置（范围 0-120 秒）
   - 例如触发信号的时间为 10:30:30，延迟 60 秒，需等待至 10:31:30
   - 在等待期间，每秒记录一次当前监控标的的指标值到验证历史中（仅记录 triggerTime ± 5 秒窗口内的值）
3. **获取验证值**：到达延迟时间时，从验证历史中获取所有配置指标的第二个值（indicators2）
   - 优先：精确匹配目标时间（triggerTime）
   - 备选：距离目标时间最近的值（误差 ≤ 5 秒）
4. **验证条件**：所有配置指标的第二个值都要大于第一个值
   - 例如：如果配置了 D 和 DIF，则要求 D2 > D1 **且** DIF2 > DIF1
5. **验证失败**：若验证条件不满足，则放弃该信号

#### 2. 卖出做多标的（SELLCALL）- 立即执行

**环境变量**：`SIGNAL_SELLCALL`

**默认配置示例**（仅供参考，实际需在 `.env` 中配置）：

```
(RSI6>80,MFI>85,D>79,J>100)/3|(J>110)
```

**配置说明**：

- **条件组 1**：`(RSI6>80,MFI>85,D>79,J>100)/3` - 四个指标中至少 3 个满足（注意 D 的阈值是 79）
- **条件组 2**：`(J>110)` - J 值大于 110
- 满足任一条件组即可触发

**注意**：卖出信号生成时无需判断成本价，成本价判断在卖出策略中进行。

**卖出策略（在信号触发后执行）：**

- **若当前做多标的价格 > 持仓成本价**：立即清仓所有做多标的持仓
- **若当前做多标的价格 ≤ 持仓成本价**：
  - 检查做多标的的历史买入且已成交订单（已记录的订单）
  - 找出买入价 < 当前价的订单
  - 获取这些订单的全部成交数量
  - 以当前价卖出这些数量

#### 3. 买入做空标的（BUYPUT）- 延迟验证

**环境变量**：`SIGNAL_BUYPUT`

**默认配置示例**（仅供参考，实际需在 `.env` 中配置）：

```
(RSI6>80,MFI>85,D>80,J>100)/3|(J>120)
```

**配置说明**：

- **条件组 1**：`(RSI6>80,MFI>85,D>80,J>100)/3` - 四个指标中至少 3 个满足
- **条件组 2**：`(J>120)` - J 值大于 120
- 满足任一条件组即可触发

**验证阶段策略（延迟验证）：**

当触发买入做空标信号并进入验证阶段时：

1. **立即记录**：记录所有配置的验证指标的初始值（indicators1）
   - 推荐使用 D 和 DIF 两个指标
   - 可通过 `VERIFICATION_INDICATORS` 环境变量配置（可选：K, D, J, MACD, DIF, DEA）
2. **等待延迟时间**：默认 60 秒，可通过 `VERIFICATION_DELAY_SECONDS` 环境变量配置（范围 0-120 秒）
   - 例如触发信号的时间为 10:30:30，延迟 60 秒，需等待至 10:31:30
   - 在等待期间，每秒记录一次当前监控标的的指标值到验证历史中（仅记录 triggerTime ± 5 秒窗口内的值）
3. **获取验证值**：到达延迟时间时，从验证历史中获取所有配置指标的第二个值（indicators2）
   - 优先：精确匹配目标时间（triggerTime）
   - 备选：距离目标时间最近的值（误差 ≤ 5 秒）
4. **验证条件**：所有配置指标的第二个值都要小于第一个值
   - 例如：如果配置了 D 和 DIF，则要求 D2 < D1 **且** DIF2 < DIF1
5. **验证失败**：若验证条件不满足，则放弃该信号

#### 4. 卖出做空标的（SELLPUT）- 立即执行

**环境变量**：`SIGNAL_SELLPUT`

**默认配置示例**（仅供参考，实际需在 `.env` 中配置）：

```
(RSI6<20,MFI<15,D<22,J<0)/3|(J<-15)
```

**配置说明**：

- **条件组 1**：`(RSI6<20,MFI<15,D<22,J<0)/3` - 四个指标中至少 3 个满足（注意 D 的阈值是 22）
- **条件组 2**：`(J<-15)` - J 值小于-15
- 满足任一条件组即可触发

**注意**：卖出信号生成时无需判断成本价，成本价判断在卖出策略中进行。

**卖出策略（在信号触发后执行）：**

- **若当前做空标的价格 > 持仓成本价**：立即清仓所有做空标的持仓（做空标的会随监控标的反方向波动）
- **若当前做空标的价格 ≤ 持仓成本价**：
  - 检查做空标的的历史买入且已成交订单（已记录的订单）
  - 找出买入价 < 当前价的订单
  - 获取这些订单的全部成交数量
  - 以当前价卖出这些数量

#### 信号配置要求

**重要**：所有四个信号配置（`SIGNAL_BUYCALL`, `SIGNAL_SELLCALL`, `SIGNAL_BUYPUT`, `SIGNAL_SELLPUT`）都是**必需配置项**，必须在 `.env` 文件中设置。程序启动时会验证配置格式，格式无效将导致启动失败。

---

## 风险控制机制

### 1. 单日最大亏损限制

- 实时计算整体持仓浮亏：`浮亏 = 持仓市值 - 持仓成本`
- 当浮亏超过 `MAX_DAILY_LOSS` 时，禁止开新仓（仅限制买入，不限制卖出）
- 配置参数：`MAX_DAILY_LOSS`（单位：HKD）

### 2. 单标的最大持仓市值限制

- 每个标的的持仓市值不得超过 `MAX_POSITION_NOTIONAL`
- **若已有持仓应以成本价计算当前持仓市值**（优先使用成本价，如果没有成本价则使用当前市价）
- 持仓市值 = 持仓数量 × 价格（成本价优先）
- 配置参数：`MAX_POSITION_NOTIONAL`（单位：HKD）

### 3. 牛熊证距离回收价检查

- **初始化**：在程序启动时，判断做多标的和做空标的是否为牛熊证
  - 做多标的判断是否是牛证（通过 `warrantQuote` API 的 `category` 字段）
  - 做空标的判断是否是熊证（通过 `warrantQuote` API 的 `category` 字段）
  - 如果是牛证或熊证，则记录它们的回收价（`call_price` 字段）
  - 做多标的和做空标的分开记录
- **买入前检查**：
  - 在买入做多标的前检查该牛证距离回收价的百分比（如果做多标的是牛证）
  - 在买入做空标的前检查该熊证距离回收价的百分比（如果做空标的是熊证）
  - **重要**：使用**监控标的的当前价格**（而非牛熊证本身的价格）来计算距离回收价的百分比
  - **计算方式**：
    - 距离回收价百分比 = (监控标的当前价 - 回收价) / 回收价 × 100
    - 优先使用实时行情价格，如果没有则使用 K 线收盘价
  - **风险阈值**：
    - 牛证：距离回收价百分比 < 0.5% 时停止买入
    - 熊证：距离回收价百分比 > -0.5% 时停止买入
  - **异常价格保护**：如果监控标的价格异常（< 1），可能是获取到了错误的价格（如牛熊证本身的价格），拒绝买入以确保安全

### 4. 交易频率限制

- **买入操作**：
  - 同方向标的：1 分钟内只能买入一次（例如买入做多标的后，在一分钟内买入做多标的会拒绝买入）
  - 不同方向标的：不互相限制（例如买入做多标的后，在一分钟内买入做空标的不会触发频率检查）
- **卖出操作**：不受频率限制
- **检查顺序**：对于买入操作，交易频率检查是最先进行的检查，若不通过直接拒绝，不进行后续风险检查

### 7. 买入前价格检查

- **检查时机**：买入前
- **检查逻辑**：
  - 检查订单记录里该标的的最新买入订单的成交价
  - 若当前标的价格 > 最新订单的成交价，则拒绝买入
  - 若当前标的价格 ≤ 最新订单的成交价，则允许买入
- **注意**：做多标的和做空标的分开检查，互不影响

### 5. 末日保护程序

- **收盘前 15 分钟拒绝买入**：当末日保护程序启用时，收盘前 15 分钟内禁止所有买入操作（卖出操作不受影响）
  - 正常交易日：15:45-16:00 拒绝买入
  - 半日交易日：11:45-12:00 拒绝买入
- **收盘前 5 分钟自动清仓**：收盘前 5 分钟内自动清空所有持仓
  - 正常交易日：15:55-15:59 清仓
  - 半日交易日：11:55-11:59 清仓
- 配置参数：`DOOMSDAY_PROTECTION`（启用/禁用末日保护程序）

### 6. 单标的浮亏保护与保护性清仓

- **配置项**：`MAX_UNREALIZED_LOSS_PER_SYMBOL`（`TRADING_CONFIG.maxUnrealizedLossPerSymbol`）
  - 单位：HKD
  - 为 0 或未配置时，关闭单标的浮亏保护和保护性清仓逻辑
- **核心概念**：
  - R1（成本市值）：全部买入订单市值之和 − 全部卖出订单市值之和（允许为负）
  - N1（剩余数量）：全部买入数量之和 − 全部卖出数量之和
  - R2（当前持仓市值）：`R2 = 当前价格 × N1`
  - 浮亏：`浮亏 = R2 − R1`（浮亏为负数表示亏损）
- **初始化流程（程序启动时）**：
  1. 调用 `orderRecorder.fetchOrdersFromAPI(symbol)` 从 LongPort API 获取当日全部已成交买入/卖出订单，写入内部缓存（默认缓存有效期 5 分钟）
  2. 调用 `orderRecorder.refreshOrders(symbol, isLong, false)` 从缓存中计算当前仍需记录的买入订单列表（用于智能清仓）
  3. 调用 `riskChecker.refreshUnrealizedLossData(orderRecorder, symbol, isLong)` 从已过滤的订单列表计算并缓存 R1 与 N1
  - **注意**：`refreshUnrealizedLossData` 方法直接从 `orderRecorder._longBuyOrders/_shortBuyOrders` 读取已过滤的订单列表（这些订单已经通过 M0 + MN 过滤算法处理），而不是从全部买入/卖出订单计算
- **运行时更新（每次成交后）**：
  - 买入成交后：
    - `orderRecorder.recordLocalBuy()` 本地追加买入记录（不再调用 todayOrders）
    - `riskChecker.refreshUnrealizedLossData(orderRecorder, symbol, isLong)` 从已更新的订单列表重新计算 R1 和 N1
  - 卖出成交后：
    - `orderRecorder.recordLocalSell()` 本地按规则过滤/清空买入记录
    - `riskChecker.refreshUnrealizedLossData(orderRecorder, symbol, isLong)` 从已更新的订单列表重新计算 R1 和 N1
- **保护性清仓触发逻辑**：
  - 在 `index.js` 的主循环中，当监控到做多/做空标的价格变化时：
    - 调用 `riskChecker.checkUnrealizedLoss(symbol, currentPrice, isLong)`，使用缓存的 R1/N1 与最新价格计算浮亏
    - 如果 `浮亏 < -MAX_UNREALIZED_LOSS_PER_SYMBOL`：
      - 生成市价清仓信号（`useMarketOrder: true`，`SignalType.SELLCALL` 或 `SignalType.SELLPUT`）
      - 通过 `trader.executeSignals()` 立即市价清仓
      - 清仓完成后调用 `orderRecorder.refreshOrders(symbol, isLong, true)` 强制刷新订单记录（forceRefresh=true，从 API 获取最新状态）
      - 然后调用 `riskChecker.refreshUnrealizedLossData(orderRecorder, symbol, isLong)` 从刷新后的订单列表重新计算 R1/N1，确保后续监控基于最新成交状态
  - 当未启用浮亏保护（`MAX_UNREALIZED_LOSS_PER_SYMBOL <= 0`）时，上述流程自动跳过，不会触发保护性清仓

---

## 订单管理机制

### 1. 智能订单监控和修改

系统会自动监控所有未成交的买入订单，当检测到市场价格低于委托价格时，自动修改委托价格为当前市价，提高成交概率。

**监控规则：**

- 仅监控买入订单（卖出订单不监控，无需修改）
- 仅在发起买入交易后开始监控
- 当所有买入订单成交后自动停止监控
- 每秒检查一次价格变化
- 价格差异 ≥ 0.001 时才修改订单

**订单修改逻辑：**

- 当有发起买入的委托但还未成交的订单时，从实时监控里获取该标的的最新价
- 当最新价低于委托价时，将委托价格修改为当前最新价
- 如果是卖出的委托订单，则无需修改

### 2. 历史订单记录

系统会记录每日所有已成交的买入订单，用于智能清仓决策，并在程序运行期间通过本地增量更新保持同步。

**记录时机：**

- 程序启动时（从 API 获取当日订单并初始化缓存与记录）
- 每次买入做多标的后（本地追加记录）
- 每次买入做空标的后（本地追加记录）
- 每次卖出做多标的后（本地按规则过滤/清空）
- 每次卖出做空标的后（本地按规则过滤/清空）

**启动时记录逻辑（M0 + MN 过滤算法）：**

1. **获取订单**：

   - 调用 `orderRecorder.fetchOrdersFromAPI(symbol)` 获取当日全部买入/卖出已成交订单，并写入内部缓存（含 `fetchTime`，有效期默认 5 分钟）
   - 调用 `orderRecorder.refreshOrders(symbol, isLong, false)` 从缓存中读取订单并进行过滤
   - 做多标的和做空标的分开获取和记录

2. **计算 M0**：

   - 如果没有卖出订单，M0 = 所有买入订单
   - 如果有卖出订单，M0 = 成交时间 > 最新卖出订单时间的买入订单

3. **计算 MN**（从最旧的卖出订单开始，依次判断和过滤）：
   - 将卖出订单按成交时间从旧到新排序（D1, D2, D3，D1 是最旧的）
   - 初始候选列表：所有成交时间 ≤ 最新卖出订单时间的买入订单
   - 对于每个卖出订单（从最旧的开始）：
     - 获取成交时间 < 该卖出订单成交时间的买入订单
     - 如果该卖出订单的成交数量 ≥ 这些买入订单的总数量：
       - 视为这些买入订单全部被卖出，无需记录
       - 更新候选列表：保留成交时间 ≥ 当前卖出订单时间的买入订单
     - 否则：
       - 从这些买入订单中过滤出成交价 ≥ 该卖出订单成交价的买入订单
       - 获取成交时间 > 当前卖出订单时间 且 < 下一个卖出订单时间（如果存在）的买入订单
       - 将过滤出的买入订单 + 时间范围内的买入订单 = 新的候选列表
   - 最终订单列表 = M0 + MN（经过所有卖出订单过滤后的候选列表）

**运行时本地更新逻辑：**

- 买入后（已提交且信号通过所有风控）：
  - `recordLocalBuy(symbol, executedPrice, executedQuantity, isLong)` 直接在内存中追加一条买入记录，不再重新调用 todayOrders
- 卖出后：
  - `recordLocalSell(symbol, executedPrice, executedQuantity, isLong)` 按以下规则本地更新：
    - 若卖出数量 ≥ 当前记录的总数量：认为全部卖出，清空记录
    - 否则：仅保留成交价 ≥ 本次卖出价的买入订单

**清仓应用：**

- 当卖出信号触发但当前价格 ≤ 持仓成本价时：
  - 检查当前记录的买入订单列表（已按 M0 + MN 规则处理）
  - 找出买入价 < 当前价的订单
  - 获取这些订单的全部成交数量并以当前价卖出
- 实现“只卖盈利部分”的精细化清仓策略，同时利用缓存和本地增量更新避免重复调用 todayOrders

---

## 安装和配置

### 1. 系统要求

- Node.js 18+ (建议使用最新 LTS 版本)
- npm 或 yarn 包管理器
- LongPort 证券账户（实盘或模拟账户）
- LongPort OpenAPI 权限

### 2. 安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd longBrige-automation-program

# 安装依赖
npm install
```

### 3. 配置环境变量

复制 `.env.example` 为 `.env` 并填写配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件，配置以下必需参数：

```env
# LongPort OpenAPI 配置
LONGPORT_APP_KEY=your_app_key_here
LONGPORT_APP_SECRET=your_app_secret_here
LONGPORT_ACCESS_TOKEN=your_access_token_here

# 交易标的配置
MONITOR_SYMBOL=HSI.HK          # 监控标的（恒生指数）
LONG_SYMBOL=54806              # 做多标的（牛证）
SHORT_SYMBOL=63372             # 做空标的（熊证）

# 交易金额配置
TARGET_NOTIONAL=10000          # 每次目标买入金额（HKD）
LONG_LOT_SIZE=100              # 做多标的最小买卖单位
SHORT_LOT_SIZE=100             # 做空标的最小买卖单位

# 风险管理配置
MAX_POSITION_NOTIONAL=200000   # 单标的最大持仓市值（HKD）
MAX_DAILY_LOSS=20000           # 单日最大亏损（HKD）
DOOMSDAY_PROTECTION=true       # 末日保护程序（收盘前15分钟拒绝买入，收盘前5分钟清仓）

# 信号配置（必需）
SIGNAL_BUYCALL=(RSI6<20,MFI<15,D<20,J<-1)/3|(J<-20)                    # 买入做多信号配置
SIGNAL_SELLCALL=(RSI6>80,MFI>85,D>79,J>100)/3|(J>110)                  # 卖出做多信号配置
SIGNAL_BUYPUT=(RSI6>80,MFI>85,D>80,J>100)/3|(J>120)                    # 买入做空信号配置
SIGNAL_SELLPUT=(RSI6<20,MFI<15,D<22,J<0)/3|(J<-15)                     # 卖出做空信号配置

# 调试配置（可选）
DEBUG=false                    # 启用详细日志
```

### 4. 获取 LongPort API 凭证

1. 访问 [LongPort 开放平台](https://open.longbridge.com)
2. 注册/登录账号
3. 创建应用并获取：
   - `LONGPORT_APP_KEY`
   - `LONGPORT_APP_SECRET`
   - `LONGPORT_ACCESS_TOKEN`
4. 参考 [LongPort 快速开始文档](https://open.longbridge.com/zh-CN/docs/getting-started)

---

## 使用方法

### 启动程序

```bash
npm start
```

### 程序运行流程

1. **启动验证**

   - 验证所有配置项是否有效
   - 验证监控标的和交易标的是否可用
   - 获取并显示账户和持仓信息
   - 按需查询当日是否为交易日

2. **实时监控**（每秒执行一次）

   - 检查是否在交易时段（连续交易时段）
   - 获取监控标的的 K 线数据和实时行情
   - 计算技术指标（RSI、KDJ、MACD）
   - 生成交易信号（立即执行 + 延迟验证）
   - 对卖出信号进行成本价判断和卖出数量计算
   - 验证延迟信号（60 秒后，检查配置的验证指标，默认 D2 和 DIF2）
   - 买入操作风险检查（按顺序）：
     1. 交易频率限制（若不通过直接拒绝）
     2. 买入前价格检查（若当前标的价格 > 订单记录里最新订单的成交价则拒绝买入）
     3. 末日保护程序（收盘前 15 分钟拒绝买入）
     4. 牛熊证风险检查（距离回收价百分比）
     5. 基础风险检查（浮亏检查和持仓市值限制检查）
   - 执行交易订单
   - 监控未成交买入订单（价格优化）
   - 刷新订单记录（买入或卖出后）

3. **交易时段判断**

   - 上午连续交易时段：09:30 - 12:00
   - 下午连续交易时段：13:00 - 16:00
   - 非交易时段暂停监控
   - 自动识别交易日和半日交易日

4. **末日保护程序**（可选）
   - 收盘前 15 分钟拒绝买入：正常交易日 15:45-16:00，半日交易日 11:45-12:00
   - 收盘前 5 分钟自动清仓：正常交易日 15:55-15:59，半日交易日 11:55-11:59

### 日志和记录

- **控制台日志**：实时显示程序运行状态和交易决策
- **交易记录**：保存在 `logs/trades_YYYY-MM-DD.json`
- **日志级别**：
  - `INFO`：正常运行信息
  - `WARN`：警告信息（如风险拦截）
  - `ERROR`：错误信息（如订单失败）
  - `DEBUG`：详细调试信息（需开启 `DEBUG=true`）

### 停止程序

按 `Ctrl+C` 停止程序。

---

## 配置参数说明

### 必需配置

| 参数                    | 说明                                                      | 示例                                     |
| ----------------------- | --------------------------------------------------------- | ---------------------------------------- |
| `MONITOR_SYMBOL`        | 监控标的代码                                              | `HSI.HK`                                 |
| `LONG_SYMBOL`           | 做多标的代码                                              | `54806`                                  |
| `SHORT_SYMBOL`          | 做空标的代码                                              | `63372`                                  |
| `TARGET_NOTIONAL`       | 每次目标买入金额（HKD）                                   | `10000`                                  |
| `LONG_LOT_SIZE`         | 做多标的最小买卖单位                                      | `100`                                    |
| `SHORT_LOT_SIZE`        | 做空标的最小买卖单位                                      | `100`                                    |
| `MAX_POSITION_NOTIONAL` | 单标的最大持仓市值（HKD）                                 | `200000`                                 |
| `MAX_DAILY_LOSS`        | 单日最大亏损（HKD）                                       | `20000`                                  |
| `DOOMSDAY_PROTECTION`   | 末日保护程序（收盘前 15 分钟拒绝买入，收盘前 5 分钟清仓） | `true` 或 `false`                        |
| `SIGNAL_BUYCALL`        | 买入做多信号配置（格式见交易信号章节）                    | `(RSI6<20,MFI<15,D<20,J<-1)/3\|(J<-20)`  |
| `SIGNAL_SELLCALL`       | 卖出做多信号配置（格式见交易信号章节）                    | `(RSI6>80,MFI>85,D>79,J>100)/3\|(J>110)` |
| `SIGNAL_BUYPUT`         | 买入做空信号配置（格式见交易信号章节）                    | `(RSI6>80,MFI>85,D>80,J>100)/3\|(J>120)` |
| `SIGNAL_SELLPUT`        | 卖出做空信号配置（格式见交易信号章节）                    | `(RSI6<20,MFI<15,D<22,J<0)/3\|(J<-15)`   |

**信号配置格式说明**：

- 格式：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`
- 括号内是条件列表，逗号分隔
- `/N`：括号内条件需满足 N 项，不设则全部满足
- `|`：分隔不同条件组（最多 3 个），满足任一组即可
- 支持指标：`RSI6`, `RSI12`, `MFI`, `D` (KDJ.D), `J` (KDJ.J)
- 支持运算符：`<` 和 `>`
- 支持负数阈值

### 可选配置

| 参数                             | 说明                                                        | 默认值      |
| -------------------------------- | ----------------------------------------------------------- | ----------- |
| `DEBUG`                          | 启用详细日志                                                | `false`     |
| `MAX_UNREALIZED_LOSS_PER_SYMBOL` | 单标的浮亏保护阈值（HKD，0 表示关闭）                       | `0`（关闭） |
| `VERIFICATION_DELAY_SECONDS`     | 延迟验证时间间隔（秒，范围 0-120）                          | `60`        |
| `VERIFICATION_INDICATORS`        | 延迟验证指标列表（可选：K, D, J, MACD, DIF, DEA，逗号分隔） | `D,DIF`     |

---

## 技术指标计算详解

### RSI（相对强弱指标）

使用 `technicalindicators` 库的 RSI.calculate 方法，采用 Wilder's Smoothing（Wilder 平滑法）：

```
1. 计算价格变化（涨跌值）
2. 分离涨幅和跌幅
3. 使用平滑系数 1/period 计算平均涨幅和平均跌幅
4. 计算 RS = 平均涨幅 / 平均跌幅
5. 计算 RSI = 100 - 100 / (1 + RS)
```

### KDJ（随机指标）

使用 `technicalindicators` 库的 EMA 实现平滑系数 1/3：

```
1. 计算 RSV（未成熟随机值）：
   RSV = ((close - lowestLow) / (highestHigh - lowestLow)) * 100
2. 计算 K 值（使用 EMA(period=5) 平滑 RSV）：
   K = (2/3) * 前一个K值 + (1/3) * RSV
3. 计算 D 值（使用 EMA(period=5) 平滑 K）：
   D = (2/3) * 前一个D值 + (1/3) * K值
4. 计算 J 值：
   J = 3 * K - 2 * D
```

### MFI（资金流量指标）

使用 `technicalindicators` 库的 MFI.calculate 方法，周期为 14：

```
1. 计算典型价格（Typical Price）：TP = (high + low + close) / 3
2. 计算原始资金流量（Raw Money Flow）：RMF = TP × volume
3. 分离正负资金流量：
   - 如果今日 TP > 昨日 TP：正资金流量
   - 如果今日 TP < 昨日 TP：负资金流量
4. 计算资金流量比率（Money Flow Ratio）：MFR = 正资金流量总和 / 负资金流量总和
5. 计算 MFI：MFI = 100 - (100 / (1 + MFR))
```

MFI 值范围：0-100

- MFI > 85：通常认为超买
- MFI < 15：通常认为超卖
- MFI 结合了价格和成交量，比 RSI 更能反映资金流向

### MACD（指数平滑异同移动平均线）

使用 `technicalindicators` 库的 MACD.calculate 方法：

```
1. 计算快慢线（使用 EMA）：
   EMA12 = EMA(close, 12)
   EMA26 = EMA(close, 26)
2. 计算 DIF（快线）：
   DIF = EMA12 - EMA26
3. 计算 DEA（慢线，信号线）：
   DEA = EMA(DIF, 9)
4. 计算 MACD 柱：
   MACD = (DIF - DEA) × 2
```

---

## 常见问题

### 1. 程序启动失败，提示配置验证未通过

**原因**：环境变量配置缺失或无效。

**解决方法**：

- 检查 `.env` 文件是否存在
- 确认所有必需配置项都已填写
- 验证标的代码是否正确（可通过 LongPort 查询）
- 确认金额配置为正数

### 2. 提示"不在交易时段"

**原因**：当前时间不在港股连续交易时段。

**解决方法**：

- 港股连续交易时段：09:30-12:00, 13:00-16:00
- 检查系统时间是否正确
- 确认当天是交易日（非周末、节假日）

### 3. 订单提交失败，提示余额不足

**原因**：账户现金余额不足以支付订单金额。

**解决方法**：

- 减小 `TARGET_NOTIONAL` 参数
- 增加账户现金余额
- 检查是否有未成交的挂单占用资金

### 4. 订单提交失败，提示"不支持做空"

**原因**：该标的不支持做空交易或账户没有做空权限。

**解决方法**：

- 更换支持做空的标的（修改 `SHORT_SYMBOL`）
- 联系券商确认账户做空权限
- 检查标的是否为牛熊证（牛熊证是买入做空，非卖空）

### 5. 浮亏计算异常

**原因**：持仓成本价或持仓数量数据异常。

**解决方法**：

- 启用 `DEBUG=true` 查看详细日志
- 检查账户和持仓数据是否正常
- 重启程序重新获取数据

### 6. 延迟验证失败

**原因**：延迟时间后配置的验证指标值未按预期趋势变化。

**解决方法**：

- 这是正常的风控机制，表示趋势未确认
- 不需要处理，系统会自动放弃该信号
- 可以调整验证指标或延迟时间（通过环境变量配置）
- 可以调整策略阈值（需修改代码）

---

## 注意事项和风险提示

### ⚠️ 重要风险提示

1. **投资有风险**：本系统仅供学习和研究使用，不构成任何投资建议。
2. **策略风险**：技术指标策略不能保证盈利，可能导致亏损。
3. **市场风险**：市场行情瞬息万变，系统可能无法及时应对突发事件。
4. **系统风险**：网络延迟、API 故障等可能导致订单执行失败或延迟。
5. **牛熊证风险**：牛熊证有回收机制，距离回收价过近时可能被强制回收。

### 使用建议

1. **先使用模拟账户**：建议先在模拟账户中测试策略，熟悉系统后再使用实盘。
2. **合理设置参数**：根据自己的风险承受能力设置 `MAX_DAILY_LOSS` 和 `MAX_POSITION_NOTIONAL`。
3. **监控运行状态**：定期检查程序运行状态和交易记录。
4. **及时止损**：当市场出现重大变化时，及时手动干预。
5. **备份数据**：定期备份交易记录和日志文件。
6. **测试策略**：可以通过历史数据回测验证策略效果。

### 系统限制

1. **仅支持港股**：目前仅支持港股市场交易（`.HK` 后缀）
2. **单向持仓**：同一标的只能持有一个方向的仓位
3. **日内交易**：策略适合日内交易，不建议持仓过夜
4. **标的限制**：建议使用流动性好的牛熊证或 ETF

---

## 技术架构和扩展

### 核心依赖

- `longport`：LongPort OpenAPI Node.js SDK
- `technicalindicators`：技术指标计算库（RSI、KDJ、MACD）
- `dotenv`：环境变量管理

### 代码结构

```
longBrige-automation-program/
├── src/                        # 源代码目录
│   ├── index.js                # 主程序入口
│   ├── strategy.js             # 交易策略
│   ├── trader.js               # 交易执行
│   ├── indicators.js           # 技术指标
│   ├── risk.js                 # 风险控制
│   ├── orderRecorder.js        # 订单记录
│   ├── quoteClient.js          # 行情客户端
│   ├── logger.js               # 日志管理（异步队列批量处理）
│   ├── objectPool.js           # 对象池模块（内存优化）
│   ├── utils.js                # 工具函数
│   ├── signalTypes.js          # 信号类型
│   └── config/                 # 配置目录
│       ├── config.js           # API配置
│       ├── config.trading.js   # 交易配置
│       └── config.validator.js # 配置验证
├── logs/                       # 日志目录（自动生成）
│   └── trades_YYYY-MM-DD.json  # 每日交易记录
├── .env                        # 环境变量配置（需自行创建）
├── .env.example                # 环境变量配置示例
├── package.json                # 项目依赖
└── README.md                   # 项目文档
```

### 扩展开发

如需自定义策略或功能，可以参考以下模块：

1. **修改策略**：编辑 [src/strategy.js](src/strategy.js)
2. **添加指标**：编辑 [src/indicators.js](src/indicators.js)
3. **调整风控**：编辑 [src/risk.js](src/risk.js) 和 [src/config/config.trading.js](src/config/config.trading.js)
4. **自定义日志**：编辑 [src/logger.js](src/logger.js)

---

## 许可证

本项目仅供学习和研究使用，不得用于非法用途。使用本系统产生的一切后果由使用者自行承担。

---

## 联系和支持

- LongPort 官方文档：https://open.longbridge.com/zh-CN/docs
- LongPort OpenAPI SDK：https://github.com/longportapp/openapi-sdk
- Node.js SDK 文档：https://longportapp.github.io/openapi/nodejs/

---

## 更新日志

### v1.3.0 (最新版本)

- ✅ **信号配置化**：
  - 所有交易信号条件完全可配置，通过环境变量设置
  - 支持灵活的表达式格式：`(条件1,条件2,...)/N|(条件A)|(条件B,条件C)/M`
  - 支持多个条件组（最多 3 个），满足任一组即可触发
  - 支持条件组合：括号内条件可设置需满足的数量（/N）
  - 支持指标：RSI6, RSI12, MFI, D (KDJ.D), J (KDJ.J)
  - 支持运算符：< 和 >
  - 支持负数阈值
  - 配置验证：启动时自动验证配置格式，格式无效将导致启动失败
  - 环境变量：`SIGNAL_BUYCALL`, `SIGNAL_SELLCALL`, `SIGNAL_BUYPUT`, `SIGNAL_SELLPUT`

### v1.2.0

- ✅ **更新技术指标**：
  - 将 RSI12 替换为 MFI（资金流量指标，周期 14）
  - MFI 结合价格和成交量，比 RSI 更能反映资金流向
  - 买入信号：MFI < 15（超卖），卖出信号：MFI > 85（超买）
- ✅ **完善交易信号条件**：
  - 明确所有交易信号的触发条件（条件 1 或条件 2 满足其一即可）
  - 卖出信号生成时无需判断成本价，成本价判断在卖出策略中进行
  - 卖出做多标的：KDJ.D 阈值 > 79
  - 卖出做空标的：KDJ.D 阈值 < 22
- ✅ **完善验证阶段策略**：
  - 详细说明 60 秒延迟验证的具体流程
  - 明确验证指标的记录时机和获取方式（优先精确匹配，失败则获取 5 秒内最近值）
  - 验证条件支持配置多个指标（推荐使用 D 和 DIF）
  - 买入做多标的：所有配置指标的第二个值都要大于第一个值
  - 买入做空标的：所有配置指标的第二个值都要小于第一个值
- ✅ **完善订单记录逻辑**：
  - 明确记录时机：程序启动时、每次买入/卖出后
  - 详细说明 M0 + MN 过滤算法（从最旧的卖出订单开始依次处理）
  - 区分做多和做空标的，分开获取和记录
- ✅ **完善卖出策略**：
  - 明确触发条件（无需判断成本价）
  - 详细说明成本价判断逻辑和卖出数量计算
  - 卖出后自动刷新订单记录
- ✅ **完善风险管控**：
  - 明确最大持仓市值计算：若已有持仓应以成本价计算（优先使用成本价）
  - 完善牛熊证风险检查：程序启动时初始化，使用监控标的的当前价格计算距离回收价百分比
  - 买入操作检查顺序：交易频率 → 末日保护程序 → 牛熊证风险 → 基础风险检查
- ✅ **完善订单修改逻辑**：
  - 明确仅修改买入订单（卖出订单无需修改）
  - 使用实时监控的最新价进行修改

### v1.1.0

- ✅ **优化交易信号条件**：
  - 卖出做多标的：KDJ.D 阈值调整为 > 79（而非 > 80）
  - 卖出做空标的：KDJ.D 阈值调整为 < 22（而非 < 20）
  - 简化条件判断逻辑，移除"同时满足条件 1 和条件 2"的特殊处理
- ✅ **优化订单记录逻辑**：
  - 从最旧的卖出订单开始依次处理
  - 先获取 M0（成交时间 > 最新卖出订单时间的买入订单）
  - 按卖出订单的成交数量判断是否全部卖出
  - 更精确地过滤和记录历史买入订单
- ✅ **末日保护程序**：
  - 将"收盘前 5 分钟清仓"改名为"末日保护程序"
  - 收盘前 15 分钟拒绝买入（卖出操作不受影响）
  - 收盘前 5 分钟自动清空所有持仓

### v1.0.0

- ✅ 实现多指标组合策略（RSI、KDJ、MACD）
- ✅ 支持双向交易（做多/做空）
- ✅ 延迟验证机制（60 秒趋势确认）
- ✅ 智能风险控制（浮亏限制、持仓限制、牛熊证风险检查）
- ✅ 智能订单管理（价格优化、自动监控）
- ✅ 精细化清仓策略（基于持仓成本价和历史订单）
- ✅ 末日保护程序（收盘前 15 分钟拒绝买入，收盘前 5 分钟清仓）
- ✅ 完整的配置验证和错误处理
- ✅ 详细的日志和交易记录

---

## 免责声明

本软件按"现状"提供，不提供任何明示或暗示的保证。作者不对使用本软件造成的任何直接或间接损失负责。使用本软件进行交易的风险由使用者自行承担。在使用真实资金进行交易前，请务必充分了解市场风险和系统风险，并根据自己的风险承受能力谨慎决策。
