# LongBridge 港股自动化量化交易系统

## 项目简介

这是一个基于 LongPort OpenAPI 的港股自动化量化交易系统，专门用于监控港股市场（如恒生指数）并根据技术指标自动执行做多/做空交易策略。该系统采用多指标组合策略，实时监控市场变化，自动生成交易信号并执行订单。

### 主要特点

- ✅ **多指标组合策略**：结合 RSI、KDJ、VWAP、MACD 四种技术指标
- ✅ **双向交易支持**：支持做多和做空两个方向的标的交易
- ✅ **延迟验证机制**：开仓信号采用 60 秒延迟验证，确保趋势确认后再执行
- ✅ **智能风险控制**：单日最大亏损限制、单标的持仓市值限制、牛熊证距离回收价检查
- ✅ **智能订单管理**：自动监控未成交买入订单，当价格下跌时自动降低委托价格
- ✅ **精细化清仓策略**：基于持仓成本价和历史订单的智能清仓逻辑
- ✅ **收盘前自动清仓**：可配置在收盘前 5 分钟自动清空所有持仓
- ✅ **实时监控和日志**：每秒监控一次，详细记录所有交易操作和决策依据
- ✅ **完整的配置验证**：启动时自动验证所有配置项，避免运行时错误

---

## 系统架构

### 核心模块

```
src/
├── index.js                    # 主程序入口，包含交易主循环
├── strategy.js                 # 交易策略模块（多指标组合策略）
├── trader.js                   # 交易执行模块（订单提交、管理）
├── indicators.js               # 技术指标计算模块（RSI、KDJ、VWAP、MACD）
├── risk.js                     # 风险控制模块（浮亏检查、持仓限制）
├── orderRecorder.js            # 订单记录模块（历史订单管理）
├── quoteClient.js              # 行情客户端（获取行情、K线数据）
├── logger.js                   # 日志管理模块
├── utils.js                    # 工具函数模块
├── signalTypes.js              # 信号类型定义
└── config/
    ├── config.js               # LongPort API 配置
    ├── config.trading.js       # 交易配置（标的、金额、风控参数）
    └── config.validator.js     # 配置验证模块
```

### 数据流程

```
监控标的行情数据 → 计算技术指标 → 策略生成信号 → 风险检查 → 订单执行 → 订单监控
     ↓                ↓              ↓            ↓           ↓           ↓
  K线数据      RSI/KDJ/VWAP/MACD   立即/延迟    浮亏/持仓    做多/做空   价格优化
```

---

## 交易策略详解

### 策略概述

本系统采用**多指标组合策略**，基于恒生指数（或其他监控标的）的技术指标判断市场趋势，并对做多标的（牛证）和做空标的（熊证）执行双向交易。

### 技术指标

1. **RSI（相对强弱指标）**
   - RSI6：6 周期 RSI
   - RSI12：12 周期 RSI
   - 超买：> 80
   - 超卖：< 20

2. **KDJ（随机指标）**
   - K：快速随机指标
   - D：慢速随机指标
   - J：超买超卖指标（可超出 0-100 范围）
   - 超买：D > 80, J > 100
   - 超卖：D < 20, J < 0

3. **VWAP（成交量加权平均价）**
   - 用于判断价格相对位置
   - 价格 < VWAP：偏弱
   - 价格 > VWAP：偏强

4. **MACD（指数平滑异同移动平均线）**
   - DIF：快线（EMA12 - EMA26）
   - DEA：慢线（DIF 的 EMA9）
   - MACD 柱：(DIF - DEA) × 2
   - 用于延迟验证趋势

### 交易信号

#### 1. 买入做多标的（BUYCALL）- 延迟验证

**触发条件（满足条件1或条件2即可）：**

- **条件1**：四个指标中至少 3 个满足 且 监控标的价格 < VWAP
  - RSI6 < 20
  - RSI12 < 20
  - KDJ.D < 20
  - KDJ.J < -1
- **条件2**：KDJ.J < -20

**延迟验证（60秒后）：**
- J2 > J1（KDJ.J 值上升）
- MACD2 > MACD1（MACD 柱值上升）
- 验证通过后才执行买入

#### 2. 卖出做多标的（SELLCALL）- 立即执行

**触发条件（满足条件1或条件2即可）：**

- **条件1**：四个指标中至少 3 个满足 且 做多标的价格 > 持仓成本价
  - RSI6 > 80
  - RSI12 > 80
  - KDJ.D > 80
  - KDJ.J > 100
- **条件2**：KDJ.J > 110

**清仓逻辑：**
- 若当前价格 > 持仓成本价：清空所有持仓
- 若当前价格 ≤ 持仓成本价：只卖出买入价 < 当前价的历史订单

#### 3. 买入做空标的（BUYPUT）- 延迟验证

**触发条件（满足条件1或条件2即可）：**

- **条件1**：四个指标中至少 3 个满足 且 监控标的价格 > VWAP
  - RSI6 > 80
  - RSI12 > 80
  - KDJ.D > 80
  - KDJ.J > 100
- **条件2**：KDJ.J > 120

**延迟验证（60秒后）：**
- J2 < J1（KDJ.J 值下降）
- MACD2 < MACD1（MACD 柱值下降）
- 验证通过后才执行买入

#### 4. 卖出做空标的（SELLPUT）- 立即执行

**触发条件（满足条件1或条件2即可）：**

- **条件1**：四个指标中至少 3 个满足 且 做空标的价格 > 持仓成本价
  - RSI6 < 20
  - RSI12 < 20
  - KDJ.D < 20
  - KDJ.J < 0
- **条件2**：KDJ.J < -15

**清仓逻辑：**
- 若当前价格 > 持仓成本价：清空所有持仓
- 若当前价格 ≤ 持仓成本价：只卖出买入价 < 当前价的历史订单

---

## 风险控制机制

### 1. 单日最大亏损限制

- 实时计算浮亏：`浮亏 = 持仓市值 - 持仓成本`
- 当浮亏超过 `MAX_DAILY_LOSS` 时，禁止开新仓（仅限制买入，不限制卖出）
- 配置参数：`MAX_DAILY_LOSS`（单位：HKD）

### 2. 单标的最大持仓市值限制

- 每个标的的持仓市值不得超过 `MAX_POSITION_NOTIONAL`
- 持仓市值 = 持仓数量 × 当前市价
- 配置参数：`MAX_POSITION_NOTIONAL`（单位：HKD）

### 3. 牛熊证距离回收价检查

- 仅在买入牛熊证时检查
- 牛证：距离回收价百分比 < 0.5% 时停止买入
- 熊证：距离回收价百分比 > -0.5% 时停止买入
- 自动从 LongPort API 获取牛熊证信息

### 4. 交易频率限制

- 同方向标的：1 分钟内只能买入一次
- 不同方向标的：不互相限制（做多和做空独立计算）
- 卖出操作：不受频率限制

### 5. 收盘前自动清仓

- 可配置在收盘前 5 分钟自动清空所有持仓
- 正常交易日：15:55-15:59 清仓
- 半日交易日：11:55-11:59 清仓
- 配置参数：`CLEAR_POSITIONS_BEFORE_CLOSE`

---

## 订单管理机制

### 1. 智能订单监控

系统会自动监控所有未成交的买入订单，当检测到市场价格低于委托价格时，自动修改委托价格为当前市价，提高成交概率。

**监控规则：**
- 仅监控买入订单（卖出订单不监控）
- 仅在发起买入交易后开始监控
- 当所有买入订单成交后自动停止监控
- 每秒检查一次价格变化
- 价格差异 ≥ 0.001 时才修改订单

### 2. 历史订单记录

系统会记录每日所有已成交的买入订单，用于智能清仓决策。

**记录逻辑：**
1. 获取当日所有买入和卖出订单
2. 如果没有卖出订单，记录所有买入订单
3. 如果有卖出订单，过滤出：
   - M0：成交时间 > 最新卖出时间的买入订单
   - MN：依次过滤出成交时间 < 卖出时间 且 成交价 ≥ 卖出价的买入订单

**清仓应用：**
- 当清仓信号触发但当前价格未高于持仓成本价时
- 只卖出历史买入订单中买入价 < 当前价的订单数量
- 实现"只卖盈利部分"的精细化清仓策略

---

## 安装和配置

### 1. 系统要求

- Node.js 18+ (建议使用最新 LTS 版本)
- npm 或 yarn 包管理器
- LongPort 证券账户（实盘或模拟账户）
- LongPort OpenAPI 权限

### 2. 安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd LongBrigeAutomationProgram

# 安装依赖
npm install
```

### 3. 配置环境变量

复制 `.env.example` 为 `.env` 并填写配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件，配置以下必需参数：

```env
# LongPort OpenAPI 配置
LONGPORT_APP_KEY=your_app_key_here
LONGPORT_APP_SECRET=your_app_secret_here
LONGPORT_ACCESS_TOKEN=your_access_token_here

# 交易标的配置
MONITOR_SYMBOL=HSI.HK          # 监控标的（恒生指数）
LONG_SYMBOL=54806              # 做多标的（牛证）
SHORT_SYMBOL=63372             # 做空标的（熊证）

# 交易金额配置
TARGET_NOTIONAL=10000          # 每次目标买入金额（HKD）
LONG_LOT_SIZE=100              # 做多标的最小买卖单位
SHORT_LOT_SIZE=100             # 做空标的最小买卖单位

# 风险管理配置
MAX_POSITION_NOTIONAL=200000   # 单标的最大持仓市值（HKD）
MAX_DAILY_LOSS=20000           # 单日最大亏损（HKD）
CLEAR_POSITIONS_BEFORE_CLOSE=true  # 收盘前自动清仓

# 调试配置（可选）
DEBUG=false                    # 启用详细日志
```

### 4. 获取 LongPort API 凭证

1. 访问 [LongPort 开放平台](https://open.longbridge.com)
2. 注册/登录账号
3. 创建应用并获取：
   - `LONGPORT_APP_KEY`
   - `LONGPORT_APP_SECRET`
   - `LONGPORT_ACCESS_TOKEN`
4. 参考 [LongPort 快速开始文档](https://open.longbridge.com/zh-CN/docs/getting-started)

---

## 使用方法

### 启动程序

```bash
npm start
```

### 程序运行流程

1. **启动验证**
   - 验证所有配置项是否有效
   - 验证监控标的和交易标的是否可用
   - 获取并显示账户和持仓信息
   - 加载当月和下月的交易日信息

2. **实时监控**（每秒执行一次）
   - 检查是否在交易时段（连续交易时段）
   - 获取监控标的的 K 线数据
   - 计算技术指标（RSI、KDJ、VWAP、MACD）
   - 生成交易信号（立即执行 + 延迟验证）
   - 验证延迟信号（60 秒后）
   - 风险检查（浮亏、持仓市值、牛熊证风险）
   - 执行交易订单
   - 监控未成交买入订单

3. **交易时段判断**
   - 上午连续交易时段：09:30 - 12:00
   - 下午连续交易时段：13:00 - 16:00
   - 非交易时段暂停监控
   - 自动识别交易日和半日交易日

4. **收盘前清仓**（可选）
   - 正常交易日：15:55-15:59 自动清空所有持仓
   - 半日交易日：11:55-11:59 自动清空所有持仓

### 日志和记录

- **控制台日志**：实时显示程序运行状态和交易决策
- **交易记录**：保存在 `logs/trades_YYYY-MM-DD.json`
- **日志级别**：
  - `INFO`：正常运行信息
  - `WARN`：警告信息（如风险拦截）
  - `ERROR`：错误信息（如订单失败）
  - `DEBUG`：详细调试信息（需开启 `DEBUG=true`）

### 停止程序

按 `Ctrl+C` 停止程序。

---

## 配置参数说明

### 必需配置

| 参数 | 说明 | 示例 |
|------|------|------|
| `MONITOR_SYMBOL` | 监控标的代码 | `HSI.HK` |
| `LONG_SYMBOL` | 做多标的代码 | `54806` |
| `SHORT_SYMBOL` | 做空标的代码 | `63372` |
| `TARGET_NOTIONAL` | 每次目标买入金额（HKD） | `10000` |
| `LONG_LOT_SIZE` | 做多标的最小买卖单位 | `100` |
| `SHORT_LOT_SIZE` | 做空标的最小买卖单位 | `100` |
| `MAX_POSITION_NOTIONAL` | 单标的最大持仓市值（HKD） | `200000` |
| `MAX_DAILY_LOSS` | 单日最大亏损（HKD） | `20000` |
| `CLEAR_POSITIONS_BEFORE_CLOSE` | 收盘前自动清仓 | `true` 或 `false` |

### 可选配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `DEBUG` | 启用详细日志 | `false` |

---

## 技术指标计算详解

### RSI（相对强弱指标）

使用 EMA（指数移动平均）方式计算：

```
1. 计算价格变化：change[i] = close[i] - close[i-1]
2. 分离涨跌幅：gains = max(change, 0), losses = max(-change, 0)
3. 计算平均涨跌幅（EMA）：
   avgGain = currentGain * (1/period) + avgGain * (1 - 1/period)
   avgLoss = currentLoss * (1/period) + avgLoss * (1 - 1/period)
4. 计算 RSI：
   RS = avgGain / avgLoss
   RSI = 100 - 100 / (1 + RS)
```

### KDJ（随机指标）

```
1. 计算 RSV（未成熟随机值）：
   RSV = ((close - lowestLow) / (highestHigh - lowestLow)) * 100
2. 计算 K 值：
   K = (2/3) * 前一个K值 + (1/3) * RSV
3. 计算 D 值：
   D = (2/3) * 前一个D值 + (1/3) * K值
4. 计算 J 值：
   J = 3 * K - 2 * D
```

### VWAP（成交量加权平均价）

```
VWAP = Σ(价格 × 成交量) / Σ成交量
```

### MACD（指数平滑异同移动平均线）

```
1. 计算快慢线：
   EMA12 = EMA(close, 12)
   EMA26 = EMA(close, 26)
2. 计算 DIF（快线）：
   DIF = EMA12 - EMA26
3. 计算 DEA（慢线，信号线）：
   DEA = EMA(DIF, 9)
4. 计算 MACD 柱：
   MACD = (DIF - DEA) × 2
```

---

## 常见问题

### 1. 程序启动失败，提示配置验证未通过

**原因**：环境变量配置缺失或无效。

**解决方法**：
- 检查 `.env` 文件是否存在
- 确认所有必需配置项都已填写
- 验证标的代码是否正确（可通过 LongPort 查询）
- 确认金额配置为正数

### 2. 提示"不在交易时段"

**原因**：当前时间不在港股连续交易时段。

**解决方法**：
- 港股连续交易时段：09:30-12:00, 13:00-16:00
- 检查系统时间是否正确
- 确认当天是交易日（非周末、节假日）

### 3. 订单提交失败，提示余额不足

**原因**：账户现金余额不足以支付订单金额。

**解决方法**：
- 减小 `TARGET_NOTIONAL` 参数
- 增加账户现金余额
- 检查是否有未成交的挂单占用资金

### 4. 订单提交失败，提示"不支持做空"

**原因**：该标的不支持做空交易或账户没有做空权限。

**解决方法**：
- 更换支持做空的标的（修改 `SHORT_SYMBOL`）
- 联系券商确认账户做空权限
- 检查标的是否为牛熊证（牛熊证是买入做空，非卖空）

### 5. 浮亏计算异常

**原因**：持仓成本价或持仓数量数据异常。

**解决方法**：
- 启用 `DEBUG=true` 查看详细日志
- 检查账户和持仓数据是否正常
- 重启程序重新获取数据

### 6. 延迟验证失败

**原因**：60 秒后 KDJ.J 或 MACD 值未按预期趋势变化。

**解决方法**：
- 这是正常的风控机制，表示趋势未确认
- 不需要处理，系统会自动放弃该信号
- 可以调整策略阈值（需修改代码）

---

## 注意事项和风险提示

### ⚠️ 重要风险提示

1. **投资有风险**：本系统仅供学习和研究使用，不构成任何投资建议。
2. **策略风险**：技术指标策略不能保证盈利，可能导致亏损。
3. **市场风险**：市场行情瞬息万变，系统可能无法及时应对突发事件。
4. **系统风险**：网络延迟、API 故障等可能导致订单执行失败或延迟。
5. **牛熊证风险**：牛熊证有回收机制，距离回收价过近时可能被强制回收。

### 使用建议

1. **先使用模拟账户**：建议先在模拟账户中测试策略，熟悉系统后再使用实盘。
2. **合理设置参数**：根据自己的风险承受能力设置 `MAX_DAILY_LOSS` 和 `MAX_POSITION_NOTIONAL`。
3. **监控运行状态**：定期检查程序运行状态和交易记录。
4. **及时止损**：当市场出现重大变化时，及时手动干预。
5. **备份数据**：定期备份交易记录和日志文件。
6. **测试策略**：可以通过历史数据回测验证策略效果。

### 系统限制

1. **仅支持港股**：目前仅支持港股市场交易（`.HK` 后缀）
2. **单向持仓**：同一标的只能持有一个方向的仓位
3. **日内交易**：策略适合日内交易，不建议持仓过夜
4. **标的限制**：建议使用流动性好的牛熊证或ETF

---

## 技术架构和扩展

### 核心依赖

- `longport`：LongPort OpenAPI Node.js SDK
- `dotenv`：环境变量管理

### 代码结构

```
LongBrigeAutomationProgram/
├── src/                        # 源代码目录
│   ├── index.js                # 主程序入口
│   ├── strategy.js             # 交易策略
│   ├── trader.js               # 交易执行
│   ├── indicators.js           # 技术指标
│   ├── risk.js                 # 风险控制
│   ├── orderRecorder.js        # 订单记录
│   ├── quoteClient.js          # 行情客户端
│   ├── logger.js               # 日志管理
│   ├── utils.js                # 工具函数
│   ├── signalTypes.js          # 信号类型
│   └── config/                 # 配置目录
│       ├── config.js           # API配置
│       ├── config.trading.js   # 交易配置
│       └── config.validator.js # 配置验证
├── logs/                       # 日志目录（自动生成）
│   └── trades_YYYY-MM-DD.json  # 每日交易记录
├── .env                        # 环境变量配置（需自行创建）
├── .env.example                # 环境变量配置示例
├── package.json                # 项目依赖
└── README.md                   # 项目文档
```

### 扩展开发

如需自定义策略或功能，可以参考以下模块：

1. **修改策略**：编辑 [src/strategy.js](src/strategy.js)
2. **添加指标**：编辑 [src/indicators.js](src/indicators.js)
3. **调整风控**：编辑 [src/risk.js](src/risk.js) 和 [src/config/config.trading.js](src/config/config.trading.js)
4. **自定义日志**：编辑 [src/logger.js](src/logger.js)

---

## 许可证

本项目仅供学习和研究使用，不得用于非法用途。使用本系统产生的一切后果由使用者自行承担。

---

## 联系和支持

- LongPort 官方文档：https://open.longbridge.com/zh-CN/docs
- LongPort OpenAPI SDK：https://github.com/longportapp/openapi-sdk
- Node.js SDK 文档：https://longportapp.github.io/openapi/nodejs/

---

## 更新日志

### v1.0.0 (当前版本)

- ✅ 实现多指标组合策略（RSI、KDJ、VWAP、MACD）
- ✅ 支持双向交易（做多/做空）
- ✅ 延迟验证机制（60秒趋势确认）
- ✅ 智能风险控制（浮亏限制、持仓限制、牛熊证风险检查）
- ✅ 智能订单管理（价格优化、自动监控）
- ✅ 精细化清仓策略（基于持仓成本价和历史订单）
- ✅ 收盘前自动清仓
- ✅ 完整的配置验证和错误处理
- ✅ 详细的日志和交易记录

---

## 免责声明

本软件按"现状"提供，不提供任何明示或暗示的保证。作者不对使用本软件造成的任何直接或间接损失负责。使用本软件进行交易的风险由使用者自行承担。在使用真实资金进行交易前，请务必充分了解市场风险和系统风险，并根据自己的风险承受能力谨慎决策。
